<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="弹幕视频网站笔记 Maven 多模块项目的 POM 文件配置详解 这个文件是一个 Maven 的 POM (Project Object Model) 文件，它是 Maven 项目的核心配置文件，用于定义项目的结构、依赖关系、构建配置等信息。下面是对这个文件中各个部分的详细解释：\n">
<title>MyFirstBlog</title>

<link rel='canonical' href='http://localhost:1313/p/myfirstblog/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="MyFirstBlog">
<meta property='og:description' content="弹幕视频网站笔记 Maven 多模块项目的 POM 文件配置详解 这个文件是一个 Maven 的 POM (Project Object Model) 文件，它是 Maven 项目的核心配置文件，用于定义项目的结构、依赖关系、构建配置等信息。下面是对这个文件中各个部分的详细解释：\n">
<meta property='og:url' content='http://localhost:1313/p/myfirstblog/'>
<meta property='og:site_name' content='P'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-11-15T17:19:37&#43;08:00'/><meta property='article:modified_time' content='2024-11-15T17:19:37&#43;08:00'/>
<meta name="twitter:title" content="MyFirstBlog">
<meta name="twitter:description" content="弹幕视频网站笔记 Maven 多模块项目的 POM 文件配置详解 这个文件是一个 Maven 的 POM (Project Object Model) 文件，它是 Maven 项目的核心配置文件，用于定义项目的结构、依赖关系、构建配置等信息。下面是对这个文件中各个部分的详细解释：\n">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_321bcca034d8ea60.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🤡</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">P</a></h1>
            <h2 class="site-description">保安再就业.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/Pupil770'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#maven-多模块项目的-pom-文件配置详解">Maven 多模块项目的 POM 文件配置详解</a>
      <ol>
        <li><a href="#1基本配置">1.基本配置</a></li>
        <li><a href="#2-父项目继承">2. 父项目继承</a></li>
        <li><a href="#3-模块定义">3. 模块定义</a></li>
        <li><a href="#4-全局属性">4. 全局属性</a></li>
        <li><a href="#5-依赖管理">5. 依赖管理</a></li>
        <li><a href="#6-关键依赖说明">6. 关键依赖说明</a></li>
        <li><a href="#7-文件的作用">7. 文件的作用</a>
          <ol>
            <li><a href="#补充说明">补充说明</a></li>
            <li><a href="#1-commons-ioapache-commons-io">1. commons-io（Apache Commons IO）</a></li>
            <li><a href="#2-commons-codecapache-commons-codec">2. commons-codec（Apache Commons Codec）</a></li>
            <li><a href="#3-commons-lang3apache-commons-lang3">3. commons-lang3（Apache Commons Lang3）</a></li>
            <li><a href="#4-aspectjweaveraspectj-库">4. aspectjweaver（AspectJ 库）</a></li>
            <li><a href="#为什么需要这些库">为什么需要这些库？</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#applicationyml-文件作用与常见配置项详解">application.yml 文件作用与常见配置项详解</a>
      <ol>
        <li><a href="#1-服务器配置server">1. 服务器配置（server）</a></li>
        <li><a href="#2-文件上传配置springservletmultipart">2. 文件上传配置（spring.servlet.multipart）</a></li>
        <li><a href="#3-应用名称springapplicationname">3. 应用名称（spring.application.name）</a></li>
        <li><a href="#4-数据库配置springdatasource">4. 数据库配置（spring.datasource）</a></li>
        <li><a href="#5-redis-配置springredis">5. Redis 配置（spring.redis）</a></li>
        <li><a href="#6-mybatis-配置mybatis">6. MyBatis 配置（mybatis）</a></li>
        <li><a href="#7-自定义配置projectlogadmin">7. 自定义配置（project、log、admin）</a></li>
        <li><a href="#总结">总结</a></li>
      </ol>
    </li>
    <li><a href="#hikaricp-介绍">HikariCP 介绍</a>
      <ol>
        <li><a href="#1-为什么选择-hikaricp">1. 为什么选择 HikariCP？</a></li>
        <li><a href="#2-hikaricp-核心配置参数">2. HikariCP 核心配置参数</a>
          <ol>
            <li><a href="#关键参数说明">关键参数说明</a></li>
          </ol>
        </li>
        <li><a href="#3-hikaricp-的优势">3. HikariCP 的优势</a></li>
        <li><a href="#4-常见问题">4. 常见问题</a></li>
        <li><a href="#5-总结">5. 总结</a></li>
      </ol>
    </li>
    <li><a href="#jdbc-连接池connection-pool详解">JDBC 连接池（Connection Pool）详解</a>
      <ol>
        <li><a href="#1-为什么需要连接池">1. 为什么需要连接池？</a></li>
        <li><a href="#2-连接池的核心工作原理">2. 连接池的核心工作原理</a></li>
        <li><a href="#3-常见-jdbc-连接池对比">3. 常见 JDBC 连接池对比</a></li>
        <li><a href="#4-代码示例spring-boot--hikaricp">4. 代码示例（Spring Boot + HikariCP）</a></li>
        <li><a href="#5-总结-1">5. 总结</a></li>
      </ol>
    </li>
    <li><a href="#springboot-启动类easylivewebrunapplication-详解">SpringBoot 启动类——EasyLiveWebRunApplication 详解</a>
      <ol>
        <li><a href="#1-springbootapplication">1. @SpringBootApplication</a></li>
        <li><a href="#2-mapperscan">2. @MapperScan</a></li>
        <li><a href="#3-enabletransactionmanagement">3. @EnableTransactionManagement</a></li>
        <li><a href="#4-enablescheduling">4. @EnableScheduling</a></li>
        <li><a href="#5-main-方法">5. main 方法</a></li>
        <li><a href="#6-排除自动配置未使用但需注意">6. 排除自动配置（未使用但需注意）</a></li>
        <li><a href="#总结核心功能">总结：核心功能</a>
          <ol>
            <li><a href="#补充说明-1">补充说明</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#httpservletrequesthttpservletresponsehttpsession-介绍">HttpServletRequest、HttpServletResponse、HttpSession 介绍</a>
      <ol>
        <li><a href="#1-httpservletrequest请求对象">1. HttpServletRequest（请求对象）</a></li>
        <li><a href="#2-httpservletresponse响应对象">2. HttpServletResponse（响应对象）</a></li>
        <li><a href="#3-httpsession会话对象">3. HttpSession（会话对象）</a></li>
        <li><a href="#4-三者的关系">4. 三者的关系</a></li>
        <li><a href="#5-在-spring-mvc-中的简化用法">5. 在 Spring MVC 中的简化用法</a></li>
        <li><a href="#6-总结">6. 总结</a></li>
      </ol>
    </li>
    <li><a href="#获取-httpservletrequest-对象的两种方式">获取 HttpServletRequest 对象的两种方式</a>
      <ol>
        <li><a href="#1-通过方法参数直接注入spring-mvc-推荐">1. 通过方法参数直接注入（Spring MVC 推荐）</a></li>
        <li><a href="#2-通过-requestcontextholder-工具类获取">2. 通过 RequestContextHolder 工具类获取</a></li>
      </ol>
    </li>
    <li><a href="#tokenuserinfodto-中-jsonignoreproperties-和-serializable-的作用">TokenUserInfoDto 中 @JsonIgnoreProperties 和 Serializable 的作用</a>
      <ol>
        <li><a href="#1-jsonignorepropertiesignoreunknown--true">1. @JsonIgnoreProperties(ignoreUnknown = true)</a></li>
        <li><a href="#2-implements-serializable">2. implements Serializable</a></li>
        <li><a href="#3-其他代码说明">3. 其他代码说明</a></li>
        <li><a href="#总结-1">总结</a></li>
      </ol>
    </li>
    <li><a href="#服务端操作-cookie-的完整流程结合案例解析">服务端操作 Cookie 的完整流程（结合案例解析）</a>
      <ol>
        <li><a href="#1-代码逐行解析">1. 代码逐行解析</a></li>
        <li><a href="#2-关键操作说明">2. 关键操作说明</a></li>
        <li><a href="#3-完整案例场景">3. 完整案例场景</a></li>
        <li><a href="#4-浏览器与服务器的交互流程">4. 浏览器与服务器的交互流程</a></li>
        <li><a href="#5-关键注意事项">5. 关键注意事项</a></li>
        <li><a href="#6-总结-1">6. 总结</a></li>
      </ol>
    </li>
    <li><a href="#appinterceptor-和-webappconfigurer-基于-token-的请求拦截验证机制">AppInterceptor 和 WebAppConfigurer 基于 Token 的请求拦截验证机制</a>
      <ol>
        <li><a href="#1-appinterceptor核心拦截器类">1. AppInterceptor（核心拦截器类）</a></li>
        <li><a href="#2-webappconfigurer拦截器配置类">2. WebAppConfigurer（拦截器配置类）</a></li>
        <li><a href="#3-协作流程">3. 协作流程</a></li>
        <li><a href="#4-设计亮点">4. 设计亮点</a></li>
        <li><a href="#5-典型应用场景">5. 典型应用场景</a></li>
        <li><a href="#总结-2">总结</a></li>
      </ol>
    </li>
    <li><a href="#为什么文件请求和其他请求分开处理-token-的获取方式">为什么文件请求和其他请求分开处理 Token 的获取方式？</a>
      <ol>
        <li><a href="#1-技术限制浏览器对文件请求的-header-处理">1. 技术限制：浏览器对文件请求的 Header 处理</a></li>
        <li><a href="#2-实际应用场景示例">2. 实际应用场景示例</a></li>
      </ol>
    </li>
    <li><a href="#savecategory-方法中的-if-判断对应增加和修改详解">saveCategory 方法中的 if 判断（对应增加和修改）详解</a>
      <ol>
        <li><a href="#1-判断条件分解">1. 判断条件分解</a></li>
        <li><a href="#2-场景1新增分类时的检查">2. 场景1：新增分类时的检查</a></li>
        <li><a href="#3-场景2修改分类时的检查">3. 场景2：修改分类时的检查</a></li>
        <li><a href="#4-为什么需要两个场景分开判断">4. 为什么需要两个场景分开判断？</a></li>
        <li><a href="#5-逻辑优化建议">5. 逻辑优化建议</a></li>
        <li><a href="#6-总结-2">6. 总结</a></li>
      </ol>
    </li>
    <li><a href="#filetransfertonew-filefilepath-代码解析">file.transferTo(new File(filePath)) 代码解析</a>
      <ol>
        <li><a href="#详细执行流程">详细执行流程</a></li>
        <li><a href="#关键注意事项">关键注意事项</a></li>
        <li><a href="#示例完整安全版代码">示例：完整安全版代码</a></li>
        <li><a href="#常见问题解答">常见问题解答</a></li>
      </ol>
    </li>
    <li><a href="#分片上传视频文件-uploadvideo-方法详解">分片上传视频文件 uploadVideo 方法详解</a>
      <ol>
        <li><a href="#1-方法签名">1. 方法签名</a></li>
        <li><a href="#2-用户身份验证">2. 用户身份验证</a></li>
        <li><a href="#3-检查上传任务是否存在">3. 检查上传任务是否存在</a></li>
        <li><a href="#4-检查文件大小限制">4. 检查文件大小限制</a></li>
        <li><a href="#5-检查分片序号合法性">5. 检查分片序号合法性</a></li>
        <li><a href="#6-保存分片文件">6. 保存分片文件</a></li>
        <li><a href="#7-更新上传进度">7. 更新上传进度</a></li>
        <li><a href="#8-返回成功响应">8. 返回成功响应</a></li>
        <li><a href="#完整流程总结">完整流程总结</a></li>
        <li><a href="#优化建议">优化建议</a></li>
      </ol>
    </li>
    <li><a href="#savevideoinfo-方法详细解析">saveVideoInfo 方法详细解析</a>
      <ol>
        <li><a href="#1-方法概述">1. 方法概述</a></li>
        <li><a href="#2-分p数校验">2. 分P数校验</a></li>
        <li><a href="#3-视频id存在性校验">3. 视频ID存在性校验</a></li>
        <li><a href="#4-初始化变量">4. 初始化变量</a></li>
        <li><a href="#5-新增视频逻辑">5. 新增视频逻辑</a></li>
        <li><a href="#6-更新视频逻辑">6. 更新视频逻辑</a></li>
        <li><a href="#7-处理待删除文件">7. 处理待删除文件</a></li>
        <li><a href="#8-处理文件索引和新增文件">8. 处理文件索引和新增文件</a></li>
        <li><a href="#9-处理新增文件传输">9. 处理新增文件传输</a></li>
        <li><a href="#方法总结">方法总结</a></li>
      </ol>
    </li>
    <li><a href="#savevideoinfo-方法中-stream-的详细用法解析">saveVideoInfo 方法中 stream() 的详细用法解析</a>
      <ol>
        <li><a href="#1-将上传文件列表转为-map">1. 将上传文件列表转为 Map</a></li>
        <li><a href="#2-筛选新增文件">2. 筛选新增文件</a></li>
        <li><a href="#3-提取待删除文件的-id-列表">3. 提取待删除文件的 ID 列表</a></li>
        <li><a href="#4-提取待删除文件的路径列表">4. 提取待删除文件的路径列表</a></li>
        <li><a href="#stream-api-核心概念总结">Stream API 核心概念总结</a></li>
        <li><a href="#为什么使用-stream-api">为什么使用 Stream API？</a></li>
        <li><a href="#性能考虑">性能考虑</a></li>
        <li><a href="#完整流程示例">完整流程示例</a></li>
      </ol>
    </li>
    <li><a href="#mybatis-批量插入或更新语句-insertorupdatebatch-解析">MyBatis 批量插入或更新语句 insertOrUpdateBatch 解析</a>
      <ol>
        <li><a href="#1-基本结构">1. 基本结构</a></li>
        <li><a href="#2-插入部分详解">2. 插入部分详解</a></li>
        <li><a href="#3-冲突更新部分详解">3. 冲突更新部分详解</a></li>
        <li><a href="#4-完整逻辑流程">4. 完整逻辑流程</a></li>
        <li><a href="#5-实际执行示例">5. 实际执行示例</a></li>
        <li><a href="#6-设计考虑">6. 设计考虑</a></li>
        <li><a href="#7-使用场景">7. 使用场景</a></li>
        <li><a href="#8-注意事项">8. 注意事项</a></li>
      </ol>
    </li>
    <li><a href="#transfervideofile-方法详细解析">transferVideoFile 方法详细解析</a>
      <ol>
        <li><a href="#方法概述">方法概述</a></li>
        <li><a href="#1-初始化与准备">1. 初始化与准备</a></li>
        <li><a href="#2-文件转移与处理">2. 文件转移与处理</a></li>
        <li><a href="#3-获取视频信息">3. 获取视频信息</a></li>
        <li><a href="#4-异常处理">4. 异常处理</a></li>
        <li><a href="#5-状态更新与检查">5. 状态更新与检查</a></li>
        <li><a href="#状态枚举说明">状态枚举说明</a></li>
        <li><a href="#方法流程图">方法流程图</a></li>
        <li><a href="#关键点总结">关键点总结</a></li>
        <li><a href="#优化点">优化点</a></li>
      </ol>
    </li>
    <li><a href="#convertvideo2ts-和-union-方法详细解析">convertVideo2Ts 和 union 方法详细解析</a>
      <ol>
        <li><a href="#1-convertvideo2ts-方法解析">1. convertVideo2Ts 方法解析</a></li>
        <li><a href="#2-union-方法解析">2. union 方法解析</a></li>
        <li><a href="#3-两个方法的协作关系">3. 两个方法的协作关系</a></li>
        <li><a href="#4-设计考虑">4. 设计考虑</a></li>
        <li><a href="#5-典型使用场景">5. 典型使用场景</a></li>
        <li><a href="#6-潜在优化点">6. 潜在优化点</a></li>
      </ol>
    </li>
    <li><a href="#auditvideo-方法详细解析">auditVideo 方法详细解析</a>
      <ol>
        <li><a href="#1-方法概述-1">1. 方法概述</a></li>
        <li><a href="#2-方法流程详解">2. 方法流程详解</a>
          <ol>
            <li><a href="#21-状态验证">2.1 状态验证</a></li>
            <li><a href="#22-更新视频状态带条件">2.2 更新视频状态（带条件）</a></li>
            <li><a href="#23-更新关联文件状态">2.3 更新关联文件状态</a></li>
            <li><a href="#24-处理审核不通过情况">2.4 处理审核不通过情况</a></li>
            <li><a href="#25-首次发布奖励积分">2.5 首次发布奖励积分</a></li>
            <li><a href="#26-同步数据到正式表">2.6 同步数据到正式表</a></li>
            <li><a href="#27-清理待删除文件">2.7 清理待删除文件</a></li>
            <li><a href="#28-同步到搜索引擎">2.8 同步到搜索引擎</a></li>
          </ol>
        </li>
        <li><a href="#3-状态机设计">3. 状态机设计</a></li>
        <li><a href="#4-数据表设计分析">4. 数据表设计分析</a></li>
        <li><a href="#5-异常处理设计">5. 异常处理设计</a></li>
        <li><a href="#6-潜在优化建议">6. 潜在优化建议</a></li>
        <li><a href="#7-总结">7. 总结</a></li>
      </ol>
    </li>
    <li><a href="#mysql中left-join与inner-join的使用场景">MySQL中LEFT JOIN与INNER JOIN的使用场景</a>
      <ol>
        <li><a href="#核心区别">核心区别</a></li>
        <li><a href="#inner-join内连接使用场景">INNER JOIN（内连接）使用场景</a>
          <ol>
            <li><a href="#1-需要严格匹配关系的查询">1. 需要严格匹配关系的查询</a></li>
            <li><a href="#2-多表关联且需要所有表都有匹配">2. 多表关联且需要所有表都有匹配</a></li>
            <li><a href="#3-性能优先的查询">3. 性能优先的查询</a></li>
          </ol>
        </li>
        <li><a href="#left-join左连接使用场景">LEFT JOIN（左连接）使用场景</a>
          <ol>
            <li><a href="#1-需要包含左表所有记录的查询">1. 需要包含左表所有记录的查询</a></li>
            <li><a href="#2-检测缺失数据的查询">2. 检测缺失数据的查询</a></li>
            <li><a href="#3-分级数据查询">3. 分级数据查询</a></li>
          </ol>
        </li>
        <li><a href="#选择依据">选择依据</a></li>
        <li><a href="#性能优化建议">性能优化建议</a></li>
        <li><a href="#实际案例对比">实际案例对比</a></li>
        <li><a href="#总结-3">总结</a></li>
      </ol>
    </li>
    <li><a href="#跨系统事务处理策略">跨系统事务处理策略</a>
      <ol>
        <li><a href="#执行顺序建议先本地后远程">执行顺序建议：先本地后远程</a></li>
        <li><a href="#超时处理方案">超时处理方案</a>
          <ol>
            <li><a href="#1-本地事务异步通知推荐">1. 本地事务+异步通知（推荐）</a></li>
            <li><a href="#2-两阶段提交模式">2. 两阶段提交模式</a></li>
          </ol>
        </li>
        <li><a href="#超时具体处理策略">超时具体处理策略</a>
          <ol>
            <li><a href="#1-短超时快速失败">1. 短超时+快速失败</a></li>
            <li><a href="#2-重试机制">2. 重试机制</a></li>
            <li><a href="#3-补偿事务">3. 补偿事务</a></li>
          </ol>
        </li>
        <li><a href="#架构设计建议">架构设计建议</a>
          <ol>
            <li><a href="#最终一致性模式">最终一致性模式</a></li>
            <li><a href="#服务降级方案">服务降级方案</a></li>
            <li><a href="#监控指标">监控指标</a></li>
          </ol>
        </li>
        <li><a href="#决策流程图">决策流程图</a></li>
        <li><a href="#总结建议">总结建议</a></li>
      </ol>
    </li>
    <li><a href="#关于spring事务内部调用的问题">关于Spring事务内部调用的问题</a>
      <ol>
        <li>
          <ol>
            <li><a href="#1-方法内部调用最常见">1. 方法内部调用（最常见）</a></li>
            <li><a href="#2-事务方法不是public">2. 事务方法不是public</a></li>
            <li><a href="#3-异常被捕获未抛出">3. 异常被捕获未抛出</a></li>
            <li><a href="#4-异常类型不匹配">4. 异常类型不匹配</a></li>
            <li><a href="#5-多线程调用">5. 多线程调用</a></li>
            <li><a href="#6-数据库引擎不支持事务">6. 数据库引擎不支持事务</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#视频在线人数统计系统实现详解">视频在线人数统计系统实现详解</a>
      <ol>
        <li><a href="#1-系统架构概述">1. 系统架构概述</a></li>
        <li><a href="#2-核心实现细节">2. 核心实现细节</a>
          <ol>
            <li><a href="#21-数据结构设计">2.1 数据结构设计</a></li>
            <li><a href="#22-心跳上报流程">2.2 心跳上报流程</a></li>
            <li><a href="#23-过期监听机制">2.3 过期监听机制</a></li>
            <li><a href="#24-计数递减逻辑">2.4 计数递减逻辑</a></li>
          </ol>
        </li>
        <li><a href="#3-关键设计原理">3. 关键设计原理</a></li>
        <li><a href="#4-系统优势">4. 系统优势</a></li>
        <li><a href="#5-潜在优化方向">5. 潜在优化方向</a></li>
      </ol>
    </li>
    <li><a href="#websocket及其在在线人数统计中的应用">WebSocket及其在在线人数统计中的应用</a>
      <ol>
        <li><a href="#1-websocket-基础介绍">1. WebSocket 基础介绍</a></li>
        <li><a href="#2-基于-websocket-的在线人数统计实现">2. 基于 WebSocket 的在线人数统计实现</a>
          <ol>
            <li><a href="#21-服务端实现spring-boot">2.1 服务端实现（Spring Boot）</a></li>
            <li><a href="#22-客户端实现javascript">2.2 客户端实现（JavaScript）</a></li>
            <li><a href="#23-心跳机制">2.3 心跳机制</a></li>
          </ol>
        </li>
        <li><a href="#3-方案优势分析">3. 方案优势分析</a></li>
        <li><a href="#4-适用场景建议">4. 适用场景建议</a></li>
      </ol>
    </li>
    <li><a href="#netty与视频在线人数统计的结合">Netty与视频在线人数统计的结合</a>
      <ol>
        <li><a href="#1-netty基础介绍">1. Netty基础介绍</a></li>
        <li><a href="#2-为什么用netty实现在线人数统计">2. 为什么用Netty实现在线人数统计？</a></li>
        <li><a href="#3-基于netty的在线人数统计设计">3. 基于Netty的在线人数统计设计</a>
          <ol>
            <li><a href="#31-系统架构">3.1 系统架构</a></li>
            <li><a href="#32-核心组件实现">3.2 核心组件实现</a></li>
          </ol>
        </li>
        <li><a href="#4-与传统方案的对比">4. 与传统方案的对比</a></li>
        <li><a href="#5-适用场景建议">5. 适用场景建议</a></li>
      </ol>
    </li>
    <li><a href="#netty与websocket的关系及在实时统计中的应用">Netty与WebSocket的关系及在实时统计中的应用</a>
      <ol>
        <li><a href="#1-netty与websocket的基础关系">1. Netty与WebSocket的基础关系</a></li>
        <li><a href="#2-技术栈组合原理">2. 技术栈组合原理</a></li>
        <li><a href="#3-在视频在线统计中的联合实现">3. 在视频在线统计中的联合实现</a></li>
        <li><a href="#4-典型消息流程">4. 典型消息流程</a></li>
        <li><a href="#5-优化点">5. 优化点</a></li>
      </ol>
    </li>
    <li><a href="#视频删除方法详解">视频删除方法详解</a>
      <ol>
        <li><a href="#1-方法整体功能">1. 方法整体功能</a></li>
        <li><a href="#2-异步线程池部分详解">2. 异步线程池部分详解</a>
          <ol>
            <li><a href="#21-线程池初始化">2.1 线程池初始化</a></li>
            <li><a href="#22-异步任务执行逻辑">2.2 异步任务执行逻辑</a></li>
            <li><a href="#23-异步任务具体操作">2.3 异步任务具体操作</a></li>
          </ol>
        </li>
        <li><a href="#3-异步设计优缺点分析">3. 异步设计优缺点分析</a></li>
        <li><a href="#4-改进建议">4. 改进建议</a></li>
        <li><a href="#5-总结-2">5. 总结</a></li>
      </ol>
    </li>
    <li><a href="#异步线程池及-executorserviceexecute-详解">异步线程池及 executorService.execute 详解</a>
      <ol>
        <li><a href="#一异步线程池基础">一、异步线程池基础</a>
          <ol>
            <li><a href="#1-线程池核心概念">1. 线程池核心概念</a></li>
            <li><a href="#2-线程池关键参数">2. 线程池关键参数</a></li>
            <li><a href="#3-线程池工作流程">3. 线程池工作流程</a></li>
          </ol>
        </li>
        <li><a href="#二executorserviceexecute-方法详解">二、executorService.execute 方法详解</a>
          <ol>
            <li><a href="#1-方法签名-1">1. 方法签名</a></li>
            <li><a href="#2-核心特点">2. 核心特点</a></li>
            <li><a href="#3-执行流程与示例">3. 执行流程与示例</a></li>
            <li><a href="#4-execute-与-submit-区别">4. execute 与 submit 区别</a></li>
          </ol>
        </li>
        <li><a href="#三线程池配置优化建议">三、线程池配置优化建议</a>
          <ol>
            <li><a href="#1-当前实现的潜在问题">1. 当前实现的潜在问题</a></li>
            <li><a href="#2-推荐改进方案">2. 推荐改进方案</a></li>
          </ol>
        </li>
        <li><a href="#四异常处理机制">四、异常处理机制</a>
          <ol>
            <li><a href="#1-当前实现的异常处理">1. 当前实现的异常处理</a></li>
            <li><a href="#2-增强型异常处理方案">2. 增强型异常处理方案</a></li>
          </ol>
        </li>
        <li><a href="#五性能监控建议">五、性能监控建议</a>
          <ol>
            <li><a href="#1-添加线程池监控">1. 添加线程池监控</a></li>
          </ol>
        </li>
        <li><a href="#六实际应用场景分析">六、实际应用场景分析</a></li>
        <li><a href="#七总结">七、总结</a></li>
      </ol>
    </li>
    <li><a href="#elasticsearch搜索组件详解">Elasticsearch搜索组件详解</a>
      <ol>
        <li><a href="#一elasticsearch基础介绍">一、Elasticsearch基础介绍</a></li>
        <li><a href="#二组件配置解析">二、组件配置解析</a></li>
        <li><a href="#三核心方法详解">三、核心方法详解</a>
          <ol>
            <li><a href="#1-索引初始化方法-createindex">1. 索引初始化方法 createIndex()</a></li>
            <li><a href="#2-文档操作方法">2. 文档操作方法</a></li>
            <li><a href="#3-搜索方法-search">3. 搜索方法 search()</a></li>
          </ol>
        </li>
        <li><a href="#四设计亮点分析">四、设计亮点分析</a></li>
        <li><a href="#五潜在优化建议">五、潜在优化建议</a></li>
        <li><a href="#六初始化流程initrun">六、初始化流程（InitRun）</a></li>
      </ol>
    </li>
    <li><a href="#java反射机制及其在代码中的应用">Java反射机制及其在代码中的应用</a>
      <ol>
        <li><a href="#一反射基础概念">一、反射基础概念</a></li>
        <li><a href="#二代码中的反射解析">二、代码中的反射解析</a></li>
        <li><a href="#三反射在此处的具体作用">三、反射在此处的具体作用</a></li>
        <li><a href="#四反射的工作流程">四、反射的工作流程</a></li>
        <li><a href="#五反射的优缺点">五、反射的优缺点</a></li>
        <li><a href="#六性能优化建议">六、性能优化建议</a></li>
        <li><a href="#七在此场景下的必要性分析">七、在此场景下的必要性分析</a></li>
        <li><a href="#八完整流程示例">八、完整流程示例</a></li>
      </ol>
    </li>
    <li><a href="#aop面向切面编程基础详解">AOP（面向切面编程）基础详解</a>
      <ol>
        <li><a href="#一aop核心概念">一、AOP核心概念</a></li>
        <li><a href="#二spring-aop实现机制">二、Spring AOP实现机制</a>
          <ol>
            <li><a href="#1-代理模式">1. 代理模式</a></li>
            <li><a href="#2-通知类型">2. 通知类型</a></li>
          </ol>
        </li>
        <li><a href="#三spring-aop实战">三、Spring AOP实战</a>
          <ol>
            <li><a href="#1-基本配置">1. 基本配置</a></li>
            <li><a href="#2-切面定义示例">2. 切面定义示例</a></li>
          </ol>
        </li>
        <li><a href="#四切点表达式语法">四、切点表达式语法</a>
          <ol>
            <li><a href="#1-基本语法">1. 基本语法</a></li>
            <li><a href="#2-常用表达式示例">2. 常用表达式示例</a></li>
          </ol>
        </li>
        <li><a href="#五获取上下文信息">五、获取上下文信息</a>
          <ol>
            <li><a href="#1-方法信息获取">1. 方法信息获取</a></li>
            <li><a href="#2-返回值获取">2. 返回值获取</a></li>
            <li><a href="#3-异常获取">3. 异常获取</a></li>
          </ol>
        </li>
        <li><a href="#六aop应用场景">六、AOP应用场景</a></li>
        <li><a href="#七spring-aop与aspectj对比">七、Spring AOP与AspectJ对比</a></li>
        <li><a href="#八最佳实践建议">八、最佳实践建议</a></li>
        <li><a href="#九完整示例方法级权限控制">九、完整示例：方法级权限控制</a></li>
      </ol>
    </li>
    <li><a href="#使用aop实现登录校验">使用AOP实现登录校验</a>
      <ol>
        <li><a href="#一aop基础概念">一、AOP基础概念</a></li>
        <li><a href="#二登录校验实现详解">二、登录校验实现详解</a>
          <ol>
            <li><a href="#1-定义注解标记需要拦截的方法">1. 定义注解（标记需要拦截的方法）</a></li>
            <li><a href="#2-实现切面逻辑">2. 实现切面逻辑</a></li>
            <li><a href="#3-业务方法应用">3. 业务方法应用</a></li>
          </ol>
        </li>
        <li><a href="#三执行流程分析">三、执行流程分析</a></li>
        <li><a href="#四设计优势分析">四、设计优势分析</a></li>
        <li><a href="#五扩展应用场景">五、扩展应用场景</a></li>
        <li><a href="#六性能优化建议-1">六、性能优化建议</a></li>
        <li><a href="#七常见问题解决方案">七、常见问题解决方案</a></li>
      </ol>
    </li>
    <li><a href="#登录校验的多种实现方式">登录校验的多种实现方式</a>
      <ol>
        <li><a href="#1-拦截器interceptor实现">1. 拦截器(Interceptor)实现</a></li>
        <li><a href="#2-过滤器filter实现">2. 过滤器(Filter)实现</a></li>
        <li><a href="#3-spring-security框架">3. Spring Security框架</a></li>
        <li><a href="#4-网关层统一校验">4. 网关层统一校验</a></li>
        <li><a href="#5-方法参数解析器">5. 方法参数解析器</a></li>
        <li><a href="#6-对比总结">6. 对比总结</a></li>
        <li><a href="#7-选择建议">7. 选择建议</a></li>
      </ol>
    </li>
    <li><a href="#jwt实现登录校验的完整方案">JWT实现登录校验的完整方案</a>
      <ol>
        <li><a href="#一jwt基础概念">一、JWT基础概念</a>
          <ol>
            <li><a href="#1-jwt组成结构">1. JWT组成结构</a></li>
            <li><a href="#2-工作流程">2. 工作流程</a></li>
          </ol>
        </li>
        <li><a href="#二spring-boot实现方案">二、Spring Boot实现方案</a>
          <ol>
            <li><a href="#1-添加依赖">1. 添加依赖</a></li>
            <li><a href="#2-jwt工具类">2. JWT工具类</a></li>
            <li><a href="#3-登录接口实现">3. 登录接口实现</a></li>
            <li><a href="#4-jwt校验过滤器">4. JWT校验过滤器</a></li>
            <li><a href="#5-安全配置">5. 安全配置</a></li>
          </ol>
        </li>
        <li><a href="#三客户端使用方式">三、客户端使用方式</a>
          <ol>
            <li><a href="#1-登录获取token">1. 登录获取token</a></li>
            <li><a href="#2-访问受保护api">2. 访问受保护API</a></li>
          </ol>
        </li>
        <li><a href="#四高级功能实现">四、高级功能实现</a></li>
        <li><a href="#五安全最佳实践">五、安全最佳实践</a></li>
        <li><a href="#六与其他方案的对比">六、与其他方案的对比</a></li>
      </ol>
    </li>
    <li><a href="#通过aop实现消息通知">通过AOP实现消息通知</a>
      <ol>
        <li><a href="#一整体设计思路">一、整体设计思路</a></li>
        <li><a href="#二核心组件详解">二、核心组件详解</a>
          <ol>
            <li><a href="#1-自定义注解-recordusermessage">1. 自定义注解 @RecordUserMessage</a></li>
            <li><a href="#2-aop切面实现-usermessageoperationaspect">2. AOP切面实现 UserMessageOperationAspect</a></li>
            <li><a href="#3-用户信息获取">3. 用户信息获取</a></li>
          </ol>
        </li>
        <li><a href="#三工作流程分析">三、工作流程分析</a></li>
        <li><a href="#四关键实现细节">四、关键实现细节</a>
          <ol>
            <li><a href="#1-参数名匹配机制">1. 参数名匹配机制</a></li>
            <li><a href="#2-消息类型动态判断">2. 消息类型动态判断</a></li>
            <li><a href="#3-异常处理策略">3. 异常处理策略</a></li>
          </ol>
        </li>
        <li><a href="#五使用示例">五、使用示例</a>
          <ol>
            <li><a href="#1-基础用法">1. 基础用法</a></li>
            <li><a href="#2-带参数自动提取">2. 带参数自动提取</a></li>
          </ol>
        </li>
        <li><a href="#六设计优势">六、设计优势</a></li>
        <li><a href="#七潜在优化方向">七、潜在优化方向</a></li>
        <li><a href="#八与其他方案的对比">八、与其他方案的对比</a></li>
      </ol>
    </li>
    <li><a href="#实战aop时需要重点关注的方面">实战AOP时需要重点关注的方面</a>
      <ol>
        <li><a href="#一切面设计与实现要点">一、切面设计与实现要点</a></li>
        <li><a href="#二参数处理关键点">二、参数处理关键点</a></li>
        <li><a href="#三异常处理策略">三、异常处理策略</a></li>
        <li><a href="#四性能优化方向">四、性能优化方向</a></li>
        <li><a href="#五安全注意事项">五、安全注意事项</a></li>
        <li><a href="#六可维护性设计">六、可维护性设计</a></li>
        <li><a href="#七与其他组件的协作">七、与其他组件的协作</a></li>
        <li><a href="#八测试相关建议">八、测试相关建议</a></li>
        <li><a href="#九您的实现亮点">九、您的实现亮点</a></li>
        <li><a href="#十总结-checklist">十、总结 Checklist</a></li>
      </ol>
    </li>
    <li><a href="#定时任务-每日数据统计和临时文件清理">定时任务-每日数据统计和临时文件清理</a>
      <ol>
        <li><a href="#一系统功能概述">一、系统功能概述</a></li>
        <li><a href="#二每日数据统计任务-statisticsdata">二、每日数据统计任务 statisticsData()</a>
          <ol>
            <li><a href="#代码结构与聚合逻辑解析">代码结构与聚合逻辑解析</a></li>
          </ol>
        </li>
        <li><a href="#三临时文件清理任务-deltempfile">三、临时文件清理任务 delTempFile()</a></li>
        <li><a href="#四架构设计亮点">四、架构设计亮点</a></li>
        <li><a href="#五潜在优化建议-1">五、潜在优化建议</a></li>
      </ol>
    </li>
    <li><a href="#gateway-路由分配与接口调用机制">Gateway 路由分配与接口调用机制</a>
      <ol>
        <li><a href="#一gateway-路由分配原理">一、Gateway 路由分配原理</a></li>
        <li><a href="#二接口访问路径差异解析">二、接口访问路径差异解析</a></li>
        <li><a href="#三负载均衡实例演示">三、负载均衡实例演示</a></li>
        <li><a href="#四完整调用链路示例">四、完整调用链路示例</a></li>
        <li><a href="#五网关工作原理">五、网关工作原理</a></li>
      </ol>
    </li>
    <li><a href="#adminfilter-详细解析">AdminFilter 详细解析</a>
      <ol>
        <li><a href="#一类定义与基础结构">一、类定义与基础结构</a></li>
        <li><a href="#二常量定义">二、常量定义</a></li>
        <li><a href="#三核心过滤逻辑apply方法">三、核心过滤逻辑（apply方法）</a>
          <ol>
            <li><a href="#1-路径判断与-token-提取">1. 路径判断与 Token 提取</a></li>
            <li><a href="#2-token-校验">2. Token 校验</a></li>
          </ol>
        </li>
        <li><a href="#四token-提取方法">四、Token 提取方法</a></li>
        <li><a href="#五设计思想与使用场景">五、设计思想与使用场景</a>
          <ol>
            <li><a href="#典型使用场景">典型使用场景</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#使用seata解决分布式事务问题">使用Seata解决分布式事务问题</a>
      <ol>
        <li><a href="#一为什么transactional在跨服务调用时不生效">一、为什么@Transactional在跨服务调用时不生效</a></li>
        <li><a href="#二seata解决方案全流程">二、Seata解决方案全流程</a></li>
        <li><a href="#三验证与排查技巧">三、验证与排查技巧</a></li>
        <li><a href="#四生活化总结">四、生活化总结</a></li>
        <li><a href="#五典型代码示例">五、典型代码示例</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/myfirstblog/">MyFirstBlog</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 15, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 91 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="弹幕视频网站笔记">弹幕视频网站笔记
</h1><h2 id="maven-多模块项目的-pom-文件配置详解">Maven 多模块项目的 POM 文件配置详解
</h2><p>这个文件是一个 Maven 的 POM (Project Object Model) 文件，它是 Maven 项目的核心配置文件，用于定义项目的结构、依赖关系、构建配置等信息。下面是对这个文件中各个部分的详细解释：</p>
<h3 id="1基本配置">1.基本配置
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">project</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="err">...</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">modelVersion</span><span class="p">&gt;</span>4.0.0<span class="p">&lt;/</span><span class="nt">modelVersion</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">groupId</span><span class="p">&gt;</span>com.easylive<span class="p">&lt;/</span><span class="nt">groupId</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">artifactId</span><span class="p">&gt;</span>easylive<span class="p">&lt;/</span><span class="nt">artifactId</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">version</span><span class="p">&gt;</span>1.0<span class="p">&lt;/</span><span class="nt">version</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">packaging</span><span class="p">&gt;</span>pom<span class="p">&lt;/</span><span class="nt">packaging</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>• modelVersion: 指定 POM 模型的版本（固定为 4.0.0）。<br>
• groupId: 项目的组织标识（通常是公司或组织的域名反转，如 com.easylive）。<br>
• artifactId: 项目的唯一标识符（如 easylive）。<br>
• version: 项目的版本号（如 1.0）。<br>
• packaging: 项目的打包类型，这里是 pom，表示这是一个多模块项目的父 POM。<br></p>
<h3 id="2-父项目继承">2. 父项目继承
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;parent&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>2.7.18<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;relativePath/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/parent&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>继承 Spring Boot 的父 POM，提供了默认的依赖管理、插件配置等。</li>
<li>relativePath 为空表示从本地仓库或远程仓库查找父 POM。</li>
</ul>
<h3 id="3-模块定义">3. 模块定义
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;modules&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;module&gt;</span>easylive-common<span class="nt">&lt;/module&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;module&gt;</span>easylive-admin<span class="nt">&lt;/module&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;module&gt;</span>easylive-web<span class="nt">&lt;/module&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/modules&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>定义子模块（多模块项目）：
<ul>
<li>easylive-common: 公共模块（如工具类、通用配置）。</li>
<li>easylive-admin: 后台管理模块。</li>
<li>easylive-web: 前端或 API 模块。</li>
</ul>
</li>
</ul>
<h3 id="4-全局属性">4. 全局属性
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;skipTests&gt;</span>true<span class="nt">&lt;/skipTests&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- 依赖版本号 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;springboot.version&gt;</span>2.7.18<span class="nt">&lt;/springboot.version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;mybatis.version&gt;</span>1.3.2<span class="nt">&lt;/mybatis.version&gt;</span>
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/properties&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>编码和 JDK 版本：指定源码编码为 UTF-8，编译使用 JDK 1.8。</li>
<li>跳过测试：skipTests=true 表示构建时跳过单元测试。</li>
<li>依赖版本号：集中管理所有依赖的版本号，便于统一升级。</li>
</ul>
<h3 id="5-依赖管理">5. 依赖管理
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencyManagement&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>${springboot.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;artifactId&gt;</span>logback-classic<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencyManagement&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作用：统一管理子模块的依赖版本，避免版本冲突。</li>
<li>特点：
<ul>
<li>子模块使用时无需指定版本号（继承父 POM 的版本）。</li>
<li>可以通过 <code>&lt;exclusions&gt;</code> 排除传递性依赖（如排除默认的 Logback 日志库）。</li>
</ul>
</li>
</ul>
<h3 id="6-关键依赖说明">6. 关键依赖说明
</h3><ul>
<li><strong>Spring Boot Starter Web</strong>：提供 Web 开发支持（如 Spring MVC）。</li>
<li><strong>MyBatis Starter</strong>：集成 MyBatis 和 Spring Boot。</li>
<li><strong>MySQL Connector</strong>：MySQL 数据库驱动。</li>
<li><strong>Logback</strong>：日志框架。</li>
<li><strong>Lombok</strong>：简化 Java 代码（如自动生成 Getter/Setter）。</li>
<li><strong>Fastjson</strong>：阿里巴巴的 JSON 处理库。</li>
<li><strong>Apache Commons</strong>：常用工具库（如 commons-lang3、commons-io）。</li>
<li><strong>Elasticsearch</strong>：全文搜索引擎支持。</li>
<li><strong>Easy Captcha</strong>：验证码生成库。</li>
</ul>
<h3 id="7-文件的作用">7. 文件的作用
</h3><ul>
<li>多模块管理：通过 <code>&lt;modules&gt;</code> 定义子模块，统一构建。</li>
<li>依赖版本控制：通过 <code>&lt;dependencyManagement&gt;</code> 集中管理依赖版本。</li>
<li>继承 Spring Boot 默认配置：简化 Spring Boot 项目的配置（如插件、默认依赖）。</li>
<li>统一构建规范：指定 JDK 版本、编码等全局配置。</li>
</ul>
<h4 id="补充说明">补充说明
</h4><ul>
<li>子模块的 POM 文件会继承父 POM 的配置，无需重复定义版本号。</li>
<li>实际依赖需要子模块显式声明（父 POM 仅管理版本）。</li>
<li>如果某个子模块需要特殊配置，可以在其 POM 中覆盖父 POM 的设置。</li>
</ul>
<p>这个文件是项目的核心配置，确保了依赖一致性和构建标准化。常用依赖库详细说明：</p>
<h4 id="1-commons-ioapache-commons-io">1. commons-io（Apache Commons IO）
</h4><p><strong>作用</strong>：提供更强大、易用的 I/O（输入/输出）操作工具类。<br>
<strong>典型用途</strong>：</p>
<ul>
<li>文件/目录的复制、删除、移动（FileUtils）。</li>
<li>流（Stream）的高效读写（IOUtils）。</li>
<li>文件监控（如 FileAlterationMonitor）。</li>
</ul>
<p><strong>示例代码</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.io.FileUtils</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 复制文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">FileUtils</span><span class="p">.</span><span class="na">copyFile</span><span class="p">(</span><span class="n">srcFile</span><span class="p">,</span><span class="w"> </span><span class="n">destFile</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 读取文件内容为字符串</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">readFileToString</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;UTF-8&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>版本说明</strong>：</p>
<ul>
<li>当前 POM 中版本为 2.5（较旧，最新版为 2.15.1）。</li>
</ul>
<h4 id="2-commons-codecapache-commons-codec">2. commons-codec（Apache Commons Codec）
</h4><p><strong>作用</strong>：提供常见的编码/解码工具，如 Base64、MD5、SHA 等。<br>
<strong>典型用途</strong>：</p>
<ul>
<li>加密哈希（DigestUtils.md5Hex()）。</li>
<li>Base64 编码/解码（Base64.encodeBase64String()）。</li>
<li>URL 编码/解码。</li>
</ul>
<p><strong>示例代码</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.codec.digest.DigestUtils</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 生成 MD5 哈希</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">md5Hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DigestUtils</span><span class="p">.</span><span class="na">md5Hex</span><span class="p">(</span><span class="s">&#34;HelloWorld&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>版本说明</strong>：</p>
<ul>
<li>当前 POM 中版本为 1.9（较旧，最新版为 1.16.1）。</li>
</ul>
<h4 id="3-commons-lang3apache-commons-lang3">3. commons-lang3（Apache Commons Lang3）
</h4><p><strong>作用</strong>：扩展 Java 标准库的工具类，尤其是 java.lang 包的增强。<br>
<strong>典型用途</strong>：</p>
<ul>
<li>字符串处理（StringUtils.isEmpty()）。</li>
<li>数组/对象操作（ArrayUtils, ObjectUtils）。</li>
<li>日期格式化（DateUtils）。</li>
<li>随机数生成（RandomStringUtils）。</li>
</ul>
<p><strong>示例代码</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.commons.lang3.StringUtils</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 检查字符串是否为空（包括 null 和空字符串）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">isEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">str</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>版本说明</strong>：</p>
<ul>
<li>当前 POM 中版本为 3.4（较旧，最新版为 3.14.0）。</li>
</ul>
<h4 id="4-aspectjweaveraspectj-库">4. aspectjweaver（AspectJ 库）
</h4><p><strong>作用</strong>：支持面向切面编程（AOP），用于解耦横切关注点（如日志、事务）。<br>
<strong>典型用途</strong>：</p>
<ul>
<li>配合 Spring AOP 实现方法拦截。</li>
<li>定义切面（@Aspect）、切入点（@Pointcut）、通知（@Before, @After 等）。</li>
</ul>
<p><strong>示例代码</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.aspectj.lang.annotation.Before</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Aspect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoggingAspect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Before</span><span class="p">(</span><span class="s">&#34;execution(* com.example.service.*.*(..))&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logBefore</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;方法执行前记录日志&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>版本说明</strong>：</p>
<ul>
<li>当前 POM 中版本为 1.9.3（较旧，最新版为 1.9.20）。</li>
</ul>
<h4 id="为什么需要这些库">为什么需要这些库？
</h4><ul>
<li>避免重复造轮子：提供现成的工具方法，减少手写通用代码。</li>
<li>标准化：Apache 和 Eclipse 维护的库，稳定性和性能有保障。</li>
<li>与 Spring 生态集成：如 aspectjweaver 是 Spring AOP 的底层依赖。</li>
</ul>
<h2 id="applicationyml-文件作用与常见配置项详解">application.yml 文件作用与常见配置项详解
</h2><p>application.yml 文件是 Spring Boot 应用的核心配置文件，采用 YAML 格式，用于定义应用程序的各种配置参数。以下是各个配置项的详细说明：</p>
<h3 id="1-服务器配置server">1. 服务器配置（server）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">7070</span><span class="w">                     </span><span class="c"># 服务器端口号（默认8080，这里设为7070）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">servlet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">context-path</span><span class="p">:</span><span class="w"> </span><span class="l">/admin        </span><span class="w"> </span><span class="c"># 应用上下文路径（访问路径需加 `/admin`，如 `http://localhost:7070/admin`）</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>port: 指定应用运行的端口号（默认 8080，这里改为 7070）。</li>
<li>context-path: 设置应用的根路径（如 /admin），所有请求都需要加上这个前缀。</li>
</ul>
<h3 id="2-文件上传配置springservletmultipart">2. 文件上传配置（spring.servlet.multipart）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">servlet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">multipart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max-file-size</span><span class="p">:</span><span class="w"> </span><span class="l">10MB       </span><span class="w"> </span><span class="c"># 单个文件最大大小（默认1MB）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max-request-size</span><span class="p">:</span><span class="w"> </span><span class="l">15MB    </span><span class="w"> </span><span class="c"># 整个请求的最大大小（默认10MB）</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>max-file-size: 限制单个上传文件的大小（如 10MB）。</li>
<li>max-request-size: 限制整个 HTTP 请求（可能包含多个文件）的最大大小（如 15MB）。</li>
</ul>
<h3 id="3-应用名称springapplicationname">3. 应用名称（spring.application.name）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">easylive-admin        </span><span class="w"> </span><span class="c"># 应用名称（用于服务发现、日志标记等）</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>用于标识当前应用（如微服务架构中的服务名）。</li>
</ul>
<h3 id="4-数据库配置springdatasource">4. 数据库配置（spring.datasource）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://127.0.0.1:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root              </span><span class="w"> </span><span class="c"># 数据库用户名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">root              </span><span class="w"> </span><span class="c"># 数据库密码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver </span><span class="w"> </span><span class="c"># MySQL JDBC 驱动</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hikari</span><span class="p">:</span><span class="w">                      </span><span class="c"># HikariCP 连接池配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pool-name</span><span class="p">:</span><span class="w"> </span><span class="l">HikariCPDatasource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">minimum-idle</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">            </span><span class="c"># 最小空闲连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maximum-pool-size</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">      </span><span class="c"># 最大连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">idle-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">180000</span><span class="w">       </span><span class="c"># 空闲连接超时时间（毫秒）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max-lifetime</span><span class="p">:</span><span class="w"> </span><span class="m">1800000</span><span class="w">      </span><span class="c"># 连接最大存活时间（毫秒）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connection-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">30000</span><span class="w">  </span><span class="c"># 连接超时时间（毫秒）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connection-test-query</span><span class="p">:</span><span class="w"> </span><span class="l">SELECT 1 </span><span class="w"> </span><span class="c"># 连接测试SQL</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>url: MySQL 数据库连接地址，包含 serverTimezone、编码、自动重连等参数。</li>
<li>hikari: HikariCP 是 Spring Boot 默认的高性能数据库连接池，这里配置了连接池参数。</li>
</ul>
<h3 id="5-redis-配置springredis">5. Redis 配置（spring.redis）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">                  </span><span class="c"># Redis 数据库索引（默认0）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">              </span><span class="c"># Redis 服务器地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">                   </span><span class="c"># Redis 端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">jedis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">max-active</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">           </span><span class="c"># 最大活跃连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">max-wait</span><span class="p">:</span><span class="w"> </span>-<span class="m">1</span><span class="w">             </span><span class="c"># 最大等待时间（-1表示无限等待）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">max-idle</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">             </span><span class="c"># 最大空闲连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">min-idle</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">              </span><span class="c"># 最小空闲连接数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">2000</span><span class="w">                </span><span class="c"># 连接超时时间（毫秒）</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>配置 Redis 连接信息，使用 Jedis 作为客户端。</li>
</ul>
<h3 id="6-mybatis-配置mybatis">6. MyBatis 配置（mybatis）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">configuration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">map-underscore-to-camel-case</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># 数据库字段下划线转驼峰命名（如 `user_name` → `userName`）</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>map-underscore-to-camel-case: 自动将数据库的 snake_case 字段名映射为 Java 的 camelCase 属性名。</li>
</ul>
<h3 id="7-自定义配置projectlogadmin">7. 自定义配置（project、log、admin）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">project</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">folder</span><span class="p">:</span><span class="w"> </span><span class="l">D:/work-webser/myapps/easylive </span><span class="w"> </span><span class="c"># 自定义项目文件存储路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">log</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">root</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l">debug                 </span><span class="w"> </span><span class="c"># 日志级别（debug、info、warn、error）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">admin</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">account</span><span class="p">:</span><span class="w"> </span><span class="l">admin                 </span><span class="w"> </span><span class="c"># 管理员账号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">admin123             </span><span class="w"> </span><span class="c"># 管理员密码</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>project.folder: 自定义文件存储路径（如上传的文件存放位置）。</li>
<li>log.root.level: 设置日志级别（debug 会打印更详细的日志）。</li>
<li>admin.account/password: 可能是用于后台管理的默认账号密码。</li>
</ul>
<h3 id="总结">总结
</h3><p>application.yml 文件可以根据实际业务需求，灵活扩展和定制。常见配置还包括安全（security）、第三方服务（如短信、支付）、自定义参数等。通过集中管理这些配置，可以让 Spring Boot 项目更易于维护和部署。</p>
<h2 id="hikaricp-介绍">HikariCP 介绍
</h2><p>HikariCP 是目前 Java 生态中最快、最轻量级的高性能 JDBC 连接池，被 Spring Boot 2.x 及更高版本选为默认数据库连接池。它的名字来源于日语&quot;光&quot;（Hikari），意为&quot;快速、高效&quot;。</p>
<h3 id="1-为什么选择-hikaricp">1. 为什么选择 HikariCP？
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>极高性能</td>
          <td>比传统的 C3P0、Tomcat JDBC、DBCP 快很多</td>
      </tr>
      <tr>
          <td>轻量级</td>
          <td>代码精简（约 130KB），无额外依赖</td>
      </tr>
      <tr>
          <td>零开销</td>
          <td>优化了字节码，减少 JVM 垃圾回收压力</td>
      </tr>
      <tr>
          <td>自动优化</td>
          <td>智能调整连接池大小，避免资源浪费</td>
      </tr>
      <tr>
          <td>健康检查</td>
          <td>自动检测失效连接，避免应用因数据库问题崩溃</td>
      </tr>
      <tr>
          <td>Spring Boot 默认</td>
          <td>无需额外配置，开箱即用</td>
      </tr>
  </tbody>
</table></div>
<h3 id="2-hikaricp-核心配置参数">2. HikariCP 核心配置参数
</h3><p>在你的 application.yml 中，HikariCP 的配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hikari</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pool-name</span><span class="p">:</span><span class="w"> </span><span class="l">HikariCPDatasource  </span><span class="w"> </span><span class="c"># 连接池名称（用于监控）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">minimum-idle</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">                 </span><span class="c"># 最小空闲连接数（默认等于 maximum-pool-size）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maximum-pool-size</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">           </span><span class="c"># 最大连接数（推荐值：CPU核心数 * 2 + 1）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">idle-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">180000</span><span class="w">            </span><span class="c"># 空闲连接超时时间（毫秒，默认 60000）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max-lifetime</span><span class="p">:</span><span class="w"> </span><span class="m">1800000</span><span class="w">           </span><span class="c"># 连接最大存活时间（毫秒，默认 1800000）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">auto-commit</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">               </span><span class="c"># 是否自动提交事务（默认 true）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connection-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">30000</span><span class="w">       </span><span class="c"># 连接超时时间（毫秒，默认 30000）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connection-test-query</span><span class="p">:</span><span class="w"> </span><span class="l">SELECT 1</span><span class="w"> </span><span class="c"># 连接测试 SQL（用于检查连接是否有效）</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="关键参数说明">关键参数说明
</h4><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>参数</th>
          <th>推荐值</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>maximum-pool-size</td>
          <td>CPU核心数 * 2 + 1</td>
          <td>避免连接数过多导致数据库性能下降</td>
      </tr>
      <tr>
          <td>minimum-idle</td>
          <td>≤ maximum-pool-size</td>
          <td>保持的最小空闲连接数（默认等于最大值）</td>
      </tr>
      <tr>
          <td>idle-timeout</td>
          <td>60000（1分钟）</td>
          <td>空闲连接超过此时间会被回收</td>
      </tr>
      <tr>
          <td>max-lifetime</td>
          <td>1800000（30分钟）</td>
          <td>连接最大存活时间，避免长时间占用</td>
      </tr>
      <tr>
          <td>connection-timeout</td>
          <td>30000（30秒）</td>
          <td>获取连接的超时时间，超时抛异常</td>
      </tr>
      <tr>
          <td>connection-test-query</td>
          <td>SELECT 1</td>
          <td>检查连接是否有效的 SQL（MySQL 可用）</td>
      </tr>
  </tbody>
</table></div>
<h3 id="3-hikaricp-的优势">3. HikariCP 的优势
</h3><p><strong>(1) 性能极致优化</strong></p>
<ul>
<li>无锁并发：采用 ConcurrentBag 数据结构，减少锁竞争。</li>
<li>字节码优化：减少 JVM 方法调用开销。</li>
<li>智能缓存：复用 PreparedStatement，减少 SQL 解析时间。</li>
</ul>
<p><strong>(2) 自动维护连接健康</strong></p>
<ul>
<li>心跳检测：定期检查连接是否有效，避免使用已断开的连接。</li>
<li>快速失败：如果数据库宕机，HikariCP 会立即抛出异常，而不是无限等待。</li>
</ul>
<p><strong>(3) 与 Spring Boot 完美集成</strong></p>
<ul>
<li>Spring Boot 2.x 默认使用 HikariCP，只需配置 spring.datasource.hikari.* 即可。</li>
</ul>
<h3 id="4-常见问题">4. 常见问题
</h3><p><strong>Q1: HikariCP 和 Druid 哪个更好？</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>对比项</th>
          <th>HikariCP</th>
          <th>Druid</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>性能</td>
          <td>⚡ 更快</td>
          <td>稍慢</td>
      </tr>
      <tr>
          <td>功能</td>
          <td>基础连接池</td>
          <td>带监控、SQL 防火墙等</td>
      </tr>
      <tr>
          <td>适用场景</td>
          <td>高性能需求</td>
          <td>需要监控和扩展功能</td>
      </tr>
  </tbody>
</table></div>
<p><strong>推荐选择：</strong></p>
<ul>
<li>如果只需要高性能连接池 → HikariCP（默认推荐）。</li>
<li>如果需要监控、SQL 防注入 → Druid。</li>
</ul>
<p><strong>Q2: 如何监控 HikariCP？</strong></p>
<p>可以通过 Spring Boot Actuator 或 JMX 监控连接池状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="l">health,metrics,hikaricp</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>访问 http://localhost:7070/actuator/hikaricp 查看连接池状态。</p>
<h3 id="5-总结">5. 总结
</h3><ul>
<li>HikariCP 是 Spring Boot 默认的高性能连接池，适合绝大多数场景。</li>
<li>关键配置：maximum-pool-size、minimum-idle、connection-timeout。</li>
<li>优势：速度快、轻量级、自动维护连接健康。</li>
<li>监控：可通过 Actuator 或 JMX 查看状态。</li>
</ul>
<p>如果你的应用不需要 Druid 的额外功能，HikariCP 是最佳选择！</p>
<h2 id="jdbc-连接池connection-pool详解">JDBC 连接池（Connection Pool）详解
</h2><p>JDBC（Java Database Connectivity）是 Java 连接数据库的标准 API，而 JDBC 连接池是一种数据库连接管理技术，用于高效复用数据库连接，避免频繁创建和销毁连接带来的性能开销。</p>
<h3 id="1-为什么需要连接池">1. 为什么需要连接池？
</h3><p><strong>（1）直接 JDBC 的问题</strong></p>
<p>如果每次访问数据库都直接创建新连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 传统方式：每次操作数据库都新建连接（低效！）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 执行SQL...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">conn</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w"> </span><span class="c1">// 关闭连接</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>缺点：</strong></p>
<ul>
<li>频繁创建/关闭连接消耗大量资源（TCP 三次握手、数据库认证等）。</li>
<li>高并发时，数据库可能因连接数过多而崩溃。</li>
</ul>
<p><strong>（2）连接池的解决方案</strong></p>
<p>连接池预先创建一批连接，应用需要时直接从池中获取，用完归还（而不是关闭）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 使用连接池（高效！）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getConnection</span><span class="p">();</span><span class="w"> </span><span class="c1">// 从池中获取</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 执行SQL...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">conn</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w"> </span><span class="c1">// 实际是归还到连接池，并非真正关闭</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>优点：</strong></p>
<ul>
<li>复用连接，避免重复创建的开销。</li>
<li>控制最大连接数，防止数据库过载。</li>
<li>支持健康检查，自动剔除失效连接。</li>
</ul>
<h3 id="2-连接池的核心工作原理">2. 连接池的核心工作原理
</h3><p><strong>（1）初始化阶段</strong></p>
<ul>
<li>启动时创建一定数量的连接（如 minimum-idle=5），放入池中备用。</li>
</ul>
<p><strong>（2）运行阶段</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>步骤</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>应用请求连接</td>
          <td>从池中分配一个空闲连接</td>
      </tr>
      <tr>
          <td>执行 SQL</td>
          <td>使用连接操作数据库</td>
      </tr>
      <tr>
          <td>归还连接</td>
          <td>调用 conn.close()，连接回到池中（未真正关闭）</td>
      </tr>
  </tbody>
</table></div>
<p><strong>（3）连接管理</strong></p>
<ul>
<li>空闲超时：长时间未使用的连接会被回收（idle-timeout）。</li>
<li>最大生命周期：连接超过存活时间（max-lifetime）会被销毁并新建。</li>
<li>健康检查：定期用 SELECT 1 测试连接是否有效。</li>
</ul>
<h3 id="3-常见-jdbc-连接池对比">3. 常见 JDBC 连接池对比
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>连接池</th>
          <th>特点</th>
          <th>适用场景</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>HikariCP</td>
          <td>速度最快、轻量级</td>
          <td>Spring Boot 默认，高性能需求</td>
      </tr>
      <tr>
          <td>Druid</td>
          <td>带监控、防 SQL 注入</td>
          <td>需要监控和扩展功能</td>
      </tr>
      <tr>
          <td>Tomcat JDBC</td>
          <td>轻量级</td>
          <td>嵌入式 Tomcat 应用</td>
      </tr>
      <tr>
          <td>C3P0</td>
          <td>老牌连接池，稳定性高</td>
          <td>传统项目（已逐渐被取代）</td>
      </tr>
  </tbody>
</table></div>
<h3 id="4-代码示例spring-boot--hikaricp">4. 代码示例（Spring Boot + HikariCP）
</h3><p><strong>（1）application.yml 配置</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hikari</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maximum-pool-size</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connection-timeout</span><span class="p">:</span><span class="w"> </span><span class="m">30000</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>（2）Java 代码使用</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">DataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="p">;</span><span class="w"> </span><span class="c1">// 自动注入 HikariCP 数据源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">queryData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getConnection</span><span class="p">();</span><span class="w"> </span><span class="c1">// 从池中获取</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">Statement</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="p">.</span><span class="na">createStatement</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ResultSet</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stmt</span><span class="p">.</span><span class="na">executeQuery</span><span class="p">(</span><span class="s">&#34;SELECT * FROM users&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="c1">// 此处自动调用 conn.close()，连接归还到池中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5-总结-1">5. 总结
</h3><ul>
<li>JDBC 连接池是数据库连接的缓存池，核心目标是复用连接、提升性能。</li>
<li>HikariCP 是目前最快的连接池，适合大多数 Java 应用。</li>
<li>关键配置：maximum-pool-size、idle-timeout、connection-timeout。</li>
</ul>
<h2 id="springboot-启动类easylivewebrunapplication-详解">SpringBoot 启动类——EasyLiveWebRunApplication 详解
</h2><p>这段代码是 Spring Boot 应用的主启动类，包含了多个关键注解，用于配置和启动整个应用程序。以下是各个部分的详细解析：</p>
<h3 id="1-springbootapplication">1. @SpringBootApplication
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span><span class="p">(</span><span class="n">scanBasePackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#34;com.easylive&#34;</span><span class="p">})</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作用：标记该类为 Spring Boot 应用的入口，整合了以下 3 个核心注解：
<ul>
<li>@SpringBootConfiguration：标识这是一个 Spring Boot 配置类。</li>
<li>@EnableAutoConfiguration：启用 Spring Boot 的自动配置（如自动配置数据源、Web MVC 等）。</li>
<li>@ComponentScan：扫描指定包（com.easylive）下的组件（@Controller、@Service、@Repository 等）。</li>
</ul>
</li>
<li>参数：
<ul>
<li>scanBasePackages：显式指定扫描的包路径（覆盖默认扫描当前包及其子包）。</li>
</ul>
</li>
</ul>
<h3 id="2-mapperscan">2. @MapperScan
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@MapperScan</span><span class="p">(</span><span class="n">basePackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&#34;com.easylive.mappers&#34;</span><span class="p">})</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作用：告诉 MyBatis 扫描指定包（com.easylive.mappers）下的 Mapper 接口，并自动生成其实现类（无需手动写实现）。</li>
<li>背景：MyBatis 需要将接口与 XML/SQL 映射文件关联，此注解省去了逐个添加 @Mapper 注解的麻烦。</li>
</ul>
<h3 id="3-enabletransactionmanagement">3. @EnableTransactionManagement
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableTransactionManagement</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作用：启用 Spring 的声明式事务管理（基于 @Transactional 注解）。</li>
<li>效果：
<ul>
<li>方法或类上添加 @Transactional 后，Spring 会自动管理数据库事务（如提交、回滚）。</li>
<li>默认使用 JDBC 或 JPA 的事务管理器。</li>
</ul>
</li>
</ul>
<h3 id="4-enablescheduling">4. @EnableScheduling
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableScheduling</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作用：启用 Spring 的定时任务功能。</li>
<li>用法：在方法上添加 @Scheduled(cron=&ldquo;0 * * * * ?&rdquo;) 即可定义定时任务（如每天凌晨执行数据统计）。</li>
</ul>
<h3 id="5-main-方法">5. main 方法
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">EasyLiveWebRunApplication</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作用：启动 Spring Boot 应用的入口方法。</li>
<li>流程：
<ol>
<li>初始化 Spring 容器。</li>
<li>加载自动配置（如 Web 服务器、数据库连接池等）。</li>
<li>扫描并注册所有 Spring 组件（如 Controller、Service）。</li>
</ol>
</li>
</ul>
<h3 id="6-排除自动配置未使用但需注意">6. 排除自动配置（未使用但需注意）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 示例：排除数据源自动配置（多数据源场景可能需要）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@SpringBootApplication</span><span class="p">(</span><span class="n">exclude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">DataSourceAutoConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">})</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>用途：如果应用不需要数据库（或需自定义数据源），可通过 exclude 禁用 Spring Boot 的默认配置。</li>
</ul>
<h3 id="总结核心功能">总结：核心功能
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>注解/代码</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>@SpringBootApplication</td>
          <td>启动自动配置 + 组件扫描</td>
      </tr>
      <tr>
          <td>@MapperScan</td>
          <td>自动注册 MyBatis Mapper 接口</td>
      </tr>
      <tr>
          <td>@EnableTransactionManagement</td>
          <td>启用事务管理</td>
      </tr>
      <tr>
          <td>@EnableScheduling</td>
          <td>启用定时任务</td>
      </tr>
      <tr>
          <td>main()</td>
          <td>启动 Spring Boot 应用</td>
      </tr>
  </tbody>
</table></div>
<h4 id="补充说明-1">补充说明
</h4><ul>
<li>包扫描范围：scanBasePackages 确保扫描整个项目（而不仅是当前包）。</li>
<li>MyBatis 集成：@MapperScan 需配合 mybatis-spring-boot-starter 依赖使用。</li>
<li>事务控制：在 Service 层方法添加 @Transactional 即可实现事务（如回滚异常操作）。</li>
</ul>
<p>这个启动类是 Spring Boot 应用的&quot;大脑&quot;，通过注解驱动了整个框架的协作运行。</p>
<h2 id="httpservletrequesthttpservletresponsehttpsession-介绍">HttpServletRequest、HttpServletResponse、HttpSession 介绍
</h2><p>这三个是 Java Web 开发（Servlet/JSP）的核心接口，用于处理 HTTP 请求和响应以及用户会话管理。在 Spring MVC（@Controller）中也被广泛使用。</p>
<h3 id="1-httpservletrequest请求对象">1. HttpServletRequest（请求对象）
</h3><p><strong>作用</strong></p>
<ul>
<li>封装客户端（浏览器）发送的 HTTP 请求信息，包括：
<ul>
<li>请求参数（GET/POST）</li>
<li>请求头（Headers）</li>
<li>会话（Session）</li>
<li>客户端信息（IP、User-Agent）</li>
</ul>
</li>
</ul>
<p><strong>常用方法</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>方法</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>String getParameter(&ldquo;name&rdquo;)</td>
          <td>获取请求参数（如 ?id=123 或表单 POST 数据）</td>
      </tr>
      <tr>
          <td>String[] getParameterValues(&ldquo;name&rdquo;)</td>
          <td>获取复选框等同名参数（返回数组）</td>
      </tr>
      <tr>
          <td>String getHeader(&ldquo;User-Agent&rdquo;)</td>
          <td>获取请求头信息</td>
      </tr>
      <tr>
          <td>String getMethod()</td>
          <td>获取请求方法（GET/POST/PUT/DELETE）</td>
      </tr>
      <tr>
          <td>String getRequestURI()</td>
          <td>获取请求路径（如 /user/login）</td>
      </tr>
      <tr>
          <td>Cookie[] getCookies()</td>
          <td>获取客户端发送的 Cookie</td>
      </tr>
      <tr>
          <td>HttpSession getSession()</td>
          <td>获取或创建会话（Session）</td>
      </tr>
      <tr>
          <td>String getRemoteAddr()</td>
          <td>获取客户端 IP 地址</td>
      </tr>
  </tbody>
</table></div>
<p><strong>代码示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/user&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getUser</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;username&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 获取参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getRemoteAddr</span><span class="p">();</span><span class="w"> </span><span class="c1">// 获取客户端IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;User: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;, IP: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ip</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="2-httpservletresponse响应对象">2. HttpServletResponse（响应对象）
</h3><p><strong>作用</strong></p>
<ul>
<li>封装服务器返回给客户端的 HTTP 响应信息，包括：
<ul>
<li>设置响应状态码（200/404/500）</li>
<li>添加响应头（Headers）</li>
<li>写入响应体（HTML/JSON）</li>
<li>重定向或转发</li>
</ul>
</li>
</ul>
<p><strong>常用方法</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>方法</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>void setStatus(200)</td>
          <td>设置 HTTP 状态码（如 404、500）</td>
      </tr>
      <tr>
          <td>void setContentType(&ldquo;text/html&rdquo;)</td>
          <td>设置响应内容类型（如 application/json）</td>
      </tr>
      <tr>
          <td>PrintWriter getWriter()</td>
          <td>获取输出流，向客户端发送文本（HTML/JSON）</td>
      </tr>
      <tr>
          <td>void sendRedirect(&quot;/new-url&quot;)</td>
          <td>重定向到新地址（302 跳转）</td>
      </tr>
      <tr>
          <td>void addCookie(Cookie cookie)</td>
          <td>向客户端添加 Cookie</td>
      </tr>
      <tr>
          <td>void setHeader(&ldquo;Cache-Control&rdquo;, &ldquo;no-cache&rdquo;)</td>
          <td>设置响应头</td>
      </tr>
  </tbody>
</table></div>
<p><strong>代码示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/hello&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sayHello</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&#34;text/html&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">().</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;&lt;h1&gt;Hello World!&lt;/h1&gt;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/redirect&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">redirect</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">response</span><span class="p">.</span><span class="na">sendRedirect</span><span class="p">(</span><span class="s">&#34;https://example.com&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 重定向</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="3-httpsession会话对象">3. HttpSession（会话对象）
</h3><p><strong>作用</strong></p>
<ul>
<li>用于在多次 HTTP 请求间存储用户数据（如登录状态、购物车信息）。</li>
<li>基于 Cookie（JSESSIONID）或 URL 重写实现会话跟踪。</li>
</ul>
<p><strong>常用方法</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>方法</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>void setAttribute(&ldquo;key&rdquo;, value)</td>
          <td>存储会话数据</td>
      </tr>
      <tr>
          <td>Object getAttribute(&ldquo;key&rdquo;)</td>
          <td>获取会话数据</td>
      </tr>
      <tr>
          <td>void removeAttribute(&ldquo;key&rdquo;)</td>
          <td>删除会话数据</td>
      </tr>
      <tr>
          <td>void invalidate()</td>
          <td>销毁当前会话（用户注销）</td>
      </tr>
      <tr>
          <td>String getId()</td>
          <td>获取会话 ID</td>
      </tr>
      <tr>
          <td>long getCreationTime()</td>
          <td>获取会话创建时间</td>
      </tr>
  </tbody>
</table></div>
<p><strong>代码示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 登录时存储用户信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&#34;/login&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">();</span><span class="w"> </span><span class="c1">// 获取或创建Session</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">);</span><span class="w"> </span><span class="c1">// 存储用户信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Login success!&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 获取会话数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/profile&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">profile</span><span class="p">(</span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 获取用户信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Current user: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 注销</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/logout&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">session</span><span class="p">.</span><span class="na">invalidate</span><span class="p">();</span><span class="w"> </span><span class="c1">// 销毁会话</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Logged out!&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="4-三者的关系">4. 三者的关系
</h3><p><strong>请求流程：</strong></p>
<ul>
<li>浏览器发送请求 → HttpServletRequest 接收数据。</li>
<li>服务器处理请求 → 使用 HttpSession 存储用户状态。</li>
<li>服务器返回响应 → HttpServletResponse 输出结果。</li>
</ul>
<p><strong>典型场景：</strong></p>
<ul>
<li>登录认证：通过 Session 保存用户登录状态。</li>
<li>表单提交：通过 Request 获取参数，通过 Response 返回结果。</li>
<li>权限控制：检查 Session 中是否存在用户信息。</li>
</ul>
<hr>
<h3 id="5-在-spring-mvc-中的简化用法">5. 在 Spring MVC 中的简化用法
</h3><p>Spring 提供了更简洁的替代方式（底层仍依赖这三个对象）：</p>
<p><strong>(1) 直接注入</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/example&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">example</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">param</span><span class="p">,</span><span class="w">   </span><span class="c1">// 替代 request.getParameter()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@CookieValue</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cookie</span><span class="p">,</span><span class="w">   </span><span class="c1">// 替代 request.getCookies()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="w">           </span><span class="c1">// 直接注入 Session</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;value&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;OK&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>(2) 使用 @ModelAttribute 绑定对象</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&#34;/user&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">addUser</span><span class="p">(</span><span class="nd">@ModelAttribute</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 自动将请求参数绑定到 User 对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Saved: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="6-总结">6. 总结
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>对象</th>
          <th>作用</th>
          <th>典型用途</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>HttpServletRequest</td>
          <td>封装客户端请求</td>
          <td>获取参数、请求头、客户端信息</td>
      </tr>
      <tr>
          <td>HttpServletResponse</td>
          <td>封装服务器响应</td>
          <td>设置状态码、返回数据、重定向</td>
      </tr>
      <tr>
          <td>HttpSession</td>
          <td>跨请求存储用户数据</td>
          <td>登录状态、购物车、用户偏好</td>
      </tr>
  </tbody>
</table></div>
<p>掌握这三个对象是 Java Web 开发的基础，无论是传统 Servlet 还是 Spring MVC 都离不开它们！</p>
<h2 id="获取-httpservletrequest-对象的两种方式">获取 HttpServletRequest 对象的两种方式
</h2><p>在 Spring Web 开发中，获取 request 对象主要有两种常用方式：</p>
<h3 id="1-通过方法参数直接注入spring-mvc-推荐">1. 通过方法参数直接注入（Spring MVC 推荐）
</h3><p>在 Controller 方法中直接声明 HttpServletRequest 参数，Spring 会自动注入当前请求的 request 对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/example&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">example</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;Param: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">param</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>优点：</strong> 简单直接，无需手动处理。</p>
<hr>
<h3 id="2-通过-requestcontextholder-工具类获取">2. 通过 RequestContextHolder 工具类获取
</h3><p>在任何地方（如 Service 层、工具类）通过 Spring 的 RequestContextHolder 静态方法获取：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.ServletRequestAttributes</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyUtils</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logRequest</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">((</span><span class="n">ServletRequestAttributes</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">getRequestAttributes</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">getRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Request URI: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getRequestURI</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>例如：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span><span class="w"> </span><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="nf">getTokenUserInfoDto</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ServletRequestAttributes</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">getRequestAttributes</span><span class="p">()).</span><span class="na">getRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_WEB</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getTokenInfo</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>适用场景：</strong> 非 Controller 层（如 Service、AOP、工具类）需要获取 request 时。</p>
<h2 id="tokenuserinfodto-中-jsonignoreproperties-和-serializable-的作用">TokenUserInfoDto 中 @JsonIgnoreProperties 和 Serializable 的作用
</h2><p>这段代码定义了一个名为 TokenUserInfoDto 的 DTO（数据传输对象），用于封装用户令牌信息。以下是对 @JsonIgnoreProperties 和 Serializable 接口作用的详细解释：</p>
<h3 id="1-jsonignorepropertiesignoreunknown--true">1. @JsonIgnoreProperties(ignoreUnknown = true)
</h3><p><strong>作用</strong></p>
<ul>
<li>这是 Jackson 库提供的注解，用于控制 JSON 序列化/反序列化时的行为。</li>
<li>ignoreUnknown = true 表示：当 JSON 字符串中包含 DTO 类中没有的字段时，忽略这些字段而不报错。</li>
</ul>
<p><strong>为什么需要它？</strong></p>
<ul>
<li>场景：如果后端接收的 JSON 数据比 DTO 的字段多（例如前端传了 extraField，但 DTO 未定义该字段），默认情况下 Jackson 会抛出 UnrecognizedPropertyException。</li>
<li>解决：添加此注解后，多余的字段会被静默忽略，确保反序列化不会因字段不匹配而失败。</li>
</ul>
<p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// JSON 数据（包含 DTO 中没有的字段 &#34;age&#34;）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;{\&#34;userId\&#34;:\&#34;123\&#34;, \&#34;nickName\&#34;:\&#34;Alice\&#34;, \&#34;age\&#34;:25}&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 反序列化时，&#34;age&#34; 会被忽略，不会报错</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="n">dto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span><span class="n">json</span><span class="p">,</span><span class="w"> </span><span class="n">TokenUserInfoDto</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="2-implements-serializable">2. implements Serializable
</h3><p><strong>作用</strong></p>
<ul>
<li>标记该类为可序列化的，表示该类的对象可以被转换为字节流（例如存储到文件、通过网络传输或存入 Redis 等缓存）。</li>
<li>需要定义一个 serialVersionUID 字段作为版本控制标识符。</li>
</ul>
<p><strong>为什么需要它？</strong></p>
<ul>
<li>网络传输：在 RPC（如 Dubbo）或分布式系统中，对象需要跨 JVM 传输，必须实现 Serializable。</li>
<li>持久化存储：将对象保存到磁盘或数据库（如 Redis 的 value 需要实现序列化）。</li>
<li>兼容性：serialVersionUID 用于验证序列化和反序列化的类是否兼容（如果类结构变更但未更新 UID，会抛出 InvalidClassException）。</li>
</ul>
<p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 序列化对象到字节数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ByteArrayOutputStream</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayOutputStream</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ObjectOutputStream</span><span class="w"> </span><span class="n">oos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectOutputStream</span><span class="p">(</span><span class="n">bos</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">oos</span><span class="p">.</span><span class="na">writeObject</span><span class="p">(</span><span class="n">dto</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bos</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 从字节数组反序列化</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ByteArrayInputStream</span><span class="w"> </span><span class="n">bis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ByteArrayInputStream</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ObjectInputStream</span><span class="w"> </span><span class="n">ois</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectInputStream</span><span class="p">(</span><span class="n">bis</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="n">deserializedDto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TokenUserInfoDto</span><span class="p">)</span><span class="w"> </span><span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="3-其他代码说明">3. 其他代码说明
</h3><ul>
<li>字段含义：
<ul>
<li>userId：用户唯一标识。</li>
<li>nickName：用户昵称。</li>
<li>avatar：用户头像 URL。</li>
<li>expireAt：令牌过期时间（时间戳）。</li>
<li>token：用户认证令牌（如 JWT）。</li>
</ul>
</li>
<li>Getter/Setter：提供标准的 Java Bean 方法，便于框架（如 Spring、Jackson）通过反射访问字段。</li>
</ul>
<hr>
<h3 id="总结-1">总结
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>作用</th>
          <th>使用场景</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>@JsonIgnoreProperties(ignoreUnknown = true)</td>
          <td>忽略 JSON 中的未知字段</td>
          <td>防止前端多传字段导致反序列化失败</td>
      </tr>
      <tr>
          <td>implements Serializable</td>
          <td>支持对象序列化</td>
          <td>网络传输、缓存存储、RPC 调用</td>
      </tr>
      <tr>
          <td>serialVersionUID</td>
          <td>版本控制</td>
          <td>确保序列化兼容性</td>
      </tr>
  </tbody>
</table></div>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>该 DTO 可能用于用户登录后返回的令牌信息（通过 JSON 响应给前端）。</li>
<li>也可能被序列化后存入 Redis（作为缓存或分布式会话）。</li>
</ul>
<h2 id="服务端操作-cookie-的完整流程结合案例解析">服务端操作 Cookie 的完整流程（结合案例解析）
</h2><p>以下通过 saveToken2Cookie 方法说明服务端如何通过 HttpServletResponse 操作 Cookie，并附上完整案例和关键点解析。</p>
<h3 id="1-代码逐行解析">1. 代码逐行解析
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveToken2Cookie</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 创建一个新的 Cookie 对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_WEB</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 设置 Cookie 过期时间（7天）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setMaxAge</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TIME_SECONDS_DAY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">7</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 设置 Cookie 的生效路径（根路径，全站有效）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setPath</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 4. 将 Cookie 添加到响应中（通过 Set-Cookie 头发给浏览器）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">response</span><span class="p">.</span><span class="na">addCookie</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-关键操作说明">2. 关键操作说明
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>操作</th>
          <th>作用</th>
          <th>对应 HTTP 协议行为</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>new Cookie(name, value)</td>
          <td>创建 Cookie</td>
          <td>无（仅内存对象）</td>
      </tr>
      <tr>
          <td>setMaxAge(seconds)</td>
          <td>设置 Cookie 有效期</td>
          <td>Set-Cookie: token=abc; Max-Age=604800</td>
      </tr>
      <tr>
          <td>setPath(&quot;/&quot;)</td>
          <td>设置 Cookie 的作用路径</td>
          <td>Set-Cookie: token=abc; Path=/</td>
      </tr>
      <tr>
          <td>response.addCookie()</td>
          <td>将 Cookie 写入响应</td>
          <td>浏览器收到后自动保存</td>
      </tr>
  </tbody>
</table></div>
<h3 id="3-完整案例场景">3. 完整案例场景
</h3><p><strong>场景描述</strong></p>
<ul>
<li>需求：用户登录成功后，服务端生成一个身份令牌（Token），并通过 Cookie 自动保存到浏览器。</li>
<li>技术实现：调用 saveToken2Cookie 方法。</li>
</ul>
<p><strong>代码示例（Spring MVC Controller）</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&#34;/login&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 验证用户名密码（伪代码）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isValid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">checkLogin</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isValid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;登录失败&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 生成 Token（伪代码）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtUtil</span><span class="p">.</span><span class="na">generateToken</span><span class="p">(</span><span class="n">username</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 将 Token 保存到 Cookie（关键操作！）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">saveToken2Cookie</span><span class="p">(</span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;登录成功&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 复用之前的 Cookie 操作方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveToken2Cookie</span><span class="p">(</span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s">&#34;AUTH_TOKEN&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setMaxAge</span><span class="p">(</span><span class="n">7</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">60</span><span class="p">);</span><span class="w"> </span><span class="c1">// 7天有效期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setPath</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 全站有效</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cookie</span><span class="p">.</span><span class="na">setHttpOnly</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// 防止 XSS 攻击（可选）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">response</span><span class="p">.</span><span class="na">addCookie</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-浏览器与服务器的交互流程">4. 浏览器与服务器的交互流程
</h3><p><strong>请求登录：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">POST /login HTTP/1.1
</span></span><span class="line"><span class="cl">Content-Type: application/x-www-form-urlencoded
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">username=admin&amp;password=123456
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>服务端响应（设置 Cookie）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">HTTP/1.1 200 OK
</span></span><span class="line"><span class="cl">Set-Cookie: AUTH_TOKEN=xyz123; Max-Age=604800; Path=/; HttpOnly
</span></span><span class="line"><span class="cl">Content-Type: text/html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">登录成功
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>后续请求（浏览器自动携带 Cookie）：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GET /profile HTTP/1.1
</span></span><span class="line"><span class="cl">Cookie: AUTH_TOKEN=xyz123
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5-关键注意事项">5. 关键注意事项
</h3><p><strong>(1) Cookie 安全性</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>配置</th>
          <th>作用</th>
          <th>推荐值</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>setHttpOnly(true)</td>
          <td>禁止 JavaScript 读取 Cookie</td>
          <td>必须启用</td>
      </tr>
      <tr>
          <td>setSecure(true)</td>
          <td>仅通过 HTTPS 传输</td>
          <td>生产环境启用</td>
      </tr>
      <tr>
          <td>setDomain(&ldquo;example.com&rdquo;)</td>
          <td>限制 Cookie 的作用域名</td>
          <td>按需设置</td>
      </tr>
  </tbody>
</table></div>
<p><strong>(2) 其他常见操作</strong></p>
<ul>
<li>删除 Cookie：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Cookie</span><span class="p">(</span><span class="s">&#34;AUTH_TOKEN&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">cookie</span><span class="p">.</span><span class="na">setMaxAge</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// 立即过期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">response</span><span class="p">.</span><span class="na">addCookie</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>读取客户端 Cookie：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Cookie</span><span class="o">[]</span><span class="w"> </span><span class="n">cookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getCookies</span><span class="p">();</span><span class="w"> </span><span class="c1">// 从 HttpServletRequest 获取</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="6-总结-1">6. 总结
</h3><ul>
<li>服务端操作 Cookie 的核心步骤：
<ol>
<li>创建 <code>Cookie</code> 对象 → 2. 设置属性 → 3. 通过 <code>response.addCookie()</code> 下发。</li>
</ol>
</li>
<li><strong>实际应用场景</strong>：用户认证（Token）、会话管理、个性化设置等。</li>
<li><strong>安全建议</strong>：始终启用 HttpOnly 和 Secure（HTTPS 环境下）。</li>
</ul>
<p>通过这种方式，服务端可以轻松管理浏览器端的持久化数据！</p>
<hr>
<h2 id="appinterceptor-和-webappconfigurer-基于-token-的请求拦截验证机制">AppInterceptor 和 WebAppConfigurer 基于 Token 的请求拦截验证机制
</h2><p>这两个类共同实现了一个基于 Token 的请求拦截验证机制，主要用于用户身份认证和权限控制。以下是详细解析：</p>
<h3 id="1-appinterceptor核心拦截器类">1. AppInterceptor（核心拦截器类）
</h3><p><strong>类作用</strong></p>
<ul>
<li>实现 HandlerInterceptor 接口，对符合条件的请求进行拦截。</li>
<li>主要功能：验证请求中的 Token 是否有效（从 Header 或 Cookie 获取），无效则拒绝访问。</li>
</ul>
<p><strong>关键代码解析</strong></p>
<p>(1) 成员变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">URL_ACCOUNT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/account&#34;</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">URL_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/file&#34;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作用：定义不需要 Token 验证的白名单路径（如登录、文件公开访问）。</li>
</ul>
<p>(2) preHandle() 方法（核心逻辑）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 检查 handler 是否有效</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// 直接拒绝</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 只处理 HandlerMethod 类型请求（如 @Controller 或 @RestController 定义的处理器方法,Spring 管理的控制器方法）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">handler</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">HandlerMethod</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// 其他类型（如静态资源）直接放行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 白名单路径放行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getRequestURI</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">URL_ACCOUNT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// 如登录接口无需 Token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 4. 获取 Token（优先从 Header，文件请求从 Cookie）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_ADMIN</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getRequestURI</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">URL_FILE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTokenFromCookie</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w"> </span><span class="c1">// 文件请求特殊处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 5. Token 为空或无效时抛出异常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringTools</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">token</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_901</span><span class="p">);</span><span class="w"> </span><span class="c1">// Token 缺失</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">sessionObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getTokenInfo4Admin</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sessionObj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_901</span><span class="p">);</span><span class="w"> </span><span class="c1">// Token 无效</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// 验证通过</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>(3) getTokenFromCookie() 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getTokenFromCookie</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Cookie</span><span class="o">[]</span><span class="w"> </span><span class="n">cookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getCookies</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cookies</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Cookie</span><span class="w"> </span><span class="n">cookie</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">cookies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cookie</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_ADMIN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">cookie</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span><span class="w"> </span><span class="c1">// 返回匹配的 Token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作用：从 Cookie 中提取 Token（用于文件请求等特殊场景）。</li>
</ul>
<p>(4) 其他方法</p>
<ul>
<li>postHandle() 和 afterCompletion()：空实现，用于拦截后处理（如日志记录），当前未使用。</li>
</ul>
<hr>
<h3 id="2-webappconfigurer拦截器配置类">2. WebAppConfigurer（拦截器配置类）
</h3><p><strong>类作用</strong></p>
<ul>
<li>实现 WebMvcConfigurer 接口，注册拦截器并配置拦截规则。</li>
<li>核心功能：将 AppInterceptor 应用到所有请求路径（/**）。</li>
</ul>
<p><strong>关键代码解析</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebAppConfigurer</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">WebMvcConfigurer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">AppInterceptor</span><span class="w"> </span><span class="n">appInterceptor</span><span class="p">;</span><span class="w"> </span><span class="c1">// 注入拦截器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addInterceptors</span><span class="p">(</span><span class="n">InterceptorRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">addInterceptor</span><span class="p">(</span><span class="n">appInterceptor</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">               </span><span class="p">.</span><span class="na">addPathPatterns</span><span class="p">(</span><span class="s">&#34;/**&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 拦截所有路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>addPathPatterns(&quot;/<strong>&quot;)：表示拦截所有请求（可通过 excludePathPatterns() 排除特定路径，如 /api/public/</strong>）。</li>
</ul>
<hr>
<h3 id="3-协作流程">3. 协作流程
</h3><ul>
<li>请求到达 Spring MVC → 先经过 WebAppConfigurer 注册的 AppInterceptor。</li>
<li>拦截器验证逻辑：
<ul>
<li>白名单放行：如 /account/login 直接通过。</li>
<li>Token 检查：
<ul>
<li>普通请求从 Header 的 TOKEN_ADMIN 获取 Token。</li>
<li>文件请求（/file/**）从 Cookie 获取 Token。</li>
</ul>
</li>
<li>Redis 验证：检查 Token 是否有效（如是否过期或被踢出）。</li>
</ul>
</li>
<li>验证结果处理：
<ul>
<li>成功：继续执行后续拦截器或 Controller。</li>
<li>失败：抛出 BusinessException（最终会被全局异常处理器转换为错误响应）。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-设计亮点">4. 设计亮点
</h3><ul>
<li>灵活 Token 获取：支持 Header 和 Cookie 两种方式，适应不同场景（如 API 调用和浏览器文件下载）。</li>
<li>白名单机制：公开接口（如登录）无需 Token，避免循环验证。</li>
<li>Redis 集中管理：Token 状态（如有效期、强制失效）由 Redis 控制，实现分布式会话。</li>
</ul>
<hr>
<h3 id="5-典型应用场景">5. 典型应用场景
</h3><ul>
<li>用户登录态校验：访问 /admin/* 时要求携带有效 Token。</li>
<li>文件安全下载：文件接口（/file/*）通过 Cookie 传递 Token，确保只有登录用户可访问。</li>
<li>权限控制扩展：可在 preHandle() 中进一步检查用户角色（如从 sessionObj 解析权限）。</li>
</ul>
<hr>
<h3 id="总结-2">总结
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>类名</th>
          <th>职责</th>
          <th>核心方法</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>AppInterceptor</td>
          <td>拦截请求并验证 Token</td>
          <td>preHandle()</td>
      </tr>
      <tr>
          <td>WebAppConfigurer</td>
          <td>注册拦截器到 Spring MVC</td>
          <td>addInterceptors()</td>
      </tr>
  </tbody>
</table></div>
<p>通过这两个类，系统实现了统一、可扩展的认证层，确保只有合法请求能访问受保护资源。</p>
<hr>
<h2 id="为什么文件请求和其他请求分开处理-token-的获取方式">为什么文件请求和其他请求分开处理 Token 的获取方式？
</h2><h3 id="1-技术限制浏览器对文件请求的-header-处理">1. 技术限制：浏览器对文件请求的 Header 处理
</h3><p><strong>(1) 普通 API 请求（使用 Header 传递 Token）</strong></p>
<ul>
<li>场景：前后端分离架构中，前端（如 Vue/React）通过 AJAX/Fetch 调用 API。</li>
<li>Token 传递方式：通过 HTTP 请求头（如 Authorization: Bearer 或自定义头 TOKEN_ADMIN）传递。</li>
<li>优势：
<ul>
<li>安全性高：Header 不会被浏览器自动缓存或记录在日志中。</li>
<li>适合 RESTful API：符合无状态认证的最佳实践。</li>
</ul>
</li>
</ul>
<p><strong>(2) 文件请求（使用 Cookie 传递 Token）</strong></p>
<ul>
<li>场景：浏览器直接访问文件下载链接（如 <a> 或 <img> 标签）。</li>
<li>问题：
<ul>
<li>浏览器在发起非 AJAX 的文件请求（如直接访问 URL、<a>、<img> 标签）时：
<ul>
<li>无法自定义 Header：浏览器不会允许通过普通 HTML 标签或跳转设置自定义头。</li>
<li>自动携带 Cookie：浏览器会自动在请求中附加当前域的 Cookie（如果 Cookie 的 Path 和 Domain 匹配）。</li>
</ul>
</li>
</ul>
</li>
<li>解决方案：
<ul>
<li>对于文件请求，改用 Cookie 传递 Token，因为：
<ul>
<li>浏览器会自动管理 Cookie 的发送。</li>
<li>无需前端代码显式设置 Header。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-实际应用场景示例">2. 实际应用场景示例
</h3><p><strong>(1) 普通 API 请求</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// 前端调用 API（可自定义 Header）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">fetch</span><span class="p">(</span><span class="s2">&#34;/api/data&#34;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&#34;TOKEN_ADMIN&#34;</span><span class="o">:</span> <span class="s2">&#34;xyz123&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>服务端：从 Header 提取 Token。</li>
</ul>
<p><strong>(2) 文件下载请求</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="c">&lt;!-- 浏览器直接访问文件链接 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;/file/123.pdf&#34;</span><span class="p">&gt;</span>下载PDF<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- 或图片加载 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;/file/456.jpg&#34;</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>服务端：从 Cookie 提取 Token（因为浏览器不会为这些请求设置自定义 Header）。</li>
</ul>
<h2 id="savecategory-方法中的-if-判断对应增加和修改详解">saveCategory 方法中的 if 判断（对应增加和修改）详解
</h2><p>这个判断逻辑用于防止分类编号（categoryCode）重复，覆盖了两种业务场景：新增分类时检查编号是否已存在，修改分类时检查编号是否被其他分类占用。</p>
<h3 id="1-判断条件分解">1. 判断条件分解
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 场景1：新增时发现分类编号已存在</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dbBean</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">||</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 场景2：修改时发现分类编号被其他分类占用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">bean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dbBean</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">dbBean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;分类编号已经存在&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-场景1新增分类时的检查">2. 场景1：新增分类时的检查
</h3><ul>
<li>条件：<code>bean.getCategoryId() == null &amp;&amp; null != dbBean</code></li>
<li>逻辑：当前操作是新增分类（categoryId 尚未生成），dbBean 非空说明该 categoryCode 已被其他分类占用。</li>
<li>示例：用户尝试新增 categoryCode = &ldquo;ELECTRONICS&rdquo;，但数据库已存在该编号，抛出异常。</li>
</ul>
<h3 id="3-场景2修改分类时的检查">3. 场景2：修改分类时的检查
</h3><ul>
<li>条件：<code>bean.getCategoryId() != null &amp;&amp; dbBean != null &amp;&amp; !bean.getCategoryId().equals(dbBean.getCategoryId())</code></li>
<li>逻辑：当前操作是修改已有分类，且数据库中存在与 categoryCode 匹配的分类，但不是当前分类本身，说明编号被其他分类占用。</li>
<li>示例：用户尝试将 categoryId = 1 的分类编号改为已被 categoryId = 2 占用的编号，抛出异常。</li>
</ul>
<h3 id="4-为什么需要两个场景分开判断">4. 为什么需要两个场景分开判断？
</h3><ul>
<li>新增时只需检查 categoryCode 是否存在。</li>
<li>修改时需额外检查 categoryCode 是否被其他分类占用（允许修改为自己的原值）。</li>
</ul>
<h3 id="5-逻辑优化建议">5. 逻辑优化建议
</h3><p><strong>更清晰的写法：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">boolean</span><span class="w"> </span><span class="n">isAdd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">isUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">isAdd</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isAdd</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dbBean</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;分类编号已存在&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isUpdate</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dbBean</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">dbBean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;分类编号已被其他分类使用&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>提前返回减少嵌套：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dbBean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 无冲突，直接继续后续逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;分类编号已存在&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">dbBean</span><span class="p">.</span><span class="na">getCategoryId</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;分类编号已被其他分类使用&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="6-总结-2">6. 总结
</h3><ul>
<li>目的：确保分类编号的唯一性，避免数据冲突。</li>
<li>新增时：禁止使用已存在的 categoryCode。</li>
<li>修改时：禁止将 categoryCode 改为其他分类的编号。</li>
<li>关键技巧：通过 categoryId 是否为 null 区分操作类型，结合查询结果 dbBean 判断冲突。</li>
</ul>
<hr>
<h2 id="filetransfertonew-filefilepath-代码解析">file.transferTo(new File(filePath)) 代码解析
</h2><p><strong>作用</strong></p>
<ul>
<li>这行代码是将客户端上传的 MultipartFile 文件保存到服务器的指定路径。</li>
<li>file：Spring MVC 接收到的上传文件对象（MultipartFile 类型）。</li>
<li>transferTo()：将文件内容从内存或临时目录永久保存到目标路径。</li>
<li>new File(filePath)：指定文件在服务器上的存储位置（绝对路径）。</li>
</ul>
<h3 id="详细执行流程">详细执行流程
</h3><ol>
<li><strong>文件接收</strong>：用户通过 HTTP 请求上传文件，Spring MVC 将其封装为 MultipartFile 对象。</li>
<li><strong>路径准备</strong>：代码中通过 folder 和 realFileName 拼接出完整的存储路径，确保目标目录存在（通过 mkdirs() 创建）。</li>
<li><strong>文件保存</strong>：transferTo() 方法将文件流写入到 filePath 对应的物理文件中。</li>
</ol>
<h3 id="关键注意事项">关键注意事项
</h3><ul>
<li><strong>文件覆盖风险</strong>：filePath 已存在同名文件会被覆盖，建议追加随机字符串或时间戳避免冲突。</li>
<li><strong>异常处理</strong>：transferTo() 可能抛出 IOException，需捕获异常并返回友好提示。</li>
<li><strong>性能优化</strong>：大文件上传建议分块或异步处理，避免阻塞请求线程。</li>
</ul>
<h3 id="示例完整安全版代码">示例：完整安全版代码
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/uploadImage&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseVO</span><span class="w"> </span><span class="nf">uploadImage</span><span class="p">(</span><span class="nd">@NotNull</span><span class="w"> </span><span class="n">MultipartFile</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="nd">@NotNull</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">createThumbnail</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;上传文件不能为空&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateUtil</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;yyyyMM&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">folder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appConfig</span><span class="p">.</span><span class="na">getProjectFolder</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;/upload/cover/&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">month</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">File</span><span class="w"> </span><span class="n">folderFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">folder</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">folderFile</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">folderFile</span><span class="p">.</span><span class="na">mkdirs</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">originalName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="na">getOriginalFilename</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">suffix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalName</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">originalName</span><span class="p">.</span><span class="na">lastIndexOf</span><span class="p">(</span><span class="s">&#34;.&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">newFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">suffix</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">folder</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;/&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newFileName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">file</span><span class="p">.</span><span class="na">transferTo</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">filePath</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;文件保存失败: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">createThumbnail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fFmpegUtils</span><span class="p">.</span><span class="na">createImageThumbnail</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getSuccessResponseVO</span><span class="p">(</span><span class="s">&#34;/upload/cover/&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;/&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newFileName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="常见问题解答">常见问题解答
</h3><ul>
<li><strong>为什么不用 file.getBytes() 再手动写入？</strong> transferTo() 已优化文件流处理，直接操作文件系统，更高效。</li>
<li><strong>文件保存后如何让外部访问？</strong> 返回相对路径，配合静态资源映射。</li>
</ul>
<hr>
<h2 id="分片上传视频文件-uploadvideo-方法详解">分片上传视频文件 uploadVideo 方法详解
</h2><p>该方法实现了分片上传视频文件的功能，主要用于处理大文件上传。以下是逐行解析：</p>
<h3 id="1-方法签名">1. 方法签名
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/uploadVideo&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@GlobalInterceptor</span><span class="p">(</span><span class="n">checkLogin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseVO</span><span class="w"> </span><span class="nf">uploadVideo</span><span class="p">(</span><span class="nd">@NotNull</span><span class="w"> </span><span class="n">MultipartFile</span><span class="w"> </span><span class="n">chunkFile</span><span class="p">,</span><span class="w"> </span><span class="nd">@NotNull</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">chunkIndex</span><span class="p">,</span><span class="w"> </span><span class="nd">@NotEmpty</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">uploadId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>chunkFile：当前上传的文件分片。</li>
<li>chunkIndex：当前分片的索引。</li>
<li>uploadId：本次上传的唯一标识。</li>
</ul>
<h3 id="2-用户身份验证">2. 用户身份验证
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="n">tokenUserInfoDto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTokenUserInfoDto</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>从请求头或 Cookie 获取当前登录用户的信息。</li>
</ul>
<h3 id="3-检查上传任务是否存在">3. 检查上传任务是否存在
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">UploadingFileDto</span><span class="w"> </span><span class="n">fileDto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getUploadVideoFile</span><span class="p">(</span><span class="n">tokenUserInfoDto</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">uploadId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fileDto</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;文件不存在请重新上传&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Redis 中没有找到对应的上传任务，需重新上传。</li>
</ul>
<h3 id="4-检查文件大小限制">4. 检查文件大小限制
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">SysSettingDto</span><span class="w"> </span><span class="n">sysSettingDto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getSysSettingDto</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fileDto</span><span class="p">.</span><span class="na">getFileSize</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">sysSettingDto</span><span class="p">.</span><span class="na">getVideoSize</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">MB_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;文件超过最大文件限制&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>超过系统允许的最大视频文件大小则拒绝。</li>
</ul>
<h3 id="5-检查分片序号合法性">5. 检查分片序号合法性
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">chunkIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">fileDto</span><span class="p">.</span><span class="na">getChunkIndex</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">chunkIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">fileDto</span><span class="p">.</span><span class="na">getChunks</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_600</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>防止乱序上传或恶意传超出范围的分片。</li>
</ul>
<h3 id="6-保存分片文件">6. 保存分片文件
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">folder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appConfig</span><span class="p">.</span><span class="na">getProjectFolder</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_FOLDER</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_FOLDER_TEMP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fileDto</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">File</span><span class="w"> </span><span class="n">targetFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">folder</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;/&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">chunkIndex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">chunkFile</span><span class="p">.</span><span class="na">transferTo</span><span class="p">(</span><span class="n">targetFile</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>分片文件保存到临时目录。</li>
</ul>
<h3 id="7-更新上传进度">7. 更新上传进度
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">fileDto</span><span class="p">.</span><span class="na">setChunkIndex</span><span class="p">(</span><span class="n">chunkIndex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">fileDto</span><span class="p">.</span><span class="na">setFileSize</span><span class="p">(</span><span class="n">fileDto</span><span class="p">.</span><span class="na">getFileSize</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">chunkFile</span><span class="p">.</span><span class="na">getSize</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">redisComponent</span><span class="p">.</span><span class="na">updateVideoFileInfo</span><span class="p">(</span><span class="n">tokenUserInfoDto</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">fileDto</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>记录当前上传进度，确保断点续传。</li>
</ul>
<h3 id="8-返回成功响应">8. 返回成功响应
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">return</span><span class="w"> </span><span class="n">getSuccessResponseVO</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>表示当前分片上传成功。</li>
</ul>
<h3 id="完整流程总结">完整流程总结
</h3><ul>
<li>客户端将大文件切分为多个分片，依次上传。</li>
<li>服务端检查分片顺序、大小限制，保存分片到临时目录，更新 Redis 上传进度。</li>
<li>所有分片上传完成后，调用合并接口将临时文件拼接为完整视频。</li>
</ul>
<h3 id="优化建议">优化建议
</h3><ul>
<li>断点续传、分片校验、清理临时文件、并发控制。</li>
<li>适用场景：视频网站、云存储服务、大文件上传。</li>
</ul>
<hr>
<h2 id="savevideoinfo-方法详细解析">saveVideoInfo 方法详细解析
</h2><p>saveVideoInfo 方法用于保存视频信息及其关联文件，处理视频信息的创建、更新以及文件管理。</p>
<h3 id="1-方法概述">1. 方法概述
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">rollbackFor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveVideoInfo</span><span class="p">(</span><span class="n">VideoInfoPost</span><span class="w"> </span><span class="n">videoInfoPost</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>@Transactional：遇到任何异常都会回滚。</li>
<li>videoInfoPost：视频主信息。</li>
<li>uploadFileList：视频关联的文件列表。</li>
</ul>
<h3 id="2-分p数校验">2. 分P数校验
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uploadFileList</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getSysSettingDto</span><span class="p">().</span><span class="na">getVideoPCount</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_600</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>检查上传的视频分P数是否超过系统设置的最大限制。</li>
</ul>
<h3 id="3-视频id存在性校验">3. 视频ID存在性校验
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">StringTools</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">())){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">VideoInfoPost</span><span class="w"> </span><span class="n">videoInfoPostDb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoPostMapper</span><span class="p">.</span><span class="na">selectByVideoId</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">videoInfoPostDb</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_600</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ArrayUtils</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Integer</span><span class="o">[]</span><span class="p">{</span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS0</span><span class="p">.</span><span class="na">getStatus</span><span class="p">(),</span><span class="w"> </span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS2</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()},</span><span class="w"> </span><span class="n">videoInfoPostDb</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_600</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>检查视频是否存在及状态是否允许修改。</li>
</ul>
<h3 id="4-初始化变量">4. 初始化变量
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Date</span><span class="w"> </span><span class="n">curDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deleteFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>curDate：当前时间。</li>
<li>videoId：视频ID。</li>
<li>deleteFileList：待删除的文件列表。</li>
<li>addFileList：待添加的文件列表。</li>
</ul>
<h3 id="5-新增视频逻辑">5. 新增视频逻辑
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringTools</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">videoId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StringTools</span><span class="p">.</span><span class="na">getRandomString</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">LENGTH_10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">setCreateTime</span><span class="p">(</span><span class="n">curDate</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">setLastUpdateTime</span><span class="p">(</span><span class="n">curDate</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS0</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoPostMapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>videoId 为空表示新增视频。</li>
<li>生成随机 videoId，设置创建/更新时间、初始状态，插入数据库。</li>
</ul>
<h3 id="6-更新视频逻辑">6. 更新视频逻辑
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">VideoInfoFilePostQuery</span><span class="w"> </span><span class="n">fileQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePostQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">fileQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">fileQuery</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dbInfoFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">selectList</span><span class="p">(</span><span class="n">fileQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uploadFileMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toMap</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getUploadId</span><span class="p">(),</span><span class="w"> </span><span class="n">Function</span><span class="p">.</span><span class="na">identity</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">data1</span><span class="p">,</span><span class="w"> </span><span class="n">data2</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">data2</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Boolean</span><span class="w"> </span><span class="n">updateFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">fileInfo</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">dbInfoFileList</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">updateFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uploadFileMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">fileInfo</span><span class="p">.</span><span class="na">getUploadId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updateFile</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">deleteFileList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">fileInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">updateFile</span><span class="p">.</span><span class="na">getFileName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">fileInfo</span><span class="p">.</span><span class="na">getFileName</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">updateFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">.</span><span class="na">getFileId</span><span class="p">()</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">setLastUpdateTime</span><span class="p">(</span><span class="n">curDate</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Boolean</span><span class="w"> </span><span class="n">changeVideoInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">changeVideoInfo</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addFileList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">addFileList</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS0</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">changeVideoInfo</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">updateFileName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS2</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoPostMapper</span><span class="p">.</span><span class="na">updateByVideoId</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">,</span><span class="w"> </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>查询数据库中该视频已有的文件列表。</li>
<li>比较数据库文件和上传文件，识别新增、删除和修改的文件。</li>
<li>根据情况设置视频状态，更新主表信息。</li>
</ul>
<h3 id="7-处理待删除文件">7. 处理待删除文件
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">deleteFileList</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">delFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deleteFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">.</span><span class="na">getFileId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">deleteBatchByFileId</span><span class="p">(</span><span class="n">delFileList</span><span class="p">,</span><span class="w"> </span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">delFilePathList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deleteFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">addFile2DelQueue</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">delFilePathList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>批量删除数据库记录，将待删除文件路径加入 Redis 队列。</li>
</ul>
<h3 id="8-处理文件索引和新增文件">8. 处理文件索引和新增文件
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Integer</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">videoInfoFile</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoFile</span><span class="p">.</span><span class="na">setFileIndex</span><span class="p">(</span><span class="n">index</span><span class="o">++</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoFile</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoFile</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">videoInfoFile</span><span class="p">.</span><span class="na">getFileId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfoFile</span><span class="p">.</span><span class="na">setFileId</span><span class="p">(</span><span class="n">StringTools</span><span class="p">.</span><span class="na">getRandomString</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">LENGTH_20</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfoFile</span><span class="p">.</span><span class="na">setUpdateType</span><span class="p">(</span><span class="n">VideoFileUpdateTypeEnum</span><span class="p">.</span><span class="na">UPDATE</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfoFile</span><span class="p">.</span><span class="na">setTransferResult</span><span class="p">(</span><span class="n">VideoFileTransferResultEnum</span><span class="p">.</span><span class="na">TRANSFER</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">insertOrUpdateBatch</span><span class="p">(</span><span class="n">uploadFileList</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>为每个文件设置索引、视频ID、用户ID。</li>
<li>对新文件生成 fileId 并设置属性。</li>
<li>批量插入或更新文件表。</li>
</ul>
<h3 id="9-处理新增文件传输">9. 处理新增文件传输
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">addFileList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">addFileList</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">addFileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">file</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">file</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">addFile2TransferQueue</span><span class="p">(</span><span class="n">addFileList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>将新增文件加入传输队列（如转码、转存等异步处理）。</li>
</ul>
<h3 id="方法总结">方法总结
</h3><ul>
<li>参数校验：检查分P数限制、视频状态是否允许修改。</li>
<li>新增视频：生成ID、设置初始状态、插入数据库。</li>
<li>更新视频：比较新旧文件列表，识别新增、删除和修改的文件，根据修改情况设置视频状态，更新主信息。</li>
<li>文件处理：删除不再需要的文件记录和实际文件，为新增文件生成ID并设置属性，批量保存文件信息，将新增文件加入处理队列。</li>
<li>通过精细的状态管理和文件比较，实现了视频信息的完整保存流程，同时考虑了事务一致性和异步处理的需求。</li>
</ul>
<h2 id="savevideoinfo-方法中-stream-的详细用法解析">saveVideoInfo 方法中 stream() 的详细用法解析
</h2><p>在 saveVideoInfo 方法中，<code>stream()</code> 方法被多次用于对集合进行函数式操作。下面详细解析每个 stream() 的使用场景和实现逻辑。</p>
<h3 id="1-将上传文件列表转为-map">1. 将上传文件列表转为 Map
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uploadFileMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toMap</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getUploadId</span><span class="p">(),</span><span class="w">  </span><span class="c1">// Key 映射函数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Function</span><span class="p">.</span><span class="na">identity</span><span class="p">(),</span><span class="w">         </span><span class="c1">// Value 映射函数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="n">data1</span><span class="p">,</span><span class="w"> </span><span class="n">data2</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">data2</span><span class="w">      </span><span class="c1">// 合并函数（解决键冲突）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>目的：将 <code>List&lt;VideoInfoFilePost&gt;</code> 转换为 <code>Map&lt;String, VideoInfoFilePost&gt;</code>，以便通过 uploadId 快速查找文件。</li>
<li>分解：
<ol>
<li><code>uploadFileList.stream()</code> - 将列表转为流。</li>
<li><code>Collectors.toMap()</code> - 收集器，将流元素转为 Map。
<ul>
<li>第一个参数 <code>item -&gt; item.getUploadId()</code>：指定使用 uploadId 作为 Map 的键。</li>
<li>第二个参数 <code>Function.identity()</code>：使用元素本身作为 Map 的值。</li>
<li>第三个参数 <code>(data1, data2) -&gt; data2</code>：如果键冲突（相同 uploadId），保留后面的值。</li>
</ul>
</li>
</ol>
</li>
</ul>
<p><strong>等价传统写法：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uploadFileMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">uploadFileMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getUploadId</span><span class="p">(),</span><span class="w"> </span><span class="n">item</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="2-筛选新增文件">2. 筛选新增文件
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">addFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getFileId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>目的：从上传文件列表中筛选出新增的文件（fileId 为 null 的文件）。</li>
<li>分解：
<ol>
<li><code>uploadFileList.stream()</code> - 创建流。</li>
<li><code>.filter(item -&gt; item.getFileId() == null)</code> - 过滤条件。</li>
<li><code>.collect(Collectors.toList())</code> - 收集为 List。</li>
</ol>
</li>
</ul>
<p><strong>等价传统写法：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getFileId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">addFileList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">item</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="3-提取待删除文件的-id-列表">3. 提取待删除文件的 ID 列表
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">delFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deleteFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getFileId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>目的：从待删除文件列表中提取所有 fileId 组成新列表。</li>
<li>分解：
<ol>
<li><code>deleteFileList.stream()</code> - 创建流。</li>
<li><code>.map(item -&gt; item.getFileId())</code> - 映射转换，从对象中提取 fileId。</li>
<li><code>.collect(Collectors.toList())</code> - 收集为 List。</li>
</ol>
</li>
</ul>
<p><strong>等价传统写法：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">delFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">deleteFileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">delFileList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getFileId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="4-提取待删除文件的路径列表">4. 提取待删除文件的路径列表
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">delFilePathList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deleteFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>目的：从待删除文件列表中提取所有 filePath 组成新列表。</li>
<li>实现：与上一个例子类似，只是提取的是 filePath 而非 fileId。</li>
</ul>
<p><strong>等价传统写法：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">delFilePathList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">deleteFileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">delFilePathList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="stream-api-核心概念总结">Stream API 核心概念总结
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>操作类型</th>
          <th>方法</th>
          <th>说明</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>创建流</td>
          <td>stream()</td>
          <td>从集合创建流</td>
          <td>list.stream()</td>
      </tr>
      <tr>
          <td>中间操作</td>
          <td>filter()</td>
          <td>过滤元素</td>
          <td>.filter(x -&gt; x &gt; 0)</td>
      </tr>
      <tr>
          <td></td>
          <td>map()</td>
          <td>转换元素</td>
          <td>.map(x -&gt; x.getName())</td>
      </tr>
      <tr>
          <td>终止操作</td>
          <td>collect()</td>
          <td>收集结果</td>
          <td>.collect(Collectors.toList())</td>
      </tr>
      <tr>
          <td></td>
          <td>forEach()</td>
          <td>遍历元素</td>
          <td>.forEach(System.out::println)</td>
      </tr>
  </tbody>
</table></div>
<hr>
<h3 id="为什么使用-stream-api">为什么使用 Stream API？
</h3><ul>
<li><strong>代码简洁</strong>：用声明式的方式表达复杂的数据处理逻辑。</li>
<li><strong>可读性强</strong>：链式调用更直观表达数据处理流程。</li>
<li><strong>并行处理</strong>：只需将 stream() 改为 parallelStream() 即可实现并行。</li>
<li><strong>惰性求值</strong>：中间操作不会立即执行，提高效率。</li>
</ul>
<h3 id="性能考虑">性能考虑
</h3><p>虽然 Stream API 很强大，但在简单循环就能完成的任务中，传统 for 循环可能更高效。Stream 适合处理复杂的数据转换和过滤场景。</p>
<hr>
<h3 id="完整流程示例">完整流程示例
</h3><p>假设有以下数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uploadFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="p">(</span><span class="s">&#34;f1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;u1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;p1&#34;</span><span class="p">),</span><span class="w"> </span><span class="c1">// fileId 不为 null，视为已有文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;u2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;p2&#34;</span><span class="p">),</span><span class="w">   </span><span class="c1">// fileId 为 null，视为新增文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;u3&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;p3&#34;</span><span class="p">)</span><span class="w">    </span><span class="c1">// fileId 为 null，视为新增文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uploadFileList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getFileId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">addFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">VideoInfoFilePost</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;u2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;p2&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">VideoInfoFilePost</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;u3&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;p3&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过 Stream API，我们简洁地实现了数据筛选和转换，代码更加清晰易读。</p>
<h2 id="mybatis-批量插入或更新语句-insertorupdatebatch-解析">MyBatis 批量插入或更新语句 insertOrUpdateBatch 解析
</h2><p>这段代码是一个 MyBatis 的 Mapper XML 配置，实现了批量插入或更新视频文件信息的功能。下面详细解析这个 SQL 语句的各个部分：</p>
<h3 id="1-基本结构">1. 基本结构
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&#34;insertOrUpdateBatch&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;com.easylive.entity.po.VideoInfoFilePost&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    INSERT INTO video_info_file_post(...) VALUES (...)
</span></span><span class="line"><span class="cl">    ON DUPLICATE KEY UPDATE ...
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/insert&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这是一个典型的 MyBatis 批量操作语句，使用了 MySQL 的 <code>INSERT ... ON DUPLICATE KEY UPDATE</code> 语法。</li>
</ul>
<h3 id="2-插入部分详解">2. 插入部分详解
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">INSERT INTO video_info_file_post(
</span></span><span class="line"><span class="cl">    file_id,
</span></span><span class="line"><span class="cl">    upload_id,
</span></span><span class="line"><span class="cl">    user_id,
</span></span><span class="line"><span class="cl">    video_id,
</span></span><span class="line"><span class="cl">    file_index,
</span></span><span class="line"><span class="cl">    file_name,
</span></span><span class="line"><span class="cl">    file_size,
</span></span><span class="line"><span class="cl">    file_path,
</span></span><span class="line"><span class="cl">    update_type,
</span></span><span class="line"><span class="cl">    transfer_result,
</span></span><span class="line"><span class="cl">    duration
</span></span><span class="line"><span class="cl">) VALUES
</span></span><span class="line"><span class="cl"><span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&#34;list&#34;</span> <span class="na">item=</span><span class="s">&#34;item&#34;</span> <span class="na">separator=</span><span class="s">&#34;,&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    (
</span></span><span class="line"><span class="cl">    #{item.fileId},
</span></span><span class="line"><span class="cl">    #{item.uploadId},
</span></span><span class="line"><span class="cl">    #{item.userId},
</span></span><span class="line"><span class="cl">    #{item.videoId},
</span></span><span class="line"><span class="cl">    #{item.fileIndex},
</span></span><span class="line"><span class="cl">    #{item.fileName},
</span></span><span class="line"><span class="cl">    #{item.fileSize},
</span></span><span class="line"><span class="cl">    #{item.filePath},
</span></span><span class="line"><span class="cl">    #{item.updateType},
</span></span><span class="line"><span class="cl">    #{item.transferResult},
</span></span><span class="line"><span class="cl">    #{item.duration}
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/foreach&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>关键点：</strong></p>
<ul>
<li><code>&lt;foreach&gt;</code> 标签：MyBatis 的循环标签，用于处理集合</li>
<li><code>collection=&quot;list&quot;</code>：表示参数是一个 List 集合</li>
<li><code>item=&quot;item&quot;</code>：定义循环变量名</li>
<li><code>separator=&quot;,&quot;</code>：每次循环后用逗号分隔</li>
<li><code>#{}</code> 表达式：MyBatis 的参数占位符，会预编译防止 SQL 注入</li>
<li>使用 <code>item.属性名</code> 访问集合元素的属性</li>
</ul>
<h3 id="3-冲突更新部分详解">3. 冲突更新部分详解
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">ON DUPLICATE KEY UPDATE
</span></span><span class="line"><span class="cl">file_index = VALUES(file_index),
</span></span><span class="line"><span class="cl">file_name = VALUES(file_name)
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>关键点：</strong></p>
<ul>
<li><code>ON DUPLICATE KEY UPDATE</code>：MySQL 特有语法，当主键或唯一键冲突时执行更新</li>
<li><code>VALUES()</code> 函数：引用 INSERT 语句中尝试插入的值</li>
<li>这里只更新了 file_index 和 file_name 两个字段，其他字段保持不变</li>
</ul>
<h3 id="4-完整逻辑流程">4. 完整逻辑流程
</h3><ul>
<li>尝试批量插入多条记录到 video_info_file_post 表</li>
<li>如果某条记录的 file_id（假设是主键）已存在，则执行更新操作</li>
<li>更新时只修改 file_index 和 file_name 字段</li>
<li>其他字段保持原值不变</li>
</ul>
<h3 id="5-实际执行示例">5. 实际执行示例
</h3><p>假设传入的 List 包含两个元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="p">(</span><span class="s">&#34;id1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;up1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;user1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;vid1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;name1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">100</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;path1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">100</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="p">(</span><span class="s">&#34;id2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;up2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;user1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;vid1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;name2&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">200</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;path2&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">200</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>生成的 SQL 语句类似：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">video_info_file_post</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">file_id</span><span class="p">,</span><span class="w"> </span><span class="n">upload_id</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">video_id</span><span class="p">,</span><span class="w"> </span><span class="n">file_index</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">file_size</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="n">update_type</span><span class="p">,</span><span class="w"> </span><span class="n">transfer_result</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="s1">&#39;id1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;up1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;vid1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;path1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="s1">&#39;id2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;up2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;vid1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name2&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;path2&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">DUPLICATE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">UPDATE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">file_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="n">file_index</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="6-设计考虑">6. 设计考虑
</h3><ul>
<li><strong>性能优化</strong>：批量操作减少数据库往返次数</li>
<li><strong>原子性</strong>：整个操作在一个事务中完成</li>
<li><strong>灵活性</strong>：只更新需要变更的字段</li>
<li><strong>幂等性</strong>：重复执行不会产生副作用</li>
</ul>
<h3 id="7-使用场景">7. 使用场景
</h3><p>这种批量插入或更新操作特别适合：</p>
<ul>
<li>初始化数据</li>
<li>批量导入</li>
<li>数据同步</li>
<li>需要处理大量记录的定时任务</li>
</ul>
<h3 id="8-注意事项">8. 注意事项
</h3><ul>
<li>确保表有主键或唯一键约束，否则 <code>ON DUPLICATE KEY UPDATE</code> 不会生效</li>
<li>大批量操作时可能需要分批处理，避免单条 SQL 过大</li>
<li>在高并发环境下注意锁竞争问题</li>
</ul>
<hr>
<h2 id="transfervideofile-方法详细解析">transferVideoFile 方法详细解析
</h2><p>transferVideoFile 方法是一个视频文件转码和处理的核心方法，主要完成视频文件从临时目录转移到正式目录、合并分片、获取视频信息、更新状态等一系列操作。下面详细解析这个方法的每个部分。<br>
      首先，方法被@Override注解标记，说明这是一个重写的方法。方法接收一个VideoInfoFilePost对象作为参数，这应该是一个包含视频文件相关信息的实体类。方法内部首先创建了一个updateFilePost对象，用于后续更新数据库中的文件信息。接着进入一个try块，开始主要的业务逻辑。
在try块中，首先通过redisComponent.getUploadVideoFile方法从Redis获取上传文件的信息，这里需要传入用户ID和上传ID。这表明系统使用Redis来临时存储上传过程中的文件信息，可能是为了支持断点续传或分片上传。
接下来，构建了临时文件路径tempFilePath和目标文件路径targetFilePath。这里用到了appConfig.getProjectFolder()获取项目根目录，然后拼接上常量FILE_FOLDER、FILE_FOLDER_TEMP和FILE_VIDEO，以及从Redis获取的fileDto.getFilePath()。这说明系统有明确的目录结构来管理临时文件和最终存储的视频文件。
检查目标目录是否存在，如果不存在则创建，确保目录结构正确。然后使用FileUtils.copyDirectory将临时目录下的文件复制到目标目录。这一步可能是将上传完成的文件从临时位置移动到正式存储位置。之后，删除临时目录，释放存储空间，并从Redis中删除对应的文件信息，避免数据冗余。
接下来调用this.union方法合并文件，生成完整的视频文件路径completeVideo。union方法可能负责将分片上传的视频文件合并成一个完整的文件。合并完成后，使用fFmpegUtils.getVideoInfoDuration获取视频时长，并更新updateFilePost的相关属性，包括时长、文件大小、文件路径和转码结果状态为成功。
然后调用this.convertVideo2Ts方法将视频转换为TS格式，可能是为了支持流媒体播放，比如HLS协议。转换完成后删除原始视频文件，保留转换后的TS分片。
如果在上述过程中出现异常，catch块会捕获异常并记录错误日志，同时将转码结果状态设置为失败。无论成功或失败，finally块都会执行，更新数据库中的文件状态。
在finally块中，首先通过videoInfoFilePostMapper.updateByUploadIdAndUserId更新文件信息。接着，构建查询条件，检查是否存在转码失败的文件。如果有失败的文件，更新整个视频的状态为STATUS1（可能表示转码失败）。如果没有失败的文件，再检查是否还有正在转码中的文件。如果所有文件都已处理完成，计算视频总时长并更新视频状态为STATUS2（转码完成），同时记录总时长。</p>
<h3 id="方法概述">方法概述
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transferVideoFile</span><span class="p">(</span><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">videoInfoFilePost</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 方法实现</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>功能：</strong> 处理视频文件转码和转移流程，包括：</p>
<ul>
<li>从临时目录转移视频到正式目录</li>
<li>合并视频分片（如果有）</li>
<li>获取视频元信息（时长等）</li>
<li>更新数据库状态</li>
<li>处理转码失败情况</li>
<li>检查并更新视频整体状态</li>
</ul>
<h3 id="1-初始化与准备">1. 初始化与准备
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">updateFilePost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从Redis获取上传文件信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">UploadingFileDto</span><span class="w"> </span><span class="n">fileDto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getUploadVideoFile</span><span class="p">(</span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getUploadId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 设置临时文件路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">tempFilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appConfig</span><span class="p">.</span><span class="na">getProjectFolder</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_FOLDER</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_FOLDER_TEMP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fileDto</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">File</span><span class="w"> </span><span class="n">tempFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">tempFilePath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 设置目标文件路径</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">targetFilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appConfig</span><span class="p">.</span><span class="na">getProjectFolder</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_FOLDER</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_VIDEO</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fileDto</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">File</span><span class="w"> </span><span class="n">targetFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">targetFile</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">targetFile</span><span class="p">.</span><span class="na">mkdirs</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>创建 updateFilePost 对象用于后续更新数据库</li>
<li>从 Redis 获取上传文件信息（包含文件路径等）</li>
<li>构造临时文件路径和目标文件路径</li>
<li>确保目标目录存在（不存在则创建）</li>
</ul>
<h3 id="2-文件转移与处理">2. 文件转移与处理
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 将文件从临时目录复制到正式目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">copyDirectory</span><span class="p">(</span><span class="n">tempFile</span><span class="p">,</span><span class="w"> </span><span class="n">targetFile</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 删除临时目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">forceDelete</span><span class="p">(</span><span class="n">tempFile</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从Redis删除文件信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">delVideoFileInfo</span><span class="p">(</span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getUploadId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 合并文件（如果是分片上传）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">completeVideo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetFilePath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">TEMP_VIDEO_NAME</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">union</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">,</span><span class="w"> </span><span class="n">completeVideo</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>使用 FileUtils.copyDirectory 将文件从临时目录复制到正式目录</li>
<li>删除临时目录（清理空间）</li>
<li>从 Redis 删除已处理的文件信息</li>
<li>调用 union 方法合并视频分片（如果有）</li>
</ul>
<h3 id="3-获取视频信息">3. 获取视频信息
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 获取视频时长</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fFmpegUtils</span><span class="p">.</span><span class="na">getVideoInfoDuration</span><span class="p">(</span><span class="n">completeVideo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">updateFilePost</span><span class="p">.</span><span class="na">setDuration</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">updateFilePost</span><span class="p">.</span><span class="na">setFileSize</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">completeVideo</span><span class="p">).</span><span class="na">length</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">updateFilePost</span><span class="p">.</span><span class="na">setFilePath</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_VIDEO</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fileDto</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">updateFilePost</span><span class="p">.</span><span class="na">setTransferResult</span><span class="p">(</span><span class="n">VideoFileTransferResultEnum</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 将视频转换为TS格式（用于HLS流媒体）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">convertVideo2Ts</span><span class="p">(</span><span class="n">completeVideo</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>使用 fFmpegUtils 获取视频时长</li>
<li>设置文件大小、路径和转码结果为成功</li>
<li>调用 convertVideo2Ts 将视频转换为 TS 格式（用于 HTTP Live Streaming）</li>
</ul>
<h3 id="4-异常处理">4. 异常处理
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;文件转码失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">updateFilePost</span><span class="p">.</span><span class="na">setTransferResult</span><span class="p">(</span><span class="n">VideoFileTransferResultEnum</span><span class="p">.</span><span class="na">FAIL</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>捕获所有异常并记录日志</li>
<li>设置转码结果为失败状态</li>
</ul>
<h3 id="5-状态更新与检查">5. 状态更新与检查
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 更新文件状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">updateByUploadIdAndUserId</span><span class="p">(</span><span class="n">updateFilePost</span><span class="p">,</span><span class="w"> </span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getUploadId</span><span class="p">(),</span><span class="w"> </span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 检查是否有转码失败的视频文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">VideoInfoFilePostQuery</span><span class="w"> </span><span class="n">fileQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePostQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">fileQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">fileQuery</span><span class="p">.</span><span class="na">setTransferResult</span><span class="p">(</span><span class="n">VideoFileTransferResultEnum</span><span class="p">.</span><span class="na">FAIL</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">failCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">selectCount</span><span class="p">(</span><span class="n">fileQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">failCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 如果有失败的，设置视频状态为STATUS1（可能是&#34;转码失败&#34;状态）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VideoInfoPost</span><span class="w"> </span><span class="n">videoUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoPost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoUpdate</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS1</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfoPostMapper</span><span class="p">.</span><span class="na">updateByVideoId</span><span class="p">(</span><span class="n">videoUpdate</span><span class="p">,</span><span class="w"> </span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 检查是否还有转码中的视频文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">fileQuery</span><span class="p">.</span><span class="na">setTransferResult</span><span class="p">(</span><span class="n">VideoFileTransferResultEnum</span><span class="p">.</span><span class="na">TRANSFER</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">transferCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">selectCount</span><span class="p">(</span><span class="n">fileQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">transferCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 如果没有转码中的文件，计算总时长并更新视频状态为STATUS2（可能是&#34;转码完成&#34;状态）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">sumDuration</span><span class="p">(</span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VideoInfoPost</span><span class="w"> </span><span class="n">videoUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoPost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoUpdate</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS2</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoUpdate</span><span class="p">.</span><span class="na">setDuration</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfoPostMapper</span><span class="p">.</span><span class="na">updateByVideoId</span><span class="p">(</span><span class="n">videoUpdate</span><span class="p">,</span><span class="w"> </span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>解析：</strong></p>
<ul>
<li>更新文件状态：无论成功失败，都更新当前文件状态</li>
<li>检查失败情况：
<ul>
<li>查询该视频下是否有转码失败的文件</li>
<li>如果有，设置视频整体状态为失败（STATUS1）</li>
</ul>
</li>
<li>检查转码完成情况：
<ul>
<li>查询是否还有转码中的文件</li>
<li>如果没有，计算视频总时长并更新状态为完成（STATUS2）</li>
</ul>
</li>
</ul>
<h3 id="状态枚举说明">状态枚举说明
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>枚举值</th>
          <th>可能含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>STATUS0</td>
          <td>待审核/待处理</td>
      </tr>
      <tr>
          <td>STATUS1</td>
          <td>转码失败</td>
      </tr>
      <tr>
          <td>STATUS2</td>
          <td>转码完成</td>
      </tr>
      <tr>
          <td>TRANSFER</td>
          <td>转码中</td>
      </tr>
      <tr>
          <td>SUCCESS</td>
          <td>转码成功</td>
      </tr>
      <tr>
          <td>FAIL</td>
          <td>转码失败</td>
      </tr>
  </tbody>
</table></div>
<h3 id="方法流程图">方法流程图
</h3><ol>
<li>从临时目录 → 正式目录</li>
<li>清理临时文件、删除 Redis 缓存</li>
<li>合并分片、获取元信息、转码</li>
<li>更新单个文件状态</li>
<li>检查并更新整体视频状态</li>
</ol>
<h3 id="关键点总结">关键点总结
</h3><ul>
<li><strong>文件转移流程</strong>：从临时目录 → 正式目录，清理临时文件，删除 Redis 缓存</li>
<li><strong>视频处理</strong>：合并分片（如需要）、获取元信息（时长、大小）、转换为 TS 格式（用于流媒体）</li>
<li><strong>状态管理</strong>：单个文件状态更新、整体视频状态检查、失败处理和成功状态更新</li>
<li><strong>事务完整性</strong>：try-catch 确保异常被捕获，finally 块确保状态一定会更新，全面的状态检查机制</li>
</ul>
<h3 id="优化点">优化点
</h3><ul>
<li><strong>异步处理</strong>：视频转码是耗时操作，可以考虑使用消息队列异步处理</li>
<li><strong>进度反馈</strong>：可以增加转码进度反馈机制</li>
<li><strong>重试机制</strong>：对于失败的转码任务可以加入重试逻辑</li>
<li><strong>资源清理</strong>：确保在任何异常情况下都能正确清理临时资源</li>
<li><strong>状态枚举</strong>：建议使用更具描述性的枚举名称，如 &ldquo;TRANSCODE_COMPLETED&rdquo; 而非 &ldquo;STATUS2&rdquo;</li>
</ul>
<hr>
<h2 id="convertvideo2ts-和-union-方法详细解析">convertVideo2Ts 和 union 方法详细解析
</h2><p>这两个方法是 transferVideoFile 中用于视频文件处理的核心辅助方法，下面结合它们在 transferVideoFile 中的使用场景进行详细解释。</p>
<h3 id="1-convertvideo2ts-方法解析">1. convertVideo2Ts 方法解析
</h3><p><strong>方法签名</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">convertVideo2Ts</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">videoFilePath</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>功能说明</strong></p>
<ul>
<li>负责将视频文件转换为 TS（Transport Stream）格式，主要用于 HLS（HTTP Live Streaming）视频流的分片处理。</li>
</ul>
<p><strong>执行流程</strong></p>
<ol>
<li><strong>获取视频文件信息</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">File</span><span class="w"> </span><span class="n">videoFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">videoFilePath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">File</span><span class="w"> </span><span class="n">tsFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoFile</span><span class="p">.</span><span class="na">getParentFile</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fFmpegUtils</span><span class="p">.</span><span class="na">getVideoCodec</span><span class="p">(</span><span class="n">videoFilePath</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>HEVC 编码转换</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">VIDEO_CODE_HEVC</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">codec</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">tempFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoFilePath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">VIDEO_CODE_TEMP_FILE_SUFFIX</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">videoFilePath</span><span class="p">).</span><span class="na">renameTo</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">tempFileName</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">fFmpegUtils</span><span class="p">.</span><span class="na">convertHevc2Mp4</span><span class="p">(</span><span class="n">tempFileName</span><span class="p">,</span><span class="w"> </span><span class="n">videoFilePath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">tempFileName</span><span class="p">).</span><span class="na">delete</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>如果视频是 HEVC 编码（H.265），先转换为 MP4 格式（H.264）。</li>
<li>使用临时文件进行转换，完成后删除临时文件。</li>
</ul>
</li>
<li><strong>转换为 TS 格式</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">fFmpegUtils</span><span class="p">.</span><span class="na">convertVideo2Ts</span><span class="p">(</span><span class="n">tsFolder</span><span class="p">,</span><span class="w"> </span><span class="n">videoFilePath</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>删除原始视频文件</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">videoFile</span><span class="p">.</span><span class="na">delete</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p><strong>在 transferVideoFile 中的使用</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="na">convertVideo2Ts</span><span class="p">(</span><span class="n">completeVideo</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>在文件转移完成后调用，确保视频格式适合流媒体播放，处理特殊编码格式的兼容性问题。</li>
</ul>
<hr>
<h3 id="2-union-方法解析">2. union 方法解析
</h3><p><strong>方法签名</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">union</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dirPath</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">toFilePath</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">delSource</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>功能说明</strong></p>
<ul>
<li>用于合并分片视频文件，将多个分片文件合并为一个完整的视频文件。</li>
</ul>
<p><strong>执行流程</strong></p>
<ol>
<li><strong>参数验证</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">File</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">dirPath</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;目录不存在&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>获取分片文件列表</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">File</span><span class="w"> </span><span class="n">fileList</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="na">listFiles</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>创建目标文件</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">File</span><span class="w"> </span><span class="n">targetFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">toFilePath</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>合并文件内容</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">RandomAccessFile</span><span class="w"> </span><span class="n">writeFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RandomAccessFile</span><span class="p">(</span><span class="n">targetFile</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;rw&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">10</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="c1">// 10KB缓冲区</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fileList</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">chunkFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">dirPath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">File</span><span class="p">.</span><span class="na">separator</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">RandomAccessFile</span><span class="w"> </span><span class="n">readFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RandomAccessFile</span><span class="p">(</span><span class="n">chunkFile</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;r&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readFile</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">writeFile</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>使用随机访问文件高效读写，按顺序合并所有分片。</li>
<li>使用 try-with-resources 确保资源释放。</li>
</ul>
</li>
<li><strong>清理源文件（可选）</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delSource</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">file</span><span class="p">.</span><span class="na">delete</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p><strong>在 transferVideoFile 中的使用</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="na">union</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">,</span><span class="w"> </span><span class="n">completeVideo</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>用于合并分片上传的视频文件，delSource=true 表示合并后删除分片文件，生成完整的视频文件供后续处理。</li>
</ul>
<hr>
<h3 id="3-两个方法的协作关系">3. 两个方法的协作关系
</h3><ul>
<li>transferVideoFile 中的处理顺序：
<ol>
<li>文件转移：从临时目录移动到正式目录</li>
<li>文件合并（union 方法）：将分片合并为完整视频，删除分片文件</li>
<li>格式转换（convertVideo2Ts 方法）：检查并转换编码格式，转换为 TS 格式用于流媒体，删除原始文件</li>
</ol>
</li>
</ul>
<hr>
<h3 id="4-设计考虑">4. 设计考虑
</h3><ul>
<li><strong>分片处理</strong>：支持大文件分片上传，合并时确保文件顺序正确</li>
<li><strong>格式兼容性</strong>：处理 HEVC 等特殊编码，转换为广泛支持的格式</li>
<li><strong>资源管理</strong>：及时清理临时文件，使用缓冲区提高 IO 效率，确保文件句柄正确释放</li>
<li><strong>错误处理</strong>：明确的异常抛出，资源清理放在 finally 块</li>
</ul>
<hr>
<h3 id="5-典型使用场景">5. 典型使用场景
</h3><ul>
<li>分片上传处理流程：
<ul>
<li>用户上传视频分片</li>
<li>所有分片上传完成后触发 transferVideoFile</li>
<li>合并分片 → 转码 → 生成流媒体格式</li>
</ul>
</li>
<li>视频处理流程：
<ul>
<li>原始视频 → 检查编码 → 转换 → TS 切片，为 HLS 流媒体做准备</li>
</ul>
</li>
</ul>
<hr>
<h3 id="6-潜在优化点">6. 潜在优化点
</h3><ul>
<li><strong>并行处理</strong>：分片合并可以使用多线程加速</li>
<li><strong>进度反馈</strong>：添加转码进度回调</li>
<li><strong>错误恢复</strong>：记录处理进度，支持断点续处理</li>
<li><strong>资源控制</strong>：限制并发转码任务数，监控系统负载</li>
</ul>
<p>这两个方法共同构成了视频处理管道的核心环节，将上传的视频文件最终转换为可流式传输的标准格式。</p>
<hr>
<h2 id="auditvideo-方法详细解析">auditVideo 方法详细解析
</h2><p>auditVideo 方法是视频审核的核心方法，负责处理视频审核状态的变更、用户积分奖励、数据同步以及文件清理等操作。下面从功能、流程、设计思路等方面进行全面解析。</p>
<h3 id="1-方法概述-1">1. 方法概述
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">rollbackFor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">auditVideo</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 方法实现</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>功能：</strong> 处理视频审核流程，包括：</p>
<ul>
<li>验证审核状态合法性</li>
<li>更新视频审核状态</li>
<li>处理审核通过/不通过的逻辑分支</li>
<li>用户积分奖励（首次发布）</li>
<li>数据同步到正式表</li>
<li>清理待删除文件</li>
<li>同步数据到搜索引擎</li>
</ul>
<p><strong>参数：</strong></p>
<ul>
<li>videoId：视频唯一标识</li>
<li>status：目标审核状态</li>
<li>reason：审核原因（如不通过原因）</li>
</ul>
<p><strong>事务控制：</strong> <code>@Transactional(rollbackFor = Exception.class)</code> 确保方法内所有数据库操作要么全部成功，要么全部回滚</p>
<hr>
<h3 id="2-方法流程详解">2. 方法流程详解
</h3><h4 id="21-状态验证">2.1 状态验证
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoStatusEnum</span><span class="w"> </span><span class="n">videoStatusEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">getByStatus</span><span class="p">(</span><span class="n">status</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">videoStatusEnum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_600</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>验证传入的审核状态是否合法，非法状态直接抛出业务异常。</li>
<li>使用枚举 VideoStatusEnum 管理所有可能的视频状态。</li>
</ul>
<h4 id="22-更新视频状态带条件">2.2 更新视频状态（带条件）
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoInfoPost</span><span class="w"> </span><span class="n">videoInfoPost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoPost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoPost</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">status</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">VideoInfoPostQuery</span><span class="w"> </span><span class="n">videoInfoPostQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoPostQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoPostQuery</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS2</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoPostQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Integer</span><span class="w"> </span><span class="n">auditCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoPostMapper</span><span class="p">.</span><span class="na">updateByParam</span><span class="p">(</span><span class="n">videoInfoPost</span><span class="p">,</span><span class="w"> </span><span class="n">videoInfoPostQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">auditCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;审核失败，请稍后重试&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>将视频从&quot;待审核&quot;状态更新为目标审核状态。</li>
<li>乐观锁机制：更新条件包含当前状态（STATUS2 表示待审核），防止并发修改导致状态混乱。</li>
<li>如果影响行数为 0，说明视频不满足更新条件（可能已被其他审核员处理）。</li>
</ul>
<h4 id="23-更新关联文件状态">2.3 更新关联文件状态
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoInfoFilePost</span><span class="w"> </span><span class="n">videoInfoFilePost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoFilePost</span><span class="p">.</span><span class="na">setUpdateType</span><span class="p">(</span><span class="n">VideoFileUpdateTypeEnum</span><span class="p">.</span><span class="na">NO_UPDATE</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">VideoInfoFilePostQuery</span><span class="w"> </span><span class="n">filePostQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePostQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">filePostQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">updateByParam</span><span class="p">(</span><span class="n">videoInfoFilePost</span><span class="p">,</span><span class="w"> </span><span class="n">filePostQuery</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>将所有关联文件的 updateType 标记为&quot;无需更新&quot;，表示这些文件已经完成审核流程。</li>
</ul>
<h4 id="24-处理审核不通过情况">2.4 处理审核不通过情况
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VideoStatusEnum</span><span class="p">.</span><span class="na">STATUS4</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">videoStatusEnum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 审核不通过</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>如果审核状态为&quot;不通过&quot;(STATUS4)，直接返回，不执行后续的积分奖励、数据同步等操作。</li>
</ul>
<h4 id="25-首次发布奖励积分">2.5 首次发布奖励积分
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoInfoPost</span><span class="w"> </span><span class="n">infoPost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoPostMapper</span><span class="p">.</span><span class="na">selectByVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">VideoInfo</span><span class="w"> </span><span class="n">dbVideoInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoMapper</span><span class="p">.</span><span class="na">selectByVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dbVideoInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SysSettingDto</span><span class="w"> </span><span class="n">sysSettingDto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getSysSettingDto</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">userInfoMapper</span><span class="p">.</span><span class="na">updateCoinCountInfo</span><span class="p">(</span><span class="n">infoPost</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">sysSettingDto</span><span class="p">.</span><span class="na">getPostVideoCoinCount</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>检查视频是否首次发布（正式表中不存在记录），如果是首次发布，给视频作者增加相应积分。</li>
<li>奖励机制鼓励用户发布内容，积分数量配置在系统设置中，便于灵活调整。</li>
</ul>
<h4 id="26-同步数据到正式表">2.6 同步数据到正式表
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 将发布信息复制到正式表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">VideoInfo</span><span class="w"> </span><span class="n">videoInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CopyTools</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">infoPost</span><span class="p">,</span><span class="w"> </span><span class="n">VideoInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoMapper</span><span class="p">.</span><span class="na">insertOrUpdate</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 先删除旧文件信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">VideoInfoFileQuery</span><span class="w"> </span><span class="n">videoInfoFileQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFileQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoFileQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFileMapper</span><span class="p">.</span><span class="na">deleteByParam</span><span class="p">(</span><span class="n">videoInfoFileQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 从发布表查询并插入到正式表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">VideoInfoFilePostQuery</span><span class="w"> </span><span class="n">videoInfoFilePostQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePostQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoFilePostQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFilePost</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoInfoFilePostList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">selectList</span><span class="p">(</span><span class="n">videoInfoFilePostQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFile</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoInfoFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CopyTools</span><span class="p">.</span><span class="na">copyList</span><span class="p">(</span><span class="n">videoInfoFilePostList</span><span class="p">,</span><span class="w"> </span><span class="n">VideoInfoFile</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFileMapper</span><span class="p">.</span><span class="na">insertBatch</span><span class="p">(</span><span class="n">videoInfoFileList</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>主表同步：将发布表（VideoInfoPost）数据拷贝到正式表（VideoInfo）。</li>
<li>文件表同步：先删除正式文件表中该视频的所有记录，再从发布文件表查询所有相关文件，批量插入到正式文件表。</li>
<li>使用 CopyTools 实现对象深拷贝，先删除后插入确保数据一致性。</li>
</ul>
<h4 id="27-清理待删除文件">2.7 清理待删除文件
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filePathList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getDelFileList</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filePathList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">filePathList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getProjectFolder</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_FOLDER</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">path</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">deleteDirectory</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;删除文件失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">redisComponent</span><span class="p">.</span><span class="na">cleanDelFileList</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>从 Redis 获取该视频的待删除文件列表，遍历列表删除实际文件，清理 Redis 中的记录。</li>
<li>业务场景：用户编辑视频时删除的旧文件、转码过程中生成的临时文件、审核通过后不再需要的中间文件。</li>
</ul>
<h4 id="28-同步到搜索引擎">2.8 同步到搜索引擎
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">esSearchComponent</span><span class="p">.</span><span class="na">saveDoc</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>将视频信息索引到 Elasticsearch，使视频可被搜索，支持复杂的搜索条件和排序。</li>
</ul>
<hr>
<h3 id="3-状态机设计">3. 状态机设计
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>状态枚举</th>
          <th>状态含义</th>
          <th>可流转至</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>STATUS0</td>
          <td>待处理/初始状态</td>
          <td>STATUS2</td>
      </tr>
      <tr>
          <td>STATUS2</td>
          <td>待审核</td>
          <td>STATUS3/STATUS4</td>
      </tr>
      <tr>
          <td>STATUS3</td>
          <td>审核通过</td>
          <td>-</td>
      </tr>
      <tr>
          <td>STATUS4</td>
          <td>审核不通过</td>
          <td>-</td>
      </tr>
  </tbody>
</table></div>
<ul>
<li>只有 STATUS2（待审核）状态的视频才能被审核，审核后变为 STATUS3（通过）或 STATUS4（不通过）。</li>
<li>状态变更采用乐观锁控制。</li>
</ul>
<hr>
<h3 id="4-数据表设计分析">4. 数据表设计分析
</h3><ul>
<li>
<p>发布表（待审核数据）：</p>
<ul>
<li>video_info_post：视频主信息</li>
<li>video_info_file_post：视频文件信息</li>
</ul>
</li>
<li>
<p>正式表（已审核数据）：</p>
<ul>
<li>video_info：视频主信息</li>
<li>video_info_file：视频文件信息</li>
</ul>
</li>
<li>
<p>用户表：</p>
<ul>
<li>user_info：存储用户积分</li>
</ul>
</li>
<li>
<p>发布与正式数据隔离，避免审核中数据污染生产环境。</p>
</li>
<li>
<p>两套表结构相同，便于使用工具类拷贝。</p>
</li>
<li>
<p>审核通过后才同步到正式表，保证数据质量。</p>
</li>
</ul>
<hr>
<h3 id="5-异常处理设计">5. 异常处理设计
</h3><ul>
<li>业务异常：非法状态参数立即抛出，更新行数为 0 视为并发冲突，提示重试。</li>
<li>系统异常：文件删除失败记录日志但不中断流程，其他异常由事务注解处理自动回滚。</li>
<li>方法级事务保证数据一致性，非关键操作（如文件删除）在事务外处理。</li>
</ul>
<hr>
<h3 id="6-潜在优化建议">6. 潜在优化建议
</h3><ul>
<li><strong>审核日志</strong>：建议增加审核人和审核原因的审计日志。</li>
<li><strong>性能优化</strong>：大批量文件删除可考虑异步化，Elasticsearch 同步可加入队列异步处理。</li>
<li><strong>状态扩展</strong>：可增加&quot;审核中&quot;状态，避免长时间审核导致的并发问题。</li>
<li><strong>文件清理</strong>：增加删除重试机制，提高文件清理成功率。</li>
<li><strong>配置灵活性</strong>：审核通过后的操作（如积分奖励）可通过策略模式实现动态配置。</li>
</ul>
<hr>
<h3 id="7-总结">7. 总结
</h3><ul>
<li>auditVideo 方法是一个完整的视频审核解决方案，具有以下特点：
<ul>
<li>严谨的状态管理：通过枚举和乐观锁确保状态流转安全</li>
<li>数据隔离设计：发布数据与正式数据物理分离</li>
<li>完整的业务流程：涵盖状态更新、积分奖励、数据同步、文件清理等</li>
<li>良好的异常处理：区分业务异常和系统异常，关键操作事务保障</li>
<li>可扩展性：模块化设计便于新增审核后操作</li>
</ul>
</li>
<li>该方法体现了生产级审核系统的核心设计思想，兼顾了功能性、安全性和可维护性。</li>
</ul>
<h2 id="mysql中left-join与inner-join的使用场景">MySQL中LEFT JOIN与INNER JOIN的使用场景
</h2><p>在MySQL数据库查询中，JOIN操作是最常用的操作之一，而LEFT JOIN和INNER JOIN是两种最基础的JOIN类型。理解它们的区别和适用场景对于编写高效、准确的SQL查询至关重要。</p>
<h3 id="核心区别">核心区别
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>INNER JOIN</th>
          <th>LEFT JOIN</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>结果集</td>
          <td>只返回两表中匹配的行</td>
          <td>返回左表所有行，右表不匹配则为NULL</td>
      </tr>
      <tr>
          <td>数据丢失</td>
          <td>不匹配的行会被过滤掉</td>
          <td>保留左表所有数据</td>
      </tr>
      <tr>
          <td>性能</td>
          <td>通常更快</td>
          <td>通常稍慢</td>
      </tr>
      <tr>
          <td>使用频率</td>
          <td>高</td>
          <td>高</td>
      </tr>
  </tbody>
</table></div>
<hr>
<h3 id="inner-join内连接使用场景">INNER JOIN（内连接）使用场景
</h3><h4 id="1-需要严格匹配关系的查询">1. 需要严格匹配关系的查询
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查询有订单的客户信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customers</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="n">order_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">customers</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="n">customer_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>适用情况：</strong></p>
<ul>
<li>只关心两个表中都存在关联记录的数据</li>
<li>需要排除任何一边没有匹配项的数据</li>
</ul>
<h4 id="2-多表关联且需要所有表都有匹配">2. 多表关联且需要所有表都有匹配
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查询同时有订单和付款记录的客户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">amount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">payments</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">order_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-性能优先的查询">3. 性能优先的查询
</h4><ul>
<li>INNER JOIN 通常比 LEFT JOIN 性能更好，特别是在大表关联时。</li>
</ul>
<hr>
<h3 id="left-join左连接使用场景">LEFT JOIN（左连接）使用场景
</h3><h4 id="1-需要包含左表所有记录的查询">1. 需要包含左表所有记录的查询
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查询所有客户及其订单(包括没有订单的客户)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customers</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="n">order_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">customers</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="n">customer_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>适用情况：</strong></p>
<ul>
<li>需要保留左表所有记录，无论右表是否有匹配</li>
<li>需要统计&quot;有&quot;和&quot;没有&quot;的情况</li>
</ul>
<h4 id="2-检测缺失数据的查询">2. 检测缺失数据的查询
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查找没有订单的客户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customers</span><span class="p">.</span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">customers</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-分级数据查询">3. 分级数据查询
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查询部门及员工(包括没有员工的部门)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">departments</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">employees</span><span class="p">.</span><span class="n">employee_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">departments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">employees</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">departments</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employees</span><span class="p">.</span><span class="n">dept_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="选择依据">选择依据
</h3><ul>
<li><strong>业务需求：</strong>
<ul>
<li>是否需要保留不匹配的记录？</li>
<li>是否要计算存在/不存在的记录？</li>
</ul>
</li>
<li><strong>数据完整性：</strong>
<ul>
<li>如果右表数据必须存在，用 INNER JOIN</li>
<li>如果右表数据可选，用 LEFT JOIN</li>
</ul>
</li>
<li><strong>性能考虑：</strong>
<ul>
<li>大表关联优先考虑 INNER JOIN</li>
<li>必要时可以用 LEFT JOIN 配合索引优化</li>
</ul>
</li>
</ul>
<hr>
<h3 id="性能优化建议">性能优化建议
</h3><ul>
<li><strong>为JOIN条件建立索引：</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>限制结果集大小：</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">large_table</span><span class="w"> </span><span class="n">l</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">small_table</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">large_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>避免不必要的LEFT JOIN：</strong>
<ul>
<li>如果业务上右表数据必须存在，使用 INNER JOIN 更高效</li>
</ul>
</li>
</ul>
<hr>
<h3 id="实际案例对比">实际案例对比
</h3><p><strong>场景：电商系统中的订单查询</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 方案1: INNER JOIN (只查询有客户的订单)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 方案2: LEFT JOIN (查询所有订单，包括客户信息缺失的)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 方案3: LEFT JOIN查找异常数据 (客户信息缺失的订单)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="总结-3">总结
</h3><ul>
<li><strong>使用 INNER JOIN：</strong> 当你确定关联数据必须存在，且只需要匹配成功的记录时</li>
<li><strong>使用 LEFT JOIN：</strong> 当需要保留左表所有记录，无论是否匹配，或者需要查找缺失关联数据时</li>
</ul>
<p>正确选择 JOIN 类型不仅能确保查询结果的准确性，还能显著影响查询性能。在设计查询时，应先明确业务需求，再决定使用哪种 JOIN 方式。</p>
<h2 id="跨系统事务处理策略">跨系统事务处理策略
</h2><p>在分布式系统或微服务架构下，常常需要在一个业务流程中同时操作本地数据库和远程系统（如调用外部接口写入其它服务器数据库）。如何保证数据一致性和高可用，是实际开发中的常见难题。</p>
<h3 id="执行顺序建议先本地后远程">执行顺序建议：先本地后远程
</h3><ul>
<li><strong>性能考虑：</strong> 本地操作通常比远程调用更快，先完成快速操作可减少资源锁定时间。</li>
<li><strong>错误处理：</strong> 本地操作失败可直接回滚，避免不必要的远程调用。</li>
<li><strong>数据一致性：</strong> 先保证本地数据一致，远程调用作为后续补偿的基础。</li>
</ul>
<hr>
<h3 id="超时处理方案">超时处理方案
</h3><h4 id="1-本地事务异步通知推荐">1. 本地事务+异步通知（推荐）
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processTransaction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 先执行本地数据库操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">localRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 2. 尝试同步调用远程接口（设置合理超时时间）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">remoteService</span><span class="p">.</span><span class="na">callWithTimeout</span><span class="p">(</span><span class="n">remoteData</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TimeoutException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 3. 如果超时，将任务放入重试队列</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mqService</span><span class="p">.</span><span class="na">sendToRetryQueue</span><span class="p">(</span><span class="n">remoteData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 本地事务仍然提交</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 其他本地操作...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>配套措施：</strong></p>
<ul>
<li>建立消息队列和重试机制</li>
<li>监控未完成的远程调用</li>
<li>提供人工干预接口</li>
</ul>
<h4 id="2-两阶段提交模式">2. 两阶段提交模式
</h4><p>图</p>
<ul>
<li>本地数据库预提交（不实际生效）</li>
<li>远程服务预提交（资源预留）</li>
<li>确认都成功后最终提交，否则回滚两边</li>
</ul>
<hr>
<h3 id="超时具体处理策略">超时具体处理策略
</h3><h4 id="1-短超时快速失败">1. 短超时+快速失败
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 设置合理的超时时间（根据业务需求调整）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">HttpClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HttpClient</span><span class="p">.</span><span class="na">create</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">responseTimeout</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="n">2</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-重试机制">2. 重试机制
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">RetryPolicy</span><span class="w"> </span><span class="n">retryPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RetryPolicy</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">withMaxAttempts</span><span class="p">(</span><span class="n">3</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">withDelay</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Failsafe</span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="n">retryPolicy</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">get</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">remoteService</span><span class="p">.</span><span class="na">call</span><span class="p">(</span><span class="n">remoteData</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-补偿事务">3. 补偿事务
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">mainOperation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 记录操作流水</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">logOperationStart</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 本地数据库操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">localRepository</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 补偿任务（定时执行）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">compensateOperation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">UnfinishedOperation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findUnfinished</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">operations</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">op</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">remoteService</span><span class="p">.</span><span class="na">retry</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="na">getData</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">markAsCompleted</span><span class="p">(</span><span class="n">op</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 报警通知人工处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">alertService</span><span class="p">.</span><span class="na">notifyAdmin</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="架构设计建议">架构设计建议
</h3><h4 id="最终一致性模式">最终一致性模式
</h4><ul>
<li>使用事件溯源（Event Sourcing）</li>
<li>实现可靠事件总线</li>
</ul>
<h4 id="服务降级方案">服务降级方案
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">remoteService</span><span class="p">.</span><span class="na">call</span><span class="p">(</span><span class="n">remoteData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 降级处理：记录到本地待处理表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">fallbackRepository</span><span class="p">.</span><span class="na">savePendingTask</span><span class="p">(</span><span class="n">remoteData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 触发告警</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">monitoringService</span><span class="p">.</span><span class="na">alert</span><span class="p">(</span><span class="s">&#34;Remote call failed&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="监控指标">监控指标
</h4><ul>
<li>远程调用成功率</li>
<li>平均响应时间</li>
<li>待补偿事务数量</li>
<li>补偿成功率</li>
</ul>
<h3 id="决策流程图">决策流程图
</h3><h3 id="总结建议">总结建议
</h3><ul>
<li><strong>常规场景：</strong> 采用&quot;先本地后远程+异步重试&quot;方案</li>
<li><strong>金融等严格场景：</strong> 考虑两阶段提交或Saga模式</li>
<li><strong>必须保证：</strong>
<ul>
<li>本地操作的可回滚性</li>
<li>远程调用的幂等性</li>
<li>完善的监控报警机制</li>
</ul>
</li>
</ul>
<p>通过这种设计，即使在远程调用超时的情况下，系统仍能保持最终一致性，同时避免长时间的资源锁定和用户等待。</p>
<hr>
<h2 id="关于spring事务内部调用的问题">关于Spring事务内部调用的问题
</h2><p>在代码中，topComment方法调用cancelTopComment方法，这种内部调用不会导致事务失效，因为：</p>
<p>topComment方法有@Transactional注解，创建了一个事务
cancelTopComment方法被topComment调用时，是在同一个类内部的方法调用
Spring的事务代理是基于AOP实现的，内部调用不会经过代理对象</p>
<h4 id="1-方法内部调用最常见">1. 方法内部调用（最常见）
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">outerMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">innerMethod</span><span class="p">();</span><span class="w"> </span><span class="c1">// 事务失效</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">innerMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 数据库操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>失效原因：内部调用绕过了Spring的代理机制。</li>
</ul>
<h4 id="2-事务方法不是public">2. 事务方法不是public
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">myMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 事务失效</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>失效原因：Spring AOP无法代理非public方法。</li>
</ul>
<h4 id="3-异常被捕获未抛出">3. 异常被捕获未抛出
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">myMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 数据库操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 捕获异常但不抛出</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>失效原因：事务回滚需要异常传播到事务管理器。</li>
</ul>
<h4 id="4-异常类型不匹配">4. 异常类型不匹配
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="p">(</span><span class="n">rollbackFor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">myMethod</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">();</span><span class="w"> </span><span class="c1">// 事务不会回滚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>失效原因：抛出的异常类型不在rollbackFor指定的范围内。</li>
</ul>
<h4 id="5-多线程调用">5. 多线程调用
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">myMethod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 数据库操作 - 事务失效</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>失效原因：事务信息绑定在线程本地变量(ThreadLocal)中，新线程无法获取。</li>
</ul>
<h4 id="6-数据库引擎不支持事务">6. 数据库引擎不支持事务
</h4><ul>
<li>例如使用MyISAM引擎的MySQL表，天然不支持事务。</li>
</ul>
<p><strong>如何确保事务有效</strong>
将需要事务的方法提取到单独的Service类中
通过注入的Service代理对象调用方法（而不是内部调用）
确保方法为public
正确处理异常
使用支持事务的数据库引擎</p>
<h2 id="视频在线人数统计系统实现详解">视频在线人数统计系统实现详解
</h2><h3 id="1-系统架构概述">1. 系统架构概述
</h3><p>本系统基于 Redis 实现，主要包含：</p>
<ul>
<li>心跳上报接口：客户端定期调用以维持在线状态</li>
<li>Redis 存储结构：使用两种键存储在线信息</li>
<li>过期监听机制：通过 Redis 的键过期事件自动减少在线人数</li>
<li>计数维护逻辑：确保在线人数的准确性</li>
</ul>
<h3 id="2-核心实现细节">2. 核心实现细节
</h3><h4 id="21-数据结构设计">2.1 数据结构设计
</h4><ul>
<li>用户播放键 (userPlayOnlineKey)
<ul>
<li>格式：video:play:user:{fileId}:{deviceId}</li>
<li>作用：标记特定设备是否在线</li>
<li>过期时间：8秒</li>
</ul>
</li>
<li>在线计数键 (playOnlineCountKey)
<ul>
<li>格式：video:play:online:{fileId}</li>
<li>作用：存储当前视频的在线人数</li>
<li>过期时间：10秒</li>
</ul>
</li>
</ul>
<h4 id="22-心跳上报流程">2.2 心跳上报流程
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="nf">reportVideoPlayOnline</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userPlayOnlineKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT_USER</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="n">deviceId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">playOnlineCountKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">redisUtils</span><span class="p">.</span><span class="na">keyExists</span><span class="p">(</span><span class="n">userPlayOnlineKey</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">redisUtils</span><span class="p">.</span><span class="na">setex</span><span class="p">(</span><span class="n">userPlayOnlineKey</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">,</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_EXPIRES_ONE_SECONDS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">redisUtils</span><span class="p">.</span><span class="na">incrementex</span><span class="p">(</span><span class="n">playOnlineCountKey</span><span class="p">,</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_EXPIRES_ONE_SECONDS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">10</span><span class="p">).</span><span class="na">intValue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">redisUtils</span><span class="p">.</span><span class="na">expire</span><span class="p">(</span><span class="n">playOnlineCountKey</span><span class="p">,</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_EXPIRES_ONE_SECONDS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">redisUtils</span><span class="p">.</span><span class="na">expire</span><span class="p">(</span><span class="n">userPlayOnlineKey</span><span class="p">,</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_EXPIRES_ONE_SECONDS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span><span class="w"> </span><span class="n">redisUtils</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">playOnlineCountKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>客户端每5-7秒调用一次接口</li>
<li>新用户：创建用户键并增加计数</li>
<li>已有用户：续期两个键</li>
<li>返回当前在线人数</li>
</ul>
<h4 id="23-过期监听机制">2.3 过期监听机制
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessage</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">pattern</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE_PREIFX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT_USER_PREFIX</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">userKeyIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT_USER_PREFIX</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT_USER_PREFIX</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">fileId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">userKeyIndex</span><span class="p">,</span><span class="w"> </span><span class="n">userKeyIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">LENGTH_20</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">decrementPlayOnlineCount</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE</span><span class="p">,</span><span class="w"> </span><span class="n">fileId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>用户键过期时自动减少对应视频的在线人数</li>
</ul>
<h4 id="24-计数递减逻辑">2.4 计数递减逻辑
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">decrementPlayOnlineCount</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">redisUtils</span><span class="p">.</span><span class="na">decrement</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-关键设计原理">3. 关键设计原理
</h3><ul>
<li>双键设计：用户键作为心跳，计数键集中存储人数，过期时间错开防止竞态</li>
<li>时间参数：8秒用户键，10秒计数键，客户端建议5-7秒上报</li>
<li>容错机制：计数键续期，空值处理，精确递减</li>
</ul>
<h3 id="4-系统优势">4. 系统优势
</h3><ul>
<li>实时性高：秒级检测用户离线</li>
<li>性能优异：完全基于Redis内存操作</li>
<li>扩展性强：支持大量并发用户</li>
<li>资源节约：自动清理不活跃用户</li>
</ul>
<h3 id="5-潜在优化方向">5. 潜在优化方向
</h3><ul>
<li>批量上报、分布式锁、异常重试、监控报警、动态过期</li>
</ul>
<hr>
<h2 id="websocket及其在在线人数统计中的应用">WebSocket及其在在线人数统计中的应用
</h2><h3 id="1-websocket-基础介绍">1. WebSocket 基础介绍
</h3><ul>
<li>WebSocket 是一种全双工通信协议，支持服务端主动推送数据。</li>
<li>与 HTTP 轮询相比，WebSocket 连接持久、实时性高、资源消耗低。</li>
</ul>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>WebSocket</th>
          <th>HTTP 轮询</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>连接方式</td>
          <td>持久化连接</td>
          <td>每次新建连接</td>
      </tr>
      <tr>
          <td>通信方向</td>
          <td>全双工</td>
          <td>半双工</td>
      </tr>
      <tr>
          <td>实时性</td>
          <td>毫秒级</td>
          <td>秒级</td>
      </tr>
      <tr>
          <td>服务器推送</td>
          <td>支持</td>
          <td>不支持</td>
      </tr>
      <tr>
          <td>资源消耗</td>
          <td>初期开销大，后期小</td>
          <td>每次请求都高</td>
      </tr>
  </tbody>
</table></div>
<h3 id="2-基于-websocket-的在线人数统计实现">2. 基于 WebSocket 的在线人数统计实现
</h3><h4 id="21-服务端实现spring-boot">2.1 服务端实现（Spring Boot）
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="s">&#34;/online/{videoId}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VideoOnlineEndpoint</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Session</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">videoSessions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setRedisTemplate</span><span class="p">(</span><span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VideoOnlineEndpoint</span><span class="p">.</span><span class="na">redisTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@OnOpen</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onOpen</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;videoId&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoSessions</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="p">.</span><span class="na">newKeySet</span><span class="p">()).</span><span class="na">add</span><span class="p">(</span><span class="n">session</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">redisKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;video:online:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">videoId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">increment</span><span class="p">(</span><span class="n">redisKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">expire</span><span class="p">(</span><span class="n">redisKey</span><span class="p">,</span><span class="w"> </span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">broadcastOnlineCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@OnClose</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onClose</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">&#34;videoId&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Session</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sessions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoSessions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sessions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sessions</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">session</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">redisKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;video:online:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">videoId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">decrement</span><span class="p">(</span><span class="n">redisKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">broadcastOnlineCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@OnError</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onError</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">error</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">broadcastOnlineCount</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;video:online:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;ONLINE_COUNT:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#34;0&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Session</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sessions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoSessions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sessions</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sessions</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">session</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">session</span><span class="p">.</span><span class="na">getBasicRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="22-客户端实现javascript">2.2 客户端实现（JavaScript）
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">videoId</span> <span class="o">=</span> <span class="s1">&#39;12345&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="sb">`wss://yourdomain.com/online/</span><span class="si">${</span><span class="nx">videoId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;WebSocket连接已建立&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;ONLINE_COUNT:&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nx">updateOnlineCountDisplay</span><span class="p">(</span><span class="nx">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nx">socket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">wasClean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`连接正常关闭，code=</span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">code</span><span class="si">}</span><span class="sb"> reason=</span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">reason</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">connectWebSocket</span><span class="p">(),</span> <span class="mi">5000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nx">socket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`WebSocket错误: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">updateOnlineCountDisplay</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;online-count&#39;</span><span class="p">).</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="23-心跳机制">2.3 心跳机制
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">setInterval</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;HEARTBEAT&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span> <span class="mi">30000</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@OnMessage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessage</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="s">&#34;HEARTBEAT&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">message</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">getAsyncRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="s">&#34;HEARTBEAT_ACK&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-方案优势分析">3. 方案优势分析
</h3><ul>
<li>实时性极佳，精确计数，扩展功能容易，减少无效请求</li>
<li>支持自动重连、心跳检测、集群扩展、协议优化、资源控制、监控体系、优雅降级</li>
</ul>
<h3 id="4-适用场景建议">4. 适用场景建议
</h3><ul>
<li>WebSocket适合高实时性、精确计数、互动场景</li>
<li>Redis方案适合简单、兼容性强、对实时性要求不高的场景</li>
<li>可采用混合方案：WebSocket客户端用本地计数，非WebSocket客户端用Redis计数</li>
</ul>
<hr>
<h2 id="netty与视频在线人数统计的结合">Netty与视频在线人数统计的结合
</h2><h3 id="1-netty基础介绍">1. Netty基础介绍
</h3><ul>
<li>Netty是高性能、异步事件驱动的网络应用框架，适合高并发、低延迟场景。</li>
<li>支持TCP/UDP、WebSocket等协议，适合实现长连接、实时通信。</li>
</ul>
<h3 id="2-为什么用netty实现在线人数统计">2. 为什么用Netty实现在线人数统计？
</h3><ul>
<li>HTTP轮询开销大、实时性有限、服务器压力大</li>
<li>Netty支持长连接、毫秒级实时、低协议开销、超高并发</li>
</ul>
<h3 id="3-基于netty的在线人数统计设计">3. 基于Netty的在线人数统计设计
</h3><h4 id="31-系统架构">3.1 系统架构
</h4><ul>
<li>客户端App/Web → Netty服务器集群 → Redis集群</li>
<li>WebSocket/TCP长连接，用户行为数据实时上报</li>
</ul>
<h4 id="32-核心组件实现">3.2 核心组件实现
</h4><ul>
<li>Netty服务器初始化</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VideoOnlineServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">EventLoopGroup</span><span class="w"> </span><span class="n">bossGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioEventLoopGroup</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">EventLoopGroup</span><span class="w"> </span><span class="n">workerGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioEventLoopGroup</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ServerBootstrap</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServerBootstrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">b</span><span class="p">.</span><span class="na">group</span><span class="p">(</span><span class="n">bossGroup</span><span class="p">,</span><span class="w"> </span><span class="n">workerGroup</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="p">.</span><span class="na">channel</span><span class="p">(</span><span class="n">NioServerSocketChannel</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="p">.</span><span class="na">childHandler</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initChannel</span><span class="p">(</span><span class="n">SocketChannel</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">ChannelPipeline</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">.</span><span class="na">pipeline</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="s">&#34;idleStateHandler&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IdleStateHandler</span><span class="p">(</span><span class="n">15</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="s">&#34;decoder&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OnlineMessageDecoder</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="s">&#34;encoder&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OnlineMessageEncoder</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="s">&#34;handler&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OnlineMessageHandler</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ChannelFuture</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">port</span><span class="p">).</span><span class="na">sync</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="na">channel</span><span class="p">().</span><span class="na">closeFuture</span><span class="p">().</span><span class="na">sync</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">workerGroup</span><span class="p">.</span><span class="na">shutdownGracefully</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bossGroup</span><span class="p">.</span><span class="na">shutdownGracefully</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>消息处理器实现</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OnlineMessageHandler</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">OnlineMessage</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ChannelGroup</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">channelRead0</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">OnlineMessage</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">getType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">CONNECT</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">handleConnect</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">(),</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getDeviceId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">HEARTBEAT</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">handleHeartbeat</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">(),</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getDeviceId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="n">DISCONNECT</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">handleDisconnect</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">(),</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getDeviceId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleConnect</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChannelGroup</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoGroups</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultChannelGroup</span><span class="p">(</span><span class="n">GlobalEventExecutor</span><span class="p">.</span><span class="na">INSTANCE</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">group</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RedisUtils</span><span class="p">.</span><span class="na">increment</span><span class="p">(</span><span class="s">&#34;video:online:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">broadcastCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleHeartbeat</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RedisUtils</span><span class="p">.</span><span class="na">setex</span><span class="p">(</span><span class="s">&#34;device:active:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">videoId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">deviceId</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">15</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">writeAndFlush</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OnlineMessage</span><span class="p">(</span><span class="n">HEARTBEAT_ACK</span><span class="p">,</span><span class="w"> </span><span class="n">getOnlineCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>客户端断连处理</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">channelInactive</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoGroups</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">group</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">group</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDeviceId</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getVideoId</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RedisUtils</span><span class="p">.</span><span class="na">decrement</span><span class="p">(</span><span class="s">&#34;video:online:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">broadcastCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">userEventTriggered</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">evt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">evt</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">IdleStateEvent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-与传统方案的对比">4. 与传统方案的对比
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>Netty实现方案</th>
          <th>HTTP轮询+Redis方案</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实时性</td>
          <td>毫秒级</td>
          <td>秒级</td>
      </tr>
      <tr>
          <td>协议开销</td>
          <td>低</td>
          <td>高</td>
      </tr>
      <tr>
          <td>并发能力</td>
          <td>10万+</td>
          <td>受限于HTTP服务器</td>
      </tr>
      <tr>
          <td>实现复杂度</td>
          <td>较高</td>
          <td>简单</td>
      </tr>
  </tbody>
</table></div>
<h3 id="5-适用场景建议">5. 适用场景建议
</h3><ul>
<li>Netty适合高实时互动、超高并发、长连接场景</li>
<li>HTTP轮询适合实时性要求不高、开发资源有限、兼容性要求高的场景</li>
</ul>
<hr>
<h2 id="netty与websocket的关系及在实时统计中的应用">Netty与WebSocket的关系及在实时统计中的应用
</h2><h3 id="1-netty与websocket的基础关系">1. Netty与WebSocket的基础关系
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>维度</th>
          <th>Netty</th>
          <th>WebSocket</th>
          <th>二者关系</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>定位</td>
          <td>网络应用框架</td>
          <td>通信协议</td>
          <td>Netty是实现WebSocket协议的底层框架之一</td>
      </tr>
      <tr>
          <td>层级</td>
          <td>传输层/应用层框架</td>
          <td>应用层协议</td>
          <td>Netty提供了对WebSocket协议的支持</td>
      </tr>
      <tr>
          <td>功能</td>
          <td>处理TCP/UDP连接、编解码、并发等</td>
          <td>提供全双工通信能力</td>
          <td>Netty帮助高效实现WebSocket的通信能力</td>
      </tr>
      <tr>
          <td>典型使用</td>
          <td>可作为WebSocket服务器的基础实现</td>
          <td>运行在Netty等框架之上</td>
          <td>开发者通过Netty API构建WebSocket服务</td>
      </tr>
  </tbody>
</table></div>
<h3 id="2-技术栈组合原理">2. 技术栈组合原理
</h3><ul>
<li>WebSocket客户端 ←WebSocket协议→ Netty WebSocket服务端 ←TCP→ 操作系统网络栈</li>
<li>Netty内置WebSocketServerProtocolHandler等组件，自动处理握手、帧编解码</li>
<li>Netty的Reactor线程模型优化WebSocket连接管理</li>
</ul>
<h3 id="3-在视频在线统计中的联合实现">3. 在视频在线统计中的联合实现
</h3><ul>
<li>基于Netty的WebSocket服务端示例</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VideoWebSocketServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">EventLoopGroup</span><span class="w"> </span><span class="n">bossGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioEventLoopGroup</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">EventLoopGroup</span><span class="w"> </span><span class="n">workerGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioEventLoopGroup</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ServerBootstrap</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServerBootstrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">b</span><span class="p">.</span><span class="na">group</span><span class="p">(</span><span class="n">bossGroup</span><span class="p">,</span><span class="w"> </span><span class="n">workerGroup</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="p">.</span><span class="na">channel</span><span class="p">(</span><span class="n">NioServerSocketChannel</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="p">.</span><span class="na">childHandler</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initChannel</span><span class="p">(</span><span class="n">SocketChannel</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">ChannelPipeline</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">.</span><span class="na">pipeline</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HttpServerCodec</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HttpObjectAggregator</span><span class="p">(</span><span class="n">65536</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebSocketServerProtocolHandler</span><span class="p">(</span><span class="s">&#34;/ws&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                     </span><span class="n">pipeline</span><span class="p">.</span><span class="na">addLast</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OnlineStatsHandler</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                 </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ChannelFuture</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">port</span><span class="p">).</span><span class="na">sync</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="na">channel</span><span class="p">().</span><span class="na">closeFuture</span><span class="p">().</span><span class="na">sync</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">workerGroup</span><span class="p">.</span><span class="na">shutdownGracefully</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">bossGroup</span><span class="p">.</span><span class="na">shutdownGracefully</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>在线统计业务处理器</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OnlineStatsHandler</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">TextWebSocketFrame</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ChannelGroup</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">channelRead0</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">TextWebSocketFrame</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">JsonObject</span><span class="w"> </span><span class="n">json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJson</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">text</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;videoId&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ChannelGroup</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoGroups</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultChannelGroup</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="na">executor</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;action&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;join&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">group</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">broadcastCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="s">&#34;heartbeat&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">redis</span><span class="p">.</span><span class="na">incr</span><span class="p">(</span><span class="s">&#34;active:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">videoId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">().</span><span class="na">id</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">channelInactive</span><span class="p">(</span><span class="n">ChannelHandlerContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoGroups</span><span class="p">.</span><span class="na">values</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">group</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">group</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="na">channel</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">broadcastCount</span><span class="p">(</span><span class="n">getVideoId</span><span class="p">(</span><span class="n">ctx</span><span class="p">),</span><span class="w"> </span><span class="n">group</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-典型消息流程">4. 典型消息流程
</h3><ul>
<li>连接建立：客户端 → HTTP Upgrade请求 → Netty(完成WebSocket握手) → 建立持久连接</li>
<li>心跳维持：客户端定期发送心跳，服务端响应ack</li>
<li>人数推送：服务端主动推送最新在线人数</li>
</ul>
<h3 id="5-优化点">5. 优化点
</h3><ul>
<li>连接管理：ChannelGroup管理房间，IdleStateHandler检测死连接</li>
<li>序列化优化：可用二进制协议代替JSON</li>
<li>集群扩展：Redis Pub/Sub同步各节点状态</li>
<li>监控指标：跟踪每个视频频道的连接数、消息吞吐量和延迟</li>
</ul>
<hr>
<h2 id="视频删除方法详解">视频删除方法详解
</h2><h3 id="1-方法整体功能">1. 方法整体功能
</h3><p>该 deleteVideo 方法是一个综合性的视频删除操作，主要完成以下功能：</p>
<ul>
<li>权限验证：检查视频是否存在及用户是否有权限删除</li>
<li>核心数据删除：删除视频主信息、投稿信息</li>
<li>经济系统调整：扣除用户发布视频获得的硬币</li>
<li>搜索索引清理：从 Elasticsearch 中移除文档</li>
<li>异步清理关联数据：使用线程池异步删除分P视频、弹幕、评论等关联数据及物理文件</li>
</ul>
<h3 id="2-异步线程池部分详解">2. 异步线程池部分详解
</h3><h4 id="21-线程池初始化">2.1 线程池初始化
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executorService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>固定大小线程池（10个线程）</li>
<li>适合已知并发量的稳定负载场景</li>
<li>超出线程数的任务会在队列中等待</li>
<li>潜在问题：无界队列可能导致 OOM，静态变量生命周期长可能线程泄漏</li>
</ul>
<h4 id="22-异步任务执行逻辑">2.2 异步任务执行逻辑
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">executorService</span><span class="p">.</span><span class="na">execute</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 异步任务代码块</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">});</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>使用 Lambda 封装 Runnable 任务</li>
<li>execute() 方法提交任务到线程池</li>
<li>异步任务在新线程中执行，不受主方法 @Transactional 影响</li>
<li>若异步操作需要事务，需在任务内部添加事务注解</li>
</ul>
<h4 id="23-异步任务具体操作">2.3 异步任务具体操作
</h4><ul>
<li>查询和删除分P视频</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoInfoFileQuery</span><span class="w"> </span><span class="n">videoInfoFileQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFileQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoFileQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFile</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoInfoFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFileMapper</span><span class="p">.</span><span class="na">selectList</span><span class="p">(</span><span class="n">videoInfoFileQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoFileMapper</span><span class="p">.</span><span class="na">deleteByParam</span><span class="p">(</span><span class="n">videoInfoFileQuery</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>删除关联投稿信息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoInfoFilePostQuery</span><span class="w"> </span><span class="n">videoInfoFilePostQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFilePostQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoFilePostQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoInfoFilePostMapper</span><span class="p">.</span><span class="na">deleteByParam</span><span class="p">(</span><span class="n">videoInfoFilePostQuery</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>删除弹幕数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoDanmuQuery</span><span class="w"> </span><span class="n">videoDanmuQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoDanmuQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoDanmuQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoDanmuMapper</span><span class="p">.</span><span class="na">deleteByParam</span><span class="p">(</span><span class="n">videoDanmuQuery</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>删除评论数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">VideoCommentQuery</span><span class="w"> </span><span class="n">videoCommentQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoCommentQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoCommentQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoCommentMapper</span><span class="p">.</span><span class="na">deleteByParam</span><span class="p">(</span><span class="n">videoCommentQuery</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>物理文件删除</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VideoInfoFile</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">videoInfoFileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">deleteDirectory</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getProjectFolder</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;删除文件失败，文件路径:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-异步设计优缺点分析">3. 异步设计优缺点分析
</h3><ul>
<li>优点：
<ul>
<li>响应速度快，主线程快速返回</li>
<li>IO密集型操作不影响核心业务</li>
<li>错误隔离，文件删除失败不影响主流程</li>
</ul>
</li>
<li>缺点及风险：
<ul>
<li>事务不一致：主事务提交后异步任务才执行，失败可能导致系统不一致</li>
<li>错误处理缺失：当前实现没有记录任务执行结果，无法追踪异步操作是否成功</li>
<li>资源竞争：固定线程数可能成为瓶颈，文件删除操作可能阻塞其他任务</li>
</ul>
</li>
</ul>
<h3 id="4-改进建议">4. 改进建议
</h3><ul>
<li>增强型线程池配置</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executorService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="c1">// 核心线程数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">20</span><span class="p">,</span><span class="w"> </span><span class="c1">// 最大线程数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span><span class="w"> </span><span class="c1">// 空闲线程存活时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">1000</span><span class="p">),</span><span class="w"> </span><span class="c1">// 有界队列</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">CallerRunsPolicy</span><span class="p">()</span><span class="w"> </span><span class="c1">// 拒绝策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>添加任务结果处理</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executorService</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 任务代码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w"> </span><span class="c1">// 带超时的等待</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>事务补偿机制</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@TransactionalEventListener</span><span class="p">(</span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AFTER_COMMIT</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleAfterCommit</span><span class="p">(</span><span class="n">VideoDeleteEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">asyncCleanService</span><span class="p">.</span><span class="na">cleanVideoResources</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>完善日志监控</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">executorService</span><span class="p">.</span><span class="na">execute</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MDC</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;traceId&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 任务代码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;视频资源清理完成: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;视频资源清理失败: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 发送告警或记录失败状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MDC</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">});</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5-总结-2">5. 总结
</h3><ul>
<li>该方法通过线程池实现了核心数据同步删除和资源异步清理，提升了响应速度和系统可扩展性。</li>
<li>关键改进方向：线程池参数优化、完善错误处理和状态跟踪、引入事务事件机制、增加监控和告警能力。</li>
<li>适合对实时性要求高但允许最终一致性的场景，是典型的&quot;快速响应+后台清理&quot;架构模式。</li>
</ul>
<hr>
<h2 id="异步线程池及-executorserviceexecute-详解">异步线程池及 executorService.execute 详解
</h2><h3 id="一异步线程池基础">一、异步线程池基础
</h3><h4 id="1-线程池核心概念">1. 线程池核心概念
</h4><ul>
<li>线程池是一种线程管理机制，维护多个线程，避免频繁创建和销毁线程带来的性能开销。</li>
<li>Java中主要通过 ExecutorService 及其实现类来使用线程池。</li>
</ul>
<h4 id="2-线程池关键参数">2. 线程池关键参数
</h4><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>参数</th>
          <th>说明</th>
          <th>示例值</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>corePoolSize</td>
          <td>核心线程数</td>
          <td>10</td>
      </tr>
      <tr>
          <td>maximumPoolSize</td>
          <td>最大线程数</td>
          <td>50</td>
      </tr>
      <tr>
          <td>keepAliveTime</td>
          <td>空闲线程存活时间</td>
          <td>60秒</td>
      </tr>
      <tr>
          <td>workQueue</td>
          <td>任务队列</td>
          <td>new LinkedBlockingQueue(1000)</td>
      </tr>
      <tr>
          <td>threadFactory</td>
          <td>线程创建工厂</td>
          <td>Executors.defaultThreadFactory()</td>
      </tr>
      <tr>
          <td>handler</td>
          <td>拒绝策略</td>
          <td>AbortPolicy</td>
      </tr>
  </tbody>
</table></div>
<h4 id="3-线程池工作流程">3. 线程池工作流程
</h4><ul>
<li>提交任务时，优先使用核心线程处理</li>
<li>核心线程全忙时，任务进入队列</li>
<li>队列满时，创建新线程（不超过最大线程数）</li>
<li>线程数达最大值且队列满时，触发拒绝策略</li>
</ul>
<h3 id="二executorserviceexecute-方法详解">二、executorService.execute 方法详解
</h3><h4 id="1-方法签名-1">1. 方法签名
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">Runnable</span><span class="w"> </span><span class="n">command</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-核心特点">2. 核心特点
</h4><ul>
<li>异步执行，立即返回，不阻塞调用线程</li>
<li>无返回值，适用于不需要获取结果的场景</li>
<li>异常处理：任务异常会传递给未捕获异常处理器</li>
</ul>
<h4 id="3-执行流程与示例">3. 执行流程与示例
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">executorService</span><span class="p">.</span><span class="na">execute</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 查询和删除分P视频</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">VideoInfoFileQuery</span><span class="w"> </span><span class="n">videoInfoFileQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoFileQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoFileQuery</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfoFile</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoInfoFileList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">videoInfoFileMapper</span><span class="p">.</span><span class="na">selectList</span><span class="p">(</span><span class="n">videoInfoFileQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoInfoFileMapper</span><span class="p">.</span><span class="na">deleteByParam</span><span class="p">(</span><span class="n">videoInfoFileQuery</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 删除其他关联数据...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 删除物理文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VideoInfoFile</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">videoInfoFileList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">deleteDirectory</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getProjectFolder</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;删除文件失败，文件路径:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getFilePath</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">});</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-execute-与-submit-区别">4. execute 与 submit 区别
</h4><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>对比项</th>
          <th>execute</th>
          <th>submit</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>返回值</td>
          <td>无</td>
          <td>Future对象</td>
      </tr>
      <tr>
          <td>异常处理</td>
          <td>直接抛出</td>
          <td>封装在Future中</td>
      </tr>
      <tr>
          <td>适用场景</td>
          <td>简单异步任务</td>
          <td>需要获取结果的任务</td>
      </tr>
  </tbody>
</table></div>
<ul>
<li>当前场景适合 execute：不需要获取清理操作的结果，简单日志记录已足够</li>
</ul>
<h3 id="三线程池配置优化建议">三、线程池配置优化建议
</h3><h4 id="1-当前实现的潜在问题">1. 当前实现的潜在问题
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executorService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>使用无界队列，可能导致 OOM</li>
<li>固定线程数无法应对突发流量</li>
<li>缺少合理的拒绝策略</li>
</ul>
<h4 id="2-推荐改进方案">2. 推荐改进方案
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executorService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">5</span><span class="p">,</span><span class="w">                              </span><span class="c1">// 核心线程数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">20</span><span class="p">,</span><span class="w">                             </span><span class="c1">// 最大线程数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span><span class="w">           </span><span class="c1">// 空闲线程存活时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">1000</span><span class="p">),</span><span class="w"> </span><span class="c1">// 有界队列</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">CallerRunsPolicy</span><span class="p">()</span><span class="w"> </span><span class="c1">// 拒绝策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>各参数说明：
<ul>
<li>corePoolSize=5：保持5个常驻线程</li>
<li>maxPoolSize=20：突发流量时可扩展到20线程</li>
<li>keepAliveTime=60s：空闲线程60秒后回收</li>
<li>有界队列(1000)：防止资源耗尽</li>
<li>CallerRunsPolicy：队列满时由调用线程执行任务</li>
</ul>
</li>
</ul>
<h3 id="四异常处理机制">四、异常处理机制
</h3><h4 id="1-当前实现的异常处理">1. 当前实现的异常处理
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">deleteDirectory</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;删除文件失败...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>仅记录日志，无恢复机制</li>
<li>异常不会传播到主线程</li>
</ul>
<h4 id="2-增强型异常处理方案">2. 增强型异常处理方案
</h4><ul>
<li>全局异常处理器</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">executorService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ...其他参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">AbortPolicy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">rejectedExecution</span><span class="p">(</span><span class="n">Runnable</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&#34;Task rejected: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">super</span><span class="p">.</span><span class="na">rejectedExecution</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Thread</span><span class="p">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="p">((</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;Uncaught exception in thread: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">});</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>封装任务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SafeRunnable</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="n">task</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SafeRunnable</span><span class="p">(</span><span class="n">Runnable</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">task</span><span class="p">.</span><span class="na">run</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;Task execution failed&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 可添加重试或补偿逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 使用方式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">executorService</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SafeRunnable</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 任务代码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="五性能监控建议">五、性能监控建议
</h3><h4 id="1-添加线程池监控">1. 添加线程池监控
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ScheduledExecutorService</span><span class="w"> </span><span class="n">monitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">monitor</span><span class="p">.</span><span class="na">scheduleAtFixedRate</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">tpe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ThreadPoolExecutor</span><span class="p">)</span><span class="w"> </span><span class="n">executorService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;Pool stats: active={}, queue={}/{}, completed={}&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tpe</span><span class="p">.</span><span class="na">getActiveCount</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tpe</span><span class="p">.</span><span class="na">getQueue</span><span class="p">().</span><span class="na">size</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tpe</span><span class="p">.</span><span class="na">getQueue</span><span class="p">().</span><span class="na">remainingCapacity</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tpe</span><span class="p">.</span><span class="na">getCompletedTaskCount</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">},</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>关键监控指标：
<ul>
<li>activeCount：活动线程数</li>
<li>queueSize：队列大小</li>
<li>completedTaskCount：已完成任务</li>
<li>rejectedCount：被拒绝任务</li>
</ul>
</li>
</ul>
<h3 id="六实际应用场景分析">六、实际应用场景分析
</h3><ul>
<li>当前视频删除场景特点：
<ul>
<li>耗时操作，允许延迟，最终一致性即可</li>
<li>非关键路径，主线程快速返回</li>
<li>可能失败，需日志记录</li>
</ul>
</li>
<li>适合使用线程池：
<ul>
<li>解耦主业务与清理操作，提升响应速度</li>
<li>通过线程池限制资源使用，方便扩展重试机制</li>
</ul>
</li>
<li>潜在风险及应对：
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>风险</th>
          <th>应对措施</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>线程泄漏</td>
          <td>有界队列，合理配置存活时间</td>
      </tr>
      <tr>
          <td>任务丢失</td>
          <td>添加持久化队列或任务记录</td>
      </tr>
      <tr>
          <td>资源竞争</td>
          <td>监控和动态调整线程池参数</td>
      </tr>
      <tr>
          <td>异常传播</td>
          <td>完善任务级别的异常处理</td>
      </tr>
  </tbody>
</table></div>
</li>
</ul>
<h3 id="七总结">七、总结
</h3><ul>
<li>选择合适的线程池类型（fixed/cached/custom）</li>
<li>使用有界队列，防止资源耗尽</li>
<li>配置合理的拒绝策略（如 CallerRunsPolicy）</li>
<li>完善异常处理（任务级别和全局级别）</li>
<li>添加监控，实时了解线程池状态</li>
<li>关键任务建议使用带返回值的 submit</li>
<li>在视频删除场景中，线程池异步处理清理任务是一种合理设计，但需注意参数配置、异常处理、日志记录和资源监控。</li>
</ul>
<hr>
<h2 id="elasticsearch搜索组件详解">Elasticsearch搜索组件详解
</h2><h3 id="一elasticsearch基础介绍">一、Elasticsearch基础介绍
</h3><p>Elasticsearch（简称ES）是一个分布式、RESTful风格的搜索和分析引擎，基于Apache Lucene构建。在视频平台中，主要用于：</p>
<ul>
<li>全文搜索：快速检索视频标题、标签等内容</li>
<li>结构化查询：支持多种条件组合查询</li>
<li>高亮显示：突出显示匹配的关键词</li>
<li>聚合统计：对播放量、弹幕数等进行统计分析</li>
</ul>
<p><strong>核心特性：</strong></p>
<ul>
<li>近实时搜索：数据变更后1秒内可搜索</li>
<li>分布式架构：支持水平扩展</li>
<li>丰富的API：RESTful接口和多种客户端</li>
<li>强大的查询DSL：灵活的查询语法</li>
</ul>
<h3 id="二组件配置解析">二、组件配置解析
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Value</span><span class="p">(</span><span class="s">&#34;${es.host.port:127.0.0.1:9200}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">esHostPort</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Value</span><span class="p">(</span><span class="s">&#34;${es.index.video.name:easylive_video}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">esIndexVideoName</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>esHostPort：ES服务器地址，默认本地9200端口</li>
<li>esIndexVideoName：视频索引名称，默认&quot;easylive_video&quot;</li>
</ul>
<h3 id="三核心方法详解">三、核心方法详解
</h3><h4 id="1-索引初始化方法-createindex">1. 索引初始化方法 createIndex()
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">createIndex</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">existIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isExistIndex</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">existIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CreateIndexRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateIndexRequest</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getEsIndexVideoName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">settings</span><span class="p">(</span><span class="s">&#34;{\&#34;analysis\&#34;: {\&#34;analyzer\&#34;: {\&#34;comma\&#34;: {\&#34;type\&#34;: \&#34;pattern\&#34;,\&#34;pattern\&#34;: \&#34;,\&#34;}}}}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">XContentType</span><span class="p">.</span><span class="na">JSON</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">mapping</span><span class="p">(</span><span class="s">&#34;{\&#34;properties\&#34;: {...}}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">XContentType</span><span class="p">.</span><span class="na">JSON</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CreateIndexResponse</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restHighLevelClient</span><span class="p">.</span><span class="na">indices</span><span class="p">().</span><span class="na">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">RequestOptions</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="p">.</span><span class="na">isAcknowledged</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;初始化es失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;初始化es失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;初始化es失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>字段映射说明：
<ul>
<li>videoId/userId：仅存储不索引</li>
<li>videoName：使用ik中文分词器</li>
<li>tags：使用自定义逗号分析器</li>
<li>数值/日期字段：仅存储不索引</li>
</ul>
</li>
</ul>
<h4 id="2-文档操作方法">2. 文档操作方法
</h4><ul>
<li>保存文档 saveDoc()</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveDoc</span><span class="p">(</span><span class="n">VideoInfo</span><span class="w"> </span><span class="n">videoInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">docExist</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">updateDoc</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">VideoInfoEsDto</span><span class="w"> </span><span class="n">dto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CopyTools</span><span class="p">.</span><span class="na">copy</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">,</span><span class="w"> </span><span class="n">VideoInfoEsDto</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dto</span><span class="p">.</span><span class="na">setCollectCount</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dto</span><span class="p">.</span><span class="na">setPlayCount</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dto</span><span class="p">.</span><span class="na">setDanmuCount</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">IndexRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IndexRequest</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getEsIndexVideoName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">id</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="p">.</span><span class="na">source</span><span class="p">(</span><span class="n">JsonUtils</span><span class="p">.</span><span class="na">convertObj2Json</span><span class="p">(</span><span class="n">dto</span><span class="p">),</span><span class="w"> </span><span class="n">XContentType</span><span class="p">.</span><span class="na">JSON</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">restHighLevelClient</span><span class="p">.</span><span class="na">index</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">RequestOptions</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;新增视频到es失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;保存失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>更新文档 updateDoc()</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateDoc</span><span class="p">(</span><span class="n">VideoInfo</span><span class="w"> </span><span class="n">videoInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfo</span><span class="p">.</span><span class="na">setLastUpdateTime</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoInfo</span><span class="p">.</span><span class="na">setCreateTime</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dataMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="w"> </span><span class="n">getter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;get&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">StringTools</span><span class="p">.</span><span class="na">upperCaseFirstLetter</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getter</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="n">value</span><span class="p">).</span><span class="na">isEmpty</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">dataMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">dataMap</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">UpdateRequest</span><span class="w"> </span><span class="n">updateRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UpdateRequest</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getEsIndexVideoName</span><span class="p">(),</span><span class="w"> </span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">updateRequest</span><span class="p">.</span><span class="na">doc</span><span class="p">(</span><span class="n">dataMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">restHighLevelClient</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">updateRequest</span><span class="p">,</span><span class="w"> </span><span class="n">RequestOptions</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;更新视频到es失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;保存失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>更新统计字段 updateDocCount()</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateDocCount</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">fieldName</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">UpdateRequest</span><span class="w"> </span><span class="n">updateRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UpdateRequest</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getEsIndexVideoName</span><span class="p">(),</span><span class="w"> </span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Script</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Script</span><span class="p">(</span><span class="n">ScriptType</span><span class="p">.</span><span class="na">INLINE</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;painless&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="s">&#34;ctx._source.&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fieldName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; += params.count&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonMap</span><span class="p">(</span><span class="s">&#34;count&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">updateRequest</span><span class="p">.</span><span class="na">script</span><span class="p">(</span><span class="n">script</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">restHighLevelClient</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">updateRequest</span><span class="p">,</span><span class="w"> </span><span class="n">RequestOptions</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;更新数量到es失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;保存失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>删除文档 delDoc()</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">delDoc</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">DeleteRequest</span><span class="w"> </span><span class="n">deleteRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DeleteRequest</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getEsIndexVideoName</span><span class="p">(),</span><span class="w"> </span><span class="n">videoId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">restHighLevelClient</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">deleteRequest</span><span class="p">,</span><span class="w"> </span><span class="n">RequestOptions</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;从es删除视频失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;删除视频失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-搜索方法-search">3. 搜索方法 search()
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">PaginationResultVO</span><span class="o">&lt;</span><span class="n">VideoInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">Boolean</span><span class="w"> </span><span class="n">highlight</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">keyword</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">orderType</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">pageNo</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">pageSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SearchSourceBuilder</span><span class="w"> </span><span class="n">sourceBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SearchSourceBuilder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sourceBuilder</span><span class="p">.</span><span class="na">query</span><span class="p">(</span><span class="n">QueryBuilders</span><span class="p">.</span><span class="na">multiMatchQuery</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;videoName&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;tags&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">highlight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">HighlightBuilder</span><span class="w"> </span><span class="n">highlightBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HighlightBuilder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">highlightBuilder</span><span class="p">.</span><span class="na">field</span><span class="p">(</span><span class="s">&#34;videoName&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="p">.</span><span class="na">preTags</span><span class="p">(</span><span class="s">&#34;&lt;span class=&#39;highlight&#39;&gt;&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="p">.</span><span class="na">postTags</span><span class="p">(</span><span class="s">&#34;&lt;/span&gt;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sourceBuilder</span><span class="p">.</span><span class="na">highlighter</span><span class="p">(</span><span class="n">highlightBuilder</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SearchOrderTypeEnum</span><span class="w"> </span><span class="n">orderEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SearchOrderTypeEnum</span><span class="p">.</span><span class="na">getByType</span><span class="p">(</span><span class="n">orderType</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">orderType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sourceBuilder</span><span class="p">.</span><span class="na">sort</span><span class="p">(</span><span class="n">orderEnum</span><span class="p">.</span><span class="na">getField</span><span class="p">(),</span><span class="w"> </span><span class="n">SortOrder</span><span class="p">.</span><span class="na">DESC</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sourceBuilder</span><span class="p">.</span><span class="na">sort</span><span class="p">(</span><span class="s">&#34;_score&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">SortOrder</span><span class="p">.</span><span class="na">DESC</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pageNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pageNo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">pageNo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pageSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pageSize</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">PageSize</span><span class="p">.</span><span class="na">SIZE20</span><span class="p">.</span><span class="na">getSize</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">pageSize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sourceBuilder</span><span class="p">.</span><span class="na">from</span><span class="p">((</span><span class="n">pageNo</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pageSize</span><span class="p">).</span><span class="na">size</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SearchRequest</span><span class="w"> </span><span class="n">searchRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SearchRequest</span><span class="p">(</span><span class="n">appConfig</span><span class="p">.</span><span class="na">getEsIndexVideoName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">searchRequest</span><span class="p">.</span><span class="na">source</span><span class="p">(</span><span class="n">sourceBuilder</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SearchResponse</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restHighLevelClient</span><span class="p">.</span><span class="na">search</span><span class="p">(</span><span class="n">searchRequest</span><span class="p">,</span><span class="w"> </span><span class="n">RequestOptions</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SearchHits</span><span class="w"> </span><span class="n">hits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getHits</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">hits</span><span class="p">.</span><span class="na">getHits</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">hit</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">VideoInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JsonUtils</span><span class="p">.</span><span class="na">convertJson2Obj</span><span class="p">(</span><span class="n">hit</span><span class="p">.</span><span class="na">getSourceAsString</span><span class="p">(),</span><span class="w"> </span><span class="n">VideoInfo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hit</span><span class="p">.</span><span class="na">getHighlightFields</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;videoName&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">info</span><span class="p">.</span><span class="na">setVideoName</span><span class="p">(</span><span class="n">hit</span><span class="p">.</span><span class="na">getHighlightFields</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;videoName&#34;</span><span class="p">).</span><span class="na">getFragments</span><span class="p">()</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="na">string</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">UserInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userInfoMapper</span><span class="p">.</span><span class="na">selectList</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">UserInfoQuery</span><span class="p">().</span><span class="na">setUserIdList</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">videoList</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">VideoInfo</span><span class="p">::</span><span class="n">getUserId</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">).</span><span class="na">stream</span><span class="p">().</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toMap</span><span class="p">(</span><span class="n">UserInfo</span><span class="p">::</span><span class="n">getUserId</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">.</span><span class="na">identity</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoList</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">video</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">UserInfo</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">video</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="n">video</span><span class="p">.</span><span class="na">setNickName</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaginationResultVO</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hits</span><span class="p">.</span><span class="na">getTotalHits</span><span class="p">().</span><span class="na">value</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pageSize</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pageNo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="na">ceil</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">hits</span><span class="p">.</span><span class="na">getTotalHits</span><span class="p">().</span><span class="na">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pageSize</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">videoList</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;查询视频失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;查询失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="四设计亮点分析">四、设计亮点分析
</h3><ul>
<li>优雅的异常处理：统一捕获异常并转换为业务异常，记录详细错误日志</li>
<li>智能的文档操作：自动判断文档存在性，增量更新非空字段</li>
<li>高效的统计更新：使用 painless 脚本实现原子操作</li>
<li>完整的分页支持：支持自定义页码和大小，返回总页数等元信息</li>
<li>关联数据补充：搜索后批量查询用户信息，减少N+1查询问题</li>
</ul>
<h3 id="五潜在优化建议">五、潜在优化建议
</h3><ul>
<li>批量操作支持</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BulkRequest</span><span class="w"> </span><span class="n">bulkRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BulkRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 添加多个操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">restHighLevelClient</span><span class="p">.</span><span class="na">bulk</span><span class="p">(</span><span class="n">bulkRequest</span><span class="p">,</span><span class="w"> </span><span class="n">RequestOptions</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>缓存用户信息：使用Redis缓存频繁访问的用户数据</li>
<li>搜索建议功能</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">SearchSourceBuilder</span><span class="p">.</span><span class="na">suggest</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SuggestBuilder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">addSuggestion</span><span class="p">(</span><span class="s">&#34;video-suggest&#34;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SuggestBuilders</span><span class="p">.</span><span class="na">completionSuggestion</span><span class="p">(</span><span class="s">&#34;videoName.suggest&#34;</span><span class="p">)));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>更复杂的高亮策略：支持多字段高亮，自定义高亮片段长度</li>
<li>索引别名支持：使用别名实现零停机索引重建</li>
</ul>
<h3 id="六初始化流程initrun">六、初始化流程（InitRun）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="p">(</span><span class="s">&#34;initRun&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InitRun</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ApplicationRunner</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">ApplicationArguments</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSource</span><span class="p">.</span><span class="na">getConnection</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">redisUtils</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">esSearchComponent</span><span class="p">.</span><span class="na">createIndex</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;服务启动成功&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;服务启动失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">exit</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>启动验证逻辑：
<ul>
<li>数据库连接测试</li>
<li>Redis连通性测试</li>
<li>ES索引初始化</li>
<li>任一失败则终止应用启动</li>
</ul>
</li>
</ul>
<p>该ES搜索组件为视频平台提供了完整、高效的搜索能力，从基础索引管理到复杂的搜索功能都有良好实现，是系统核心功能的重要支撑。</p>
<hr>
<h2 id="java反射机制及其在代码中的应用">Java反射机制及其在代码中的应用
</h2><h3 id="一反射基础概念">一、反射基础概念
</h3><p>反射（Reflection）是Java语言的一种动态能力，允许程序在运行时：</p>
<ul>
<li>获取类的完整结构信息</li>
<li>动态创建对象</li>
<li>访问和修改字段值</li>
<li>调用方法</li>
<li>操作数组</li>
</ul>
<p><strong>核心反射类：</strong></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>类</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Class</td>
          <td>表示类和接口</td>
      </tr>
      <tr>
          <td>Field</td>
          <td>表示类的字段</td>
      </tr>
      <tr>
          <td>Method</td>
          <td>表示类的方法</td>
      </tr>
      <tr>
          <td>Constructor</td>
          <td>表示类的构造方法</td>
      </tr>
  </tbody>
</table></div>
<h3 id="二代码中的反射解析">二、代码中的反射解析
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dataMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w"> </span><span class="c1">// 获取所有字段</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 构造getter方法名（如：getVideoName）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">methodName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;get&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">StringTools</span><span class="p">.</span><span class="na">upperCaseFirstLetter</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 获取Method对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getMethod</span><span class="p">(</span><span class="n">methodName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 调用getter方法获取值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 过滤非空值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">StringTools</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="na">toString</span><span class="p">()))</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">object</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">dataMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">object</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="三反射在此处的具体作用">三、反射在此处的具体作用
</h3><ol>
<li>动态获取对象属性
<ul>
<li>通过 getDeclaredFields() 获取所有字段</li>
<li>无需硬编码每个字段名，自动适应类结构变化</li>
</ul>
</li>
<li>通用属性拷贝
<ul>
<li>将对象属性转换为 Map 结构</li>
<li>为后续 ES 文档更新提供数据源</li>
</ul>
</li>
<li>空值过滤
<ul>
<li>跳过 null 值</li>
<li>对 String 类型额外检查空字符串</li>
</ul>
</li>
<li>类型安全处理
<ul>
<li>区分 String 和非 String 类型的不同处理逻辑</li>
</ul>
</li>
</ol>
<h3 id="四反射的工作流程">四、反射的工作流程
</h3><ul>
<li>获取类对象 → 获取字段列表 → 构造 getter 方法名 → 获取 Method → 调用 getter 获取值 → 过滤空值 → 填充 Map</li>
</ul>
<h3 id="五反射的优缺点">五、反射的优缺点
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>优点</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>灵活性</td>
          <td>动态处理未知类结构</td>
      </tr>
      <tr>
          <td>通用性</td>
          <td>可编写通用工具方法</td>
      </tr>
      <tr>
          <td>解耦</td>
          <td>不依赖具体实现类</td>
      </tr>
      <tr>
          <td>缺点</td>
          <td>说明</td>
      </tr>
      <tr>
          <td>性能开销</td>
          <td>比直接调用慢约50-100倍</td>
      </tr>
      <tr>
          <td>安全限制</td>
          <td>需要运行时权限</td>
      </tr>
      <tr>
          <td>代码复杂度</td>
          <td>错误难以在编译期发现</td>
      </tr>
  </tbody>
</table></div>
<h3 id="六性能优化建议">六、性能优化建议
</h3><ol>
<li>缓存反射结果</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 类级别缓存</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">methodCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">methodCache</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 填充method到map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}).</span><span class="na">get</span><span class="p">(</span><span class="n">methodName</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>使用高性能反射工具</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 例如Spring的BeanWrapper或Apache BeanUtils</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">BeanWrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BeanWrapperImpl</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapper</span><span class="p">.</span><span class="na">getPropertyValue</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>替代方案比较
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>方案</th>
          <th>性能</th>
          <th>易用性</th>
          <th>灵活性</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>直接调用</td>
          <td>★★★★★</td>
          <td>★★★</td>
          <td>★</td>
      </tr>
      <tr>
          <td>反射</td>
          <td>★★</td>
          <td>★★★</td>
          <td>★★★★★</td>
      </tr>
      <tr>
          <td>MethodHandle</td>
          <td>★★★★</td>
          <td>★★</td>
          <td>★★★★</td>
      </tr>
      <tr>
          <td>Bytecode生成</td>
          <td>★★★★★</td>
          <td>★</td>
          <td>★★★</td>
      </tr>
  </tbody>
</table></div>
</li>
</ol>
<h3 id="七在此场景下的必要性分析">七、在此场景下的必要性分析
</h3><ul>
<li>ES文档结构动态，字段可能频繁变化</li>
<li>通用更新逻辑，不同实体可复用相同代码</li>
<li>避免为每个字段编写 set/get，提高开发效率</li>
<li>性能影响可接受（ES更新频率低）</li>
<li>仅调用 getter 方法，无安全风险</li>
<li>建议添加注释说明意图，便于维护</li>
</ul>
<h3 id="八完整流程示例">八、完整流程示例
</h3><p>假设 VideoInfo 类有如下字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VideoInfo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">;</span><span class="w">    </span><span class="c1">// &#34;123&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoName</span><span class="p">;</span><span class="w"> </span><span class="c1">// &#34;Java教程&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w">   </span><span class="c1">// 1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">createTime</span><span class="p">;</span><span class="w">  </span><span class="c1">// new Date()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w">      </span><span class="c1">// &#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>反射处理后的 dataMap 将是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;videoId&#34;</span><span class="p">:</span><span class="w"> </span><span class="s">&#34;123&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;videoName&#34;</span><span class="p">:</span><span class="w"> </span><span class="s">&#34;Java教程&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;status&#34;</span><span class="p">:</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s">&#34;createTime&#34;</span><span class="p">:</span><span class="w"> </span><span class="n">Date对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>desc 字段因是空字符串被过滤</li>
<li>所有非空非 String 字段都被包含</li>
</ul>
<p>这种反射实现为 ES 文档更新提供了灵活、自动化的属性收集机制，是典型且合理的反射使用场景。</p>
<hr>
<h2 id="aop面向切面编程基础详解">AOP（面向切面编程）基础详解
</h2><p>面向切面编程（Aspect-Oriented Programming，AOP）是一种编程范式，用于将横切关注点（cross-cutting concerns）与核心业务逻辑分离。以下是AOP的核心概念和实现细节：</p>
<h3 id="一aop核心概念">一、AOP核心概念
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>概念</th>
          <th>说明</th>
          <th>示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>切面(Aspect)</td>
          <td>封装横切逻辑的模块</td>
          <td>日志记录、权限校验、事务管理</td>
      </tr>
      <tr>
          <td>连接点(JoinPoint)</td>
          <td>程序执行中的特定点</td>
          <td>方法调用、异常抛出、字段修改</td>
      </tr>
      <tr>
          <td>通知(Advice)</td>
          <td>切面在连接点的动作</td>
          <td>@Before、@After、@Around</td>
      </tr>
      <tr>
          <td>切点(Pointcut)</td>
          <td>匹配连接点的表达式</td>
          <td>execution(* com.service.<em>.</em>(..))</td>
      </tr>
      <tr>
          <td>目标对象(Target)</td>
          <td>被增强的对象</td>
          <td>普通的Service实例</td>
      </tr>
      <tr>
          <td>织入(Weaving)</td>
          <td>将切面应用到目标对象的过程</td>
          <td>编译期、类加载期、运行期</td>
      </tr>
  </tbody>
</table></div>
<h3 id="二spring-aop实现机制">二、Spring AOP实现机制
</h3><h4 id="1-代理模式">1. 代理模式
</h4><ul>
<li>Spring AOP默认使用动态代理：
<ul>
<li>JDK动态代理：基于接口（默认）</li>
<li>CGLIB代理：基于类继承（需启用）</li>
</ul>
</li>
</ul>
<h4 id="2-通知类型">2. 通知类型
</h4><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>通知类型</th>
          <th>注解</th>
          <th>执行时机</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>前置通知</td>
          <td>@Before</td>
          <td>方法执行前</td>
      </tr>
      <tr>
          <td>后置通知</td>
          <td>@AfterReturning</td>
          <td>方法正常返回后</td>
      </tr>
      <tr>
          <td>异常通知</td>
          <td>@AfterThrowing</td>
          <td>方法抛出异常后</td>
      </tr>
      <tr>
          <td>最终通知</td>
          <td>@After</td>
          <td>方法执行后（无论成败）</td>
      </tr>
      <tr>
          <td>环绕通知</td>
          <td>@Around</td>
          <td>包裹整个方法执行</td>
      </tr>
  </tbody>
</table></div>
<h3 id="三spring-aop实战">三、Spring AOP实战
</h3><h4 id="1-基本配置">1. 基本配置
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@EnableAspectJAutoProxy</span><span class="w"> </span><span class="c1">// 启用AOP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-切面定义示例">2. 切面定义示例
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Aspect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LogAspect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 定义切点（匹配service包下所有方法）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Pointcut</span><span class="p">(</span><span class="s">&#34;execution(* com.example.service.*.*(..))&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">servicePointcut</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Before</span><span class="p">(</span><span class="s">&#34;servicePointcut()&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">beforeLog</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">jp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">methodName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jp</span><span class="p">.</span><span class="na">getSignature</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;调用方法前: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">methodName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Around</span><span class="p">(</span><span class="s">&#34;servicePointcut()&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">aroundLog</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">pjp</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pjp</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;方法执行耗时: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;ms&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="四切点表达式语法">四、切点表达式语法
</h3><h4 id="1-基本语法">1. 基本语法
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">execution</span><span class="p">(</span><span class="o">[</span><span class="n">修饰符</span><span class="o">]</span><span class="w"> </span><span class="n">返回类型</span><span class="w"> </span><span class="o">[</span><span class="n">类名</span><span class="o">]</span><span class="p">.</span><span class="na">方法名</span><span class="p">(</span><span class="n">参数</span><span class="p">)</span><span class="w"> </span><span class="o">[</span><span class="n">异常</span><span class="o">]</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-常用表达式示例">2. 常用表达式示例
</h4><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>表达式</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>execution(public * *(..))</td>
          <td>所有public方法</td>
      </tr>
      <tr>
          <td>execution(* set*(..))</td>
          <td>所有set开头的方法</td>
      </tr>
      <tr>
          <td>execution(* com.service.<em>.</em>(..))</td>
          <td>service包下所有方法</td>
      </tr>
      <tr>
          <td>execution(* com.service..<em>.</em>(..))</td>
          <td>service包及其子包下所有方法</td>
      </tr>
      <tr>
          <td>@annotation(com.example.Log)</td>
          <td>带有@Log注解的方法</td>
      </tr>
  </tbody>
</table></div>
<h3 id="五获取上下文信息">五、获取上下文信息
</h3><h4 id="1-方法信息获取">1. 方法信息获取
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Before</span><span class="p">(</span><span class="s">&#34;execution(* com.service.*.*(..))&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">before</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">jp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 获取方法签名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MethodSignature</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MethodSignature</span><span class="p">)</span><span class="w"> </span><span class="n">jp</span><span class="p">.</span><span class="na">getSignature</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 获取参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jp</span><span class="p">.</span><span class="na">getArgs</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 获取目标对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jp</span><span class="p">.</span><span class="na">getTarget</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-返回值获取">2. 返回值获取
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@AfterReturning</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pointcut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;execution(* com.service.*.*(..))&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">returning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;result&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterReturning</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;返回结果: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-异常获取">3. 异常获取
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@AfterThrowing</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pointcut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;execution(* com.service.*.*(..))&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">throwing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;ex&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterThrowing</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;发生异常: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="六aop应用场景">六、AOP应用场景
</h3><ul>
<li>日志记录：自动记录方法调用信息</li>
<li>性能监控：统计方法执行时间</li>
<li>事务管理：声明式事务</li>
<li>权限控制：方法级权限校验</li>
<li>缓存管理：自动缓存方法结果</li>
<li>异常处理：统一异常捕获和处理</li>
</ul>
<h3 id="七spring-aop与aspectj对比">七、Spring AOP与AspectJ对比
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>Spring AOP</th>
          <th>AspectJ</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>实现方式</td>
          <td>动态代理</td>
          <td>字节码增强</td>
      </tr>
      <tr>
          <td>织入时机</td>
          <td>运行时</td>
          <td>编译期/类加载期</td>
      </tr>
      <tr>
          <td>性能</td>
          <td>较慢</td>
          <td>更快</td>
      </tr>
      <tr>
          <td>功能</td>
          <td>仅支持方法级</td>
          <td>支持字段、构造器等</td>
      </tr>
      <tr>
          <td>复杂度</td>
          <td>简单</td>
          <td>复杂</td>
      </tr>
      <tr>
          <td>依赖</td>
          <td>仅需Spring</td>
          <td>需特殊编译器</td>
      </tr>
  </tbody>
</table></div>
<h3 id="八最佳实践建议">八、最佳实践建议
</h3><ul>
<li>切面粒度控制：一个切面只关注一个横切关注点</li>
<li>切点表达式优化：避免过于宽泛的匹配</li>
<li>注意代理限制：
<ul>
<li>自调用问题（内部方法调用不走代理）</li>
<li>final方法不能被代理</li>
</ul>
</li>
<li>性能考量：
<ul>
<li>尽量减少切面逻辑的复杂度</li>
<li>环绕通知中的耗时操作考虑异步</li>
</ul>
</li>
<li>调试技巧：
<ul>
<li>使用AopContext.currentProxy()获取当前代理</li>
<li>通过@Order控制多个切面的执行顺序</li>
</ul>
</li>
</ul>
<h3 id="九完整示例方法级权限控制">九、完整示例：方法级权限控制
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 自定义权限注解</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">RequiresPermission</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="nf">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 切面实现</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Aspect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PermissionAspect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">AuthService</span><span class="w"> </span><span class="n">authService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Around</span><span class="p">(</span><span class="s">&#34;@annotation(requiresPermission)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">checkPermission</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">pjp</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">RequiresPermission</span><span class="w"> </span><span class="n">requiresPermission</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取当前用户</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentUser</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 检查权限</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authService</span><span class="p">.</span><span class="na">hasPermissions</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">requiresPermission</span><span class="p">.</span><span class="na">value</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccessDeniedException</span><span class="p">(</span><span class="s">&#34;权限不足&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">pjp</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 使用示例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequiresPermission</span><span class="p">(</span><span class="s">&#34;order:create&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">createOrder</span><span class="p">(</span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 业务逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过AOP，可以将权限校验逻辑与业务代码完全解耦，实现声明式的权限控制。</p>
<hr>
<h2 id="使用aop实现登录校验">使用AOP实现登录校验
</h2><h3 id="一aop基础概念">一、AOP基础概念
</h3><p>AOP（Aspect-Oriented Programming，面向切面编程）是一种编程范式，用于将横切关注点（如日志、事务、安全等）与业务逻辑分离。核心概念包括：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>概念</th>
          <th>说明</th>
          <th>对应代码示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>切面(Aspect)</td>
          <td>封装横切逻辑的模块</td>
          <td>GlobalOperationAspect类</td>
      </tr>
      <tr>
          <td>连接点(JoinPoint)</td>
          <td>程序执行中的特定点</td>
          <td>interceptorDo方法的JoinPoint参数</td>
      </tr>
      <tr>
          <td>通知(Advice)</td>
          <td>切面在特定连接点的动作</td>
          <td>@Before注解的方法</td>
      </tr>
      <tr>
          <td>切点(Pointcut)</td>
          <td>匹配连接点的表达式</td>
          <td>@annotation(com.easylive.web.annotation.GlobalInterceptor)</td>
      </tr>
      <tr>
          <td>引入(Introduction)</td>
          <td>向现有类添加新方法/属性</td>
          <td>本例未使用</td>
      </tr>
      <tr>
          <td>目标对象(Target)</td>
          <td>被通知的对象</td>
          <td>如loadAllVideo方法所在的Controller</td>
      </tr>
  </tbody>
</table></div>
<h3 id="二登录校验实现详解">二、登录校验实现详解
</h3><h4 id="1-定义注解标记需要拦截的方法">1. 定义注解（标记需要拦截的方法）
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Target</span><span class="p">({</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">,</span><span class="w"> </span><span class="n">ElementType</span><span class="p">.</span><span class="na">TYPE</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">GlobalInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkLogin</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>作为元数据标记需要拦截的方法</li>
<li>通过checkLogin属性灵活控制是否进行登录校验</li>
</ul>
<h4 id="2-实现切面逻辑">2. 实现切面逻辑
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Aspect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GlobalOperationAspect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedisUtils</span><span class="w"> </span><span class="n">redisUtils</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 定义切点：拦截带有GlobalInterceptor注解的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Before</span><span class="p">(</span><span class="s">&#34;@annotation(com.easylive.web.annotation.GlobalInterceptor)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">interceptorDo</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">MethodSignature</span><span class="p">)</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="na">getSignature</span><span class="p">()).</span><span class="na">getMethod</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">GlobalInterceptor</span><span class="w"> </span><span class="n">interceptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">GlobalInterceptor</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">interceptor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">interceptor</span><span class="p">.</span><span class="na">checkLogin</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">checkLogin</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkLogin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ServletRequestAttributes</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">getRequestAttributes</span><span class="p">()).</span><span class="na">getRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_WEB</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringTools</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">token</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_901</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="n">userInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TokenUserInfoDto</span><span class="p">)</span><span class="w"> </span><span class="n">redisUtils</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_TOKEN_WEB</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_901</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-业务方法应用">3. 业务方法应用
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GlobalInterceptor</span><span class="p">(</span><span class="n">checkLogin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseVO</span><span class="w"> </span><span class="nf">loadAllVideo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="n">userInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTokenUserInfoDto</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ...业务逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="三执行流程分析">三、执行流程分析
</h3><ul>
<li>方法被调用 → AOP切面拦截 → 判断注解属性 → 校验登录 → 通过则执行业务逻辑，否则抛出异常</li>
</ul>
<h3 id="四设计优势分析">四、设计优势分析
</h3><ul>
<li>解耦性：将安全校验与业务逻辑分离</li>
<li>灵活性：注解开关控制校验，可扩展其他规则</li>
<li>一致性：所有Controller方法统一处理</li>
<li>可维护性：校验逻辑集中管理，修改方便</li>
</ul>
<h3 id="五扩展应用场景">五、扩展应用场景
</h3><ol>
<li>添加权限校验</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">GlobalInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkLogin</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="nf">roles</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 切面中补充校验</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">interceptor</span><span class="p">.</span><span class="na">roles</span><span class="p">().</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">checkRoles</span><span class="p">(</span><span class="n">interceptor</span><span class="p">.</span><span class="na">roles</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>参数校验</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">validateParams</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="na">getArgs</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 实现参数校验逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>操作日志记录</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@AfterReturning</span><span class="p">(</span><span class="n">pointcut</span><span class="o">=</span><span class="s">&#34;@annotation(interceptor)&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">returning</span><span class="o">=</span><span class="s">&#34;result&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logOperation</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 记录方法调用日志</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="六性能优化建议-1">六、性能优化建议
</h3><ul>
<li>缓存注解解析结果</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">Method</span><span class="p">,</span><span class="w"> </span><span class="n">GlobalInterceptor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">GlobalInterceptor</span><span class="w"> </span><span class="n">interceptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">GlobalInterceptor</span><span class="p">.</span><span class="na">class</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>减少重复查询</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">request</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">USER_INFO_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">userInfo</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>异步日志记录</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Async</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">asyncLogOperation</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 异步记录日志</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="七常见问题解决方案">七、常见问题解决方案
</h3><ul>
<li>内部方法调用不走AOP：Spring AOP基于代理，内部调用不经过代理。解决：从ApplicationContext获取代理对象调用</li>
<li>多切面执行顺序：使用@Order注解控制顺序，默认按切面名称字母顺序</li>
<li>异常处理：使用@AfterThrowing处理特定异常，结合全局异常处理器统一处理</li>
</ul>
<p>这种基于注解和AOP的登录校验实现，是Spring生态中典型的权限控制方案，既保持了代码的简洁性，又提供了足够的灵活性和扩展能力。</p>
<hr>
<h2 id="登录校验的多种实现方式">登录校验的多种实现方式
</h2><h3 id="1-拦截器interceptor实现">1. 拦截器(Interceptor)实现
</h3><ul>
<li>基于Spring MVC的拦截器机制，在控制器方法执行前后进行拦截</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">checkToken</span><span class="p">(</span><span class="n">token</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">response</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">401</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebConfig</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">WebMvcConfigurer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addInterceptors</span><span class="p">(</span><span class="n">InterceptorRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">addInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AuthInterceptor</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">addPathPatterns</span><span class="p">(</span><span class="s">&#34;/api/**&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">excludePathPatterns</span><span class="p">(</span><span class="s">&#34;/api/login&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>优点：配置简单，基于URL模式匹配，执行时机早于AOP，性能稍好</li>
<li>缺点：无法基于方法粒度控制，难以获取方法上的元数据信息</li>
</ul>
<h3 id="2-过滤器filter实现">2. 过滤器(Filter)实现
</h3><ul>
<li>基于Servlet规范的过滤器，在最外层对请求进行过滤</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Filter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="p">)</span><span class="w"> </span><span class="n">request</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">checkToken</span><span class="p">(</span><span class="n">token</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">((</span><span class="n">HttpServletResponse</span><span class="p">)</span><span class="n">response</span><span class="p">).</span><span class="na">setStatus</span><span class="p">(</span><span class="n">401</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">chain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FilterConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">FilterRegistrationBean</span><span class="o">&lt;</span><span class="n">AuthFilter</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">authFilter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">FilterRegistrationBean</span><span class="o">&lt;</span><span class="n">AuthFilter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FilterRegistrationBean</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">reg</span><span class="p">.</span><span class="na">setFilter</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AuthFilter</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">reg</span><span class="p">.</span><span class="na">addUrlPatterns</span><span class="p">(</span><span class="s">&#34;/api/*&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">reg</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>优点：执行时机最早，性能最好，可处理静态资源等非Spring管理的请求</li>
<li>缺点：无法获取Spring上下文信息，配置粒度较粗</li>
</ul>
<h3 id="3-spring-security框架">3. Spring Security框架
</h3><ul>
<li>Spring官方安全框架，提供完整认证授权解决方案</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@EnableWebSecurity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityConfig</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">WebSecurityConfigurerAdapter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&#34;/api/public/**&#34;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">and</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addFilter</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JwtAuthFilter</span><span class="p">(</span><span class="n">authenticationManager</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JwtAuthFilter</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">OncePerRequestFilter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilterInternal</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// JWT校验逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>优点：功能全面，支持多种认证方式，内置CSRF防护，社区支持好</li>
<li>缺点：学习曲线陡峭，配置复杂</li>
</ul>
<h3 id="4-网关层统一校验">4. 网关层统一校验
</h3><ul>
<li>在API网关(如Spring Cloud Gateway)层统一处理认证</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">GlobalFilter</span><span class="p">,</span><span class="w"> </span><span class="n">Ordered</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">ServerWebExchange</span><span class="w"> </span><span class="n">exchange</span><span class="p">,</span><span class="w"> </span><span class="n">GatewayFilterChain</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getHeaders</span><span class="p">().</span><span class="na">getFirst</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">checkToken</span><span class="p">(</span><span class="n">token</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">exchange</span><span class="p">.</span><span class="na">getResponse</span><span class="p">().</span><span class="na">setStatusCode</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNAUTHORIZED</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getResponse</span><span class="p">().</span><span class="na">setComplete</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">exchange</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>优点：统一入口，避免每个服务重复实现，性能损耗最小化</li>
<li>缺点：需要额外维护网关服务，仅适用于微服务架构</li>
</ul>
<h3 id="5-方法参数解析器">5. 方法参数解析器
</h3><ul>
<li>通过自定义参数解析器自动注入用户信息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CurrentUserArgumentResolver</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerMethodArgumentResolver</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">supportsParameter</span><span class="p">(</span><span class="n">MethodParameter</span><span class="w"> </span><span class="n">parameter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">parameter</span><span class="p">.</span><span class="na">hasParameterAnnotation</span><span class="p">(</span><span class="n">CurrentUser</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">resolveArgument</span><span class="p">(</span><span class="n">MethodParameter</span><span class="w"> </span><span class="n">parameter</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="n">ModelAndViewContainer</span><span class="w"> </span><span class="n">mavContainer</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="n">NativeWebRequest</span><span class="w"> </span><span class="n">webRequest</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                 </span><span class="n">WebDataBinderFactory</span><span class="w"> </span><span class="n">binderFactory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">webRequest</span><span class="p">.</span><span class="na">getNativeRequest</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getUserFromToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 使用注解</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/userinfo&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">UserInfo</span><span class="w"> </span><span class="nf">getUserInfo</span><span class="p">(</span><span class="nd">@CurrentUser</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">userService</span><span class="p">.</span><span class="na">getInfo</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>优点：使用简洁，直接获取用户信息，与业务代码自然集成</li>
<li>缺点：只适用于获取当前用户场景，需要配合其他校验方式使用</li>
</ul>
<h3 id="6-对比总结">6. 对比总结
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>方式</th>
          <th>适用场景</th>
          <th>优点</th>
          <th>缺点</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>AOP注解</td>
          <td>方法粒度灵活控制</td>
          <td>灵活、可扩展性强</td>
          <td>性能稍差</td>
      </tr>
      <tr>
          <td>拦截器</td>
          <td>URL统一校验</td>
          <td>配置简单、性能较好</td>
          <td>粒度较粗</td>
      </tr>
      <tr>
          <td>过滤器</td>
          <td>最外层请求过滤</td>
          <td>性能最好</td>
          <td>无法用Spring特性</td>
      </tr>
      <tr>
          <td>Spring Security</td>
          <td>完整安全方案</td>
          <td>功能全面</td>
          <td>复杂、学习成本高</td>
      </tr>
      <tr>
          <td>API网关</td>
          <td>微服务架构</td>
          <td>统一管理、性能好</td>
          <td>需额外基础设施</td>
      </tr>
      <tr>
          <td>参数解析器</td>
          <td>自动注入用户信息</td>
          <td>使用简洁</td>
          <td>需配合其他方式</td>
      </tr>
  </tbody>
</table></div>
<h3 id="7-选择建议">7. 选择建议
</h3><ul>
<li>单体应用：AOP注解 + 拦截器组合</li>
<li>微服务架构：网关统一认证 + 服务内AOP补充</li>
<li>高安全性要求：Spring Security</li>
<li>高性能要求：过滤器 + 参数解析器</li>
<li>快速开发：AOP注解方式最简单直接</li>
</ul>
<p>实际项目中，通常会组合使用多种方式，比如用过滤器做基础校验，AOP做细粒度控制，参数解析器方便获取用户信息。</p>
<hr>
<h2 id="jwt实现登录校验的完整方案">JWT实现登录校验的完整方案
</h2><h3 id="一jwt基础概念">一、JWT基础概念
</h3><h4 id="1-jwt组成结构">1. JWT组成结构
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">header</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">signature</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Header：包含令牌类型和签名算法</li>
<li>Payload：存放用户信息和其他数据</li>
<li>Signature：防止令牌被篡改的签名</li>
</ul>
<h4 id="2-工作流程">2. 工作流程
</h4><ul>
<li>用户登录 → 服务端生成JWT → 客户端存储并携带JWT访问API → 服务端校验JWT</li>
</ul>
<h3 id="二spring-boot实现方案">二、Spring Boot实现方案
</h3><h4 id="1-添加依赖">1. 添加依赖
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jjwt-api<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>0.11.5<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jjwt-impl<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>0.11.5<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jjwt-jackson<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>0.11.5<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-jwt工具类">2. JWT工具类
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JwtTokenUtil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&#34;${jwt.secret}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">secret</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&#34;${jwt.expiration}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">expiration</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 生成令牌</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">claims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setClaims</span><span class="p">(</span><span class="n">claims</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="n">username</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setIssuedAt</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setExpiration</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">expiration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">1000</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">getSigningKey</span><span class="p">(),</span><span class="w"> </span><span class="n">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS256</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">compact</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 验证令牌</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parserBuilder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">getSigningKey</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">parseClaimsJws</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 从令牌获取用户名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getUsernameFromToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parserBuilder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">getSigningKey</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">parseClaimsJws</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">getBody</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">getSubject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SecretKey</span><span class="w"> </span><span class="nf">getSigningKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Keys</span><span class="p">.</span><span class="na">hmacShaKeyFor</span><span class="p">(</span><span class="n">secret</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-登录接口实现">3. 登录接口实现
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&#34;/auth&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">JwtTokenUtil</span><span class="w"> </span><span class="n">jwtTokenUtil</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&#34;/login&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">login</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">LoginRequest</span><span class="w"> </span><span class="n">loginRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">authenticated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authenticate</span><span class="p">(</span><span class="n">loginRequest</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                          </span><span class="n">loginRequest</span><span class="p">.</span><span class="na">getPassword</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">authenticated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNAUTHORIZED</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtTokenUtil</span><span class="p">.</span><span class="na">generateToken</span><span class="p">(</span><span class="n">loginRequest</span><span class="p">.</span><span class="na">getUsername</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;token&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;admin&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&#34;123456&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">password</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-jwt校验过滤器">4. JWT校验过滤器
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JwtAuthFilter</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">OncePerRequestFilter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">JwtTokenUtil</span><span class="w"> </span><span class="n">jwtTokenUtil</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilterInternal</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                  </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">token</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;Bearer &#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">7</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jwtTokenUtil</span><span class="p">.</span><span class="na">validateToken</span><span class="p">(</span><span class="n">jwt</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtTokenUtil</span><span class="p">.</span><span class="na">getUsernameFromToken</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">setAuthentication</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5-安全配置">5. 安全配置
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@EnableWebSecurity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityConfig</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">WebSecurityConfigurerAdapter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">JwtAuthFilter</span><span class="w"> </span><span class="n">jwtAuthFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&#34;/auth/login&#34;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">and</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">sessionManagement</span><span class="p">().</span><span class="na">sessionCreationPolicy</span><span class="p">(</span><span class="n">SessionCreationPolicy</span><span class="p">.</span><span class="na">STATELESS</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">and</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addFilterBefore</span><span class="p">(</span><span class="n">jwtAuthFilter</span><span class="p">,</span><span class="w"> </span><span class="n">UsernamePasswordAuthenticationFilter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="三客户端使用方式">三、客户端使用方式
</h3><h4 id="1-登录获取token">1. 登录获取token
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">POST /auth/login
</span></span><span class="line"><span class="cl">Content-Type: application/json
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;username&#34;: &#34;admin&#34;,
</span></span><span class="line"><span class="cl">  &#34;password&#34;: &#34;123456&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>响应示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImlhdCI6MTY1...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-访问受保护api">2. 访问受保护API
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GET /api/protected
</span></span><span class="line"><span class="cl">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="四高级功能实现">四、高级功能实现
</h3><ol>
<li>令牌刷新机制</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&#34;/refresh&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">refreshToken</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">oldToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&#34;Authorization&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oldToken</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">oldToken</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&#34;Bearer &#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtTokenUtil</span><span class="p">.</span><span class="na">getUsernameFromToken</span><span class="p">(</span><span class="n">oldToken</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">7</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">newToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtTokenUtil</span><span class="p">.</span><span class="na">generateToken</span><span class="p">(</span><span class="n">username</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 返回新token...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">badRequest</span><span class="p">().</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>黑名单实现（注销功能）</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tokenBlacklist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invalidateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tokenBlacklist</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isTokenValid</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="n">tokenBlacklist</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">validateToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>多设备登录管理</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">userDeviceTokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ...生成token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">userDeviceTokens</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">()).</span><span class="na">add</span><span class="p">(</span><span class="n">deviceId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">token</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logoutDevice</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">userDeviceTokens</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">emptySet</span><span class="p">()).</span><span class="na">remove</span><span class="p">(</span><span class="n">deviceId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="五安全最佳实践">五、安全最佳实践
</h3><ul>
<li>使用HTTPS：防止令牌被截获</li>
<li>设置合理过期时间：通常2小时-7天</li>
<li>不要存储敏感信息：JWT内容可以被解码</li>
<li>使用强密钥：至少256位的密钥</li>
<li>实现令牌刷新：减少长期有效的风险</li>
<li>防范CSRF：即使JWT不易受CSRF影响也应防范</li>
<li>日志监控：记录异常令牌尝试</li>
</ul>
<h3 id="六与其他方案的对比">六、与其他方案的对比
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>特性</th>
          <th>JWT</th>
          <th>传统Session</th>
          <th>OAuth2</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>状态</td>
          <td>无状态</td>
          <td>有状态</td>
          <td>可无状态</td>
      </tr>
      <tr>
          <td>性能</td>
          <td>高</td>
          <td>中等</td>
          <td>中等</td>
      </tr>
      <tr>
          <td>扩展性</td>
          <td>强</td>
          <td>弱</td>
          <td>强</td>
      </tr>
      <tr>
          <td>适用场景</td>
          <td>API/微服务</td>
          <td>传统Web应用</td>
          <td>第三方登录</td>
      </tr>
      <tr>
          <td>实现复杂度</td>
          <td>简单</td>
          <td>简单</td>
          <td>复杂</td>
      </tr>
  </tbody>
</table></div>
<p>JWT特别适合现代前后端分离架构和微服务场景，它的无状态特性可以显著减轻服务器压力，简化横向扩展。但对于需要即时撤销令牌的场景，需要额外实现黑名单机制。</p>
<hr>
<h2 id="通过aop实现消息通知">通过AOP实现消息通知
</h2><h3 id="一整体设计思路">一、整体设计思路
</h3><p>本实现通过自定义注解 <code>@RecordUserMessage</code> 和 AOP 切面 <code>UserMessageOperationAspect</code>，在用户执行特定操作（如点赞、收藏）后自动记录消息通知。</p>
<ul>
<li>注解驱动：通过注解标记需要记录消息的方法</li>
<li>参数自动提取：从方法参数中智能提取消息相关内容</li>
<li>类型动态判断：根据操作类型自动调整消息类型</li>
<li>用户信息自动获取：从请求头中解析当前用户</li>
</ul>
<h3 id="二核心组件详解">二、核心组件详解
</h3><h4 id="1-自定义注解-recordusermessage">1. 自定义注解 @RecordUserMessage
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Target</span><span class="p">({</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">,</span><span class="w"> </span><span class="n">ElementType</span><span class="p">.</span><span class="na">TYPE</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">RecordUserMessage</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MessageTypeEnum</span><span class="w"> </span><span class="nf">messageType</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>标记需要记录用户消息的 Controller 方法</li>
<li>指定基本消息类型（可在切面中根据条件调整）</li>
</ul>
<h4 id="2-aop切面实现-usermessageoperationaspect">2. AOP切面实现 UserMessageOperationAspect
</h4><ul>
<li>环绕通知主体</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Around</span><span class="p">(</span><span class="s">&#34;@annotation(com.easylive.annotation.RecordUserMessage)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseVO</span><span class="w"> </span><span class="nf">interceptorDo</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ResponseVO</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ResponseVO</span><span class="p">)</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">MethodSignature</span><span class="p">)</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="na">getSignature</span><span class="p">()).</span><span class="na">getMethod</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RecordUserMessage</span><span class="w"> </span><span class="n">recordUserMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">RecordUserMessage</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">recordUserMessage</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">saveUserMessage</span><span class="p">(</span><span class="n">recordUserMessage</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="na">getArgs</span><span class="p">(),</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">getParameters</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">BusinessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ...异常处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>使用 @Around 确保在方法执行后处理</p>
</li>
<li>
<p>通过 ProceedingJoinPoint 获取方法参数和注解</p>
</li>
<li>
<p>保持原方法的返回结果不变</p>
</li>
<li>
<p>消息保存逻辑</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveUserMessage</span><span class="p">(</span><span class="n">RecordUserMessage</span><span class="w"> </span><span class="n">recordUserMessage</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">Parameter</span><span class="o">[]</span><span class="w"> </span><span class="n">parameters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractParameter</span><span class="p">(</span><span class="n">PARAMETERS_VIDEO_ID</span><span class="p">,</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">actionType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractParameter</span><span class="p">(</span><span class="n">PARAMETERS_ACTION_TYPE</span><span class="p">,</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">replyCommentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractParameter</span><span class="p">(</span><span class="n">PARAMETERS_REPLY_COMMENT_ID</span><span class="p">,</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractParameter</span><span class="p">(</span><span class="n">PARAMETERS_CONTENT</span><span class="p">,</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MessageTypeEnum</span><span class="w"> </span><span class="n">messageTypeEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recordUserMessage</span><span class="p">.</span><span class="na">messageType</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UserActionTypeEnum</span><span class="p">.</span><span class="na">VIDEO_COLLECT</span><span class="p">.</span><span class="na">getType</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">actionType</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">messageTypeEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageTypeEnum</span><span class="p">.</span><span class="na">COLLECTION</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="n">userInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTokenUserInfoDto</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">userMessageService</span><span class="p">.</span><span class="na">saveUserMessage</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">videoId</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">userInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">messageTypeEnum</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">content</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">replyCommentId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>参数提取技巧：通过参数名匹配（依赖编译时保留参数名），支持多种参数类型</li>
</ul>
<h4 id="3-用户信息获取">3. 用户信息获取
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="nf">getTokenUserInfoDto</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ServletRequestAttributes</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">getRequestAttributes</span><span class="p">()).</span><span class="na">getRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_WEB</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getTokenInfo</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="三工作流程分析">三、工作流程分析
</h3><ul>
<li>方法被调用 → 切面拦截 → 执行业务逻辑 → 提取参数/用户信息 → 保存消息通知</li>
</ul>
<h3 id="四关键实现细节">四、关键实现细节
</h3><h4 id="1-参数名匹配机制">1. 参数名匹配机制
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">extractParameter</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">paramName</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">Parameter</span><span class="o">[]</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">params</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">paramName</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">getName</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>需编译时保留参数名（-parameters编译选项）</li>
<li>实际代码应添加类型安全检查</li>
</ul>
<h4 id="2-消息类型动态判断">2. 消息类型动态判断
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UserActionTypeEnum</span><span class="p">.</span><span class="na">VIDEO_COLLECT</span><span class="p">.</span><span class="na">getType</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">actionType</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">messageTypeEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageTypeEnum</span><span class="p">.</span><span class="na">COLLECTION</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>允许通过注解指定默认类型，也可根据运行时条件调整类型</li>
</ul>
<h4 id="3-异常处理策略">3. 异常处理策略
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 业务逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">BusinessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;全局拦截器异常&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;全局拦截器异常&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_500</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>区分业务异常和系统异常，统一错误处理</li>
</ul>
<h3 id="五使用示例">五、使用示例
</h3><h4 id="1-基础用法">1. 基础用法
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RecordUserMessage</span><span class="p">(</span><span class="n">messageType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageTypeEnum</span><span class="p">.</span><span class="na">LIKE</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseVO</span><span class="w"> </span><span class="nf">likeVideo</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 点赞逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">success</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-带参数自动提取">2. 带参数自动提取
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RecordUserMessage</span><span class="p">(</span><span class="n">messageType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageTypeEnum</span><span class="p">.</span><span class="na">COMMENT</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseVO</span><span class="w"> </span><span class="nf">addComment</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@RequestParam</span><span class="p">(</span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">replyCommentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 评论逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">success</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>切面将自动提取 videoId、content、replyCommentId 用于构建消息记录</li>
</ul>
<h3 id="六设计优势">六、设计优势
</h3><ul>
<li>低侵入性：业务代码只需添加注解</li>
<li>集中管理：所有消息记录逻辑在切面中维护</li>
<li>灵活扩展：轻松支持新的消息类型</li>
<li>自动关联：自动关联操作内容和用户信息</li>
<li>一致处理：统一的消息记录方式和错误处理</li>
</ul>
<h3 id="七潜在优化方向">七、潜在优化方向
</h3><ol>
<li>性能优化</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 缓存方法参数索引</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MethodParamCache</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">videoIdParam</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">actionTypeParam</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">videoIdIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">actionTypeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ConcurrentMap</span><span class="o">&lt;</span><span class="n">Method</span><span class="p">,</span><span class="w"> </span><span class="n">MethodParamCache</span><span class="o">&gt;</span><span class="w"> </span><span class="n">paramCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>异步处理</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Async</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">asyncSaveUserMessage</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 异步保存消息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>更智能的参数提取</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 通过注解标记重要参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseVO</span><span class="w"> </span><span class="nf">addComment</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@MessageParam</span><span class="p">(</span><span class="s">&#34;videoId&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@MessageParam</span><span class="p">(</span><span class="s">&#34;content&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>消息内容模板化</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">message.template.like</span><span class="o">=</span><span class="s">{user}点赞了你的视频</span>
</span></span><span class="line"><span class="cl"><span class="na">message.template.comment</span><span class="o">=</span><span class="s">{user}评论了你的视频: {content}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="八与其他方案的对比">八、与其他方案的对比
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>方案</th>
          <th>优点</th>
          <th>缺点</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>AOP注解</td>
          <td>解耦、灵活、易扩展</td>
          <td>学习曲线稍高</td>
      </tr>
      <tr>
          <td>手动调用</td>
          <td>直观、简单</td>
          <td>代码重复、易遗漏</td>
      </tr>
      <tr>
          <td>事件驱动</td>
          <td>完全解耦、异步友好</td>
          <td>复杂度高、调试困难</td>
      </tr>
      <tr>
          <td>拦截器</td>
          <td>执行时机早</td>
          <td>难以获取业务参数</td>
      </tr>
  </tbody>
</table></div>
<ul>
<li>该AOP实现方案在灵活性和易用性之间取得良好平衡，适合多业务操作的消息通知场景。</li>
</ul>
<hr>
<h2 id="实战aop时需要重点关注的方面">实战AOP时需要重点关注的方面
</h2><h3 id="一切面设计与实现要点">一、切面设计与实现要点
</h3><ol>
<li>注解设计规范</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Target</span><span class="p">({</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">,</span><span class="w"> </span><span class="n">ElementType</span><span class="p">.</span><span class="na">TYPE</span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">RecordUserMessage</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MessageTypeEnum</span><span class="w"> </span><span class="nf">messageType</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>确保 @Retention(RetentionPolicy.RUNTIME)</li>
<li>可考虑设置默认值</li>
<li>属性命名要清晰表达业务意图</li>
</ul>
<ol start="2">
<li>切面作用范围控制</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Around</span><span class="p">(</span><span class="s">&#34;@annotation(com.easylive.annotation.RecordUserMessage)&#34;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>精确限定切点表达式，避免拦截不需要的方法</li>
<li>可用 within() 限定包路径</li>
</ul>
<h3 id="二参数处理关键点">二、参数处理关键点
</h3><ol>
<li>参数名匹配机制</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveUserMessage</span><span class="p">(...,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">Parameter</span><span class="o">[]</span><span class="w"> </span><span class="n">parameters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">parameters</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PARAMETERS_VIDEO_ID</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">parameters</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">getName</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">videoId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//...其他参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>编译时保留参数名（-parameters）</li>
<li>添加类型检查，避免类型转换异常</li>
<li>可用ConcurrentHashMap缓存参数索引提升性能</li>
</ul>
<ol start="2">
<li>敏感参数处理</li>
</ol>
<ul>
<li>对content等参数进行脱敏处理</li>
<li>大文本内容可截断后存入消息记录</li>
</ul>
<h3 id="三异常处理策略">三、异常处理策略
</h3><ol>
<li>异常分类处理</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">BusinessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;全局拦截器异常&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;全局拦截器异常&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_500</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>区分业务异常和系统异常，避免吞没原始异常堆栈</li>
<li>可添加错误码转换逻辑</li>
</ul>
<ol start="2">
<li>事务边界注意</li>
</ol>
<ul>
<li>切面在方法执行后记录消息，若方法有事务：
<ul>
<li>确保消息记录与业务操作在同一事务（@Transactional）</li>
<li>或明确分离事务（异步记录消息）</li>
</ul>
</li>
</ul>
<h3 id="四性能优化方向">四、性能优化方向
</h3><ol>
<li>反射操作优化</li>
</ol>
<ul>
<li>缓存Method对象和参数索引</li>
<li>可用Spring的CacheableOperation机制</li>
</ul>
<ol start="2">
<li>异步处理考虑</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Async</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">asyncSaveUserMessage</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">userMessageService</span><span class="p">.</span><span class="na">saveUserMessage</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>适用于对实时性要求不高或高并发场景</li>
</ul>
<h3 id="五安全注意事项">五、安全注意事项
</h3><ol>
<li>用户信息获取</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">TokenUserInfoDto</span><span class="w"> </span><span class="nf">getTokenUserInfoDto</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ServletRequestAttributes</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">getRequestAttributes</span><span class="p">()).</span><span class="na">getRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_WEB</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getTokenInfo</span><span class="p">(</span><span class="n">token</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>验证token有效性（是否过期、是否被撤销）</li>
<li>敏感操作可二次验证</li>
</ul>
<ol start="2">
<li>权限校验补充</li>
</ol>
<ul>
<li>可在切面中添加基础权限校验，与Spring Security集成</li>
</ul>
<h3 id="六可维护性设计">六、可维护性设计
</h3><ol>
<li>消息类型扩展</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UserActionTypeEnum</span><span class="p">.</span><span class="na">VIDEO_COLLECT</span><span class="p">.</span><span class="na">getType</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">actionType</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">messageTypeEnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageTypeEnum</span><span class="p">.</span><span class="na">COLLECTION</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>可用策略模式处理不同类型消息的构建</li>
<li>配置化消息模板</li>
</ul>
<ol start="2">
<li>日志记录规范</li>
</ol>
<ul>
<li>添加操作流水号，记录详细上下文信息</li>
</ul>
<h3 id="七与其他组件的协作">七、与其他组件的协作
</h3><ol>
<li>与拦截器的分工</li>
</ol>
<ul>
<li>拦截器处理通用校验（登录、基础参数）</li>
<li>AOP处理业务相关横切逻辑（如消息记录）</li>
</ul>
<ol start="2">
<li>与事务的配合</li>
</ol>
<ul>
<li>注意@Transactional和@Around的执行顺序</li>
<li>可用@Order注解明确控制</li>
</ul>
<h3 id="八测试相关建议">八、测试相关建议
</h3><ol>
<li>切面单元测试</li>
</ol>
<ul>
<li>模拟各种参数组合，测试异常场景，验证消息记录正确性</li>
</ul>
<ol start="2">
<li>集成测试关注</li>
</ol>
<ul>
<li>多切面共存时的执行顺序，高并发下线程安全，与事务的交互</li>
</ul>
<h3 id="九您的实现亮点">九、您的实现亮点
</h3><ul>
<li>职责划分清晰，消息记录与业务解耦</li>
<li>灵活类型判断，actionType动态调整消息类型</li>
<li>完善异常处理，区分业务/系统异常</li>
<li>上下文信息自动获取</li>
</ul>
<h3 id="十总结-checklist">十、总结 Checklist
</h3><ul>
<li>✅ 注解保留策略正确</li>
<li>✅ 切点表达式精确匹配目标方法</li>
<li>✅ 参数名匹配考虑编译选项</li>
<li>✅ 异常处理覆盖所有场景</li>
<li>✅ 性能敏感操作有缓存机制</li>
<li>✅ 事务边界明确划分</li>
<li>✅ 安全校验充分</li>
<li>✅ 日志追踪完善</li>
<li>✅ 易于扩展新消息类型</li>
<li>✅ 测试用例覆盖各种边界情况</li>
</ul>
<p>通过关注这些关键点，可确保AOP实现既满足需求，又具备良好可维护性和扩展性。</p>
<hr>
<h2 id="定时任务-每日数据统计和临时文件清理">定时任务-每日数据统计和临时文件清理
</h2><h3 id="一系统功能概述">一、系统功能概述
</h3><ul>
<li>包含每日数据统计和临时文件清理两个核心定时任务</li>
<li>采用Spring Boot @Scheduled注解实现</li>
<li>任务职责分离，便于维护和扩展</li>
</ul>
<h3 id="二每日数据统计任务-statisticsdata">二、每日数据统计任务 statisticsData()
</h3><ul>
<li>执行时机：每天凌晨0点（0 0 0 * * ?）</li>
<li>主要流程：
<ul>
<li>
<ol>
<li>从Redis获取昨日各视频播放量</li>
</ol>
</li>
<li>
<ol start="2">
<li>关联视频与用户信息</li>
</ol>
</li>
<li>
<ol start="3">
<li>按用户聚合播放量</li>
</ol>
</li>
<li>
<ol start="4">
<li>统计粉丝、评论、互动等多维度数据</li>
</ol>
</li>
<li>
<ol start="5">
<li>批量插入或更新统计结果到数据库</li>
</ol>
</li>
</ul>
</li>
<li>关键代码：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 0 0 * * ?&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">statisticsData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 准备数据结构</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">StatisticsInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">statisticsInfoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">statisticsDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateUtil</span><span class="p">.</span><span class="na">getBeforeDayDate</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 昨天日期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 播放量统计（Redis → DB）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoPlayCountMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisComponent</span><span class="p">.</span><span class="na">getVideoPlayCount</span><span class="p">(</span><span class="n">statisticsDate</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">playVideoKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoPlayCountMap</span><span class="p">.</span><span class="na">keySet</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">lastIndexOf</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">VideoInfoQuery</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VideoInfoQuery</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">query</span><span class="p">.</span><span class="na">setVideoIdArray</span><span class="p">(</span><span class="n">playVideoKeys</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">VideoInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoInfoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfoMapper</span><span class="p">.</span><span class="na">selectList</span><span class="p">(</span><span class="n">query</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoCountMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfoList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">groupingBy</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">VideoInfo</span><span class="p">::</span><span class="n">getUserId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Collectors</span><span class="p">.</span><span class="na">summingInt</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">String</span><span class="w"> </span><span class="n">redisKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">statisticsDate</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoPlayCountMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">redisKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">videoCountMap</span><span class="p">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">StatisticsInfo</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StatisticsInfo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">setStatisticsDate</span><span class="p">(</span><span class="n">statisticsDate</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">setDataType</span><span class="p">(</span><span class="n">StatisticsTypeEnum</span><span class="p">.</span><span class="na">PLAY</span><span class="p">.</span><span class="na">getType</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="na">setStatisticsCount</span><span class="p">(</span><span class="n">count</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">statisticsInfoList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addFansData</span><span class="p">(</span><span class="n">statisticsDate</span><span class="p">,</span><span class="w"> </span><span class="n">statisticsInfoList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addCommentData</span><span class="p">(</span><span class="n">statisticsDate</span><span class="p">,</span><span class="w"> </span><span class="n">statisticsInfoList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addInteractionData</span><span class="p">(</span><span class="n">statisticsDate</span><span class="p">,</span><span class="w"> </span><span class="n">statisticsInfoList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">statisticsInfoMapper</span><span class="p">.</span><span class="na">insertOrUpdateBatch</span><span class="p">(</span><span class="n">statisticsInfoList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>技术要点：
<ul>
<li>高频数据先写入Redis，定时批量同步到DB</li>
<li>多维度统计，便于后续扩展</li>
<li>批量操作减少数据库压力</li>
</ul>
</li>
</ul>
<h4 id="代码结构与聚合逻辑解析">代码结构与聚合逻辑解析
</h4><ul>
<li>按用户ID分组统计所有视频的总播放量：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">videoCountMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoInfoList</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">groupingBy</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VideoInfo</span><span class="p">::</span><span class="n">getUserId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Collectors</span><span class="p">.</span><span class="na">summingInt</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">redisKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">REDIS_KEY_VIDEO_PLAY_COUNT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">statisticsDate</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoPlayCountMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">redisKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">));</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>设计优势：
<ul>
<li>单次遍历完成分组与求和，效率高</li>
<li>逻辑清晰，易于维护和扩展</li>
<li>可通过parallelStream并行处理大数据量</li>
</ul>
</li>
</ul>
<h3 id="三临时文件清理任务-deltempfile">三、临时文件清理任务 delTempFile()
</h3><ul>
<li>执行时机：每分钟执行一次（0 */1 * * * ?）</li>
<li>主要流程：
<ul>
<li>
<ol>
<li>构建临时文件夹路径</li>
</ol>
</li>
<li>
<ol start="2">
<li>获取两天前的日期作为基准</li>
</ol>
</li>
<li>
<ol start="3">
<li>遍历临时文件夹，按日期命名规则清理旧文件</li>
</ol>
</li>
<li>
<ol start="4">
<li>捕获异常，保证任务健壮性</li>
</ol>
</li>
</ul>
</li>
<li>关键代码：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 */1 * * * ?&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">delTempFile</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">tempFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">appConfig</span><span class="p">.</span><span class="na">getProjectFolder</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_FOLDER</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">FILE_FOLDER_TEMP</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">twodaysAgo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateUtil</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="n">DateUtil</span><span class="p">.</span><span class="na">getDayAgo</span><span class="p">(</span><span class="n">2</span><span class="p">),</span><span class="w"> </span><span class="s">&#34;yyyyMMdd&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">thresholdDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">twodaysAgo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">File</span><span class="w"> </span><span class="n">folder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">tempFolder</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">File</span><span class="o">[]</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">folder</span><span class="p">.</span><span class="na">listFiles</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">files</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">fileDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fileDate</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">thresholdDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">FileUtils</span><span class="p">.</span><span class="na">deleteDirectory</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;删除临时文件失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>设计要点：
<ul>
<li>文件名强制使用日期格式，防止误删</li>
<li>只处理命名合规的文件夹</li>
<li>异常捕获，保证单次失败不影响后续</li>
<li>高频检查但低负载，适合定时清理</li>
</ul>
</li>
</ul>
<h3 id="四架构设计亮点">四、架构设计亮点
</h3><ul>
<li>统计服务与业务逻辑解耦，便于维护</li>
<li>文件清理与业务模块隔离，提升安全性</li>
<li>实时数据写入Redis，定时同步DB，兼顾性能与一致性</li>
<li>新增统计维度或清理策略易于扩展</li>
</ul>
<h3 id="五潜在优化建议-1">五、潜在优化建议
</h3><ul>
<li>统计任务可分片处理，适应大用户量</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 0 1 * * ?&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">statsUserShard1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">statisticsService</span><span class="p">.</span><span class="na">processByUserRange</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">10000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>文件清理可增加文件大小监控</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MAX_TEMP_FILE_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">alertService</span><span class="p">.</span><span class="na">notifyOversizeFile</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>统计任务异常处理强化，支持延迟重试</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Scheduled</span><span class="p">(...)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">safeStatistics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">statisticsData</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;统计任务失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">retryLater</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="gateway-路由分配与接口调用机制">Gateway 路由分配与接口调用机制
</h2><h3 id="一gateway-路由分配原理">一、Gateway 路由分配原理
</h3><ul>
<li>路由匹配流程：
<ul>
<li>请求到达网关（如7071端口），Gateway遍历所有路由规则（routes），按predicates条件匹配</li>
<li>示例路由配置：</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">video</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://easylive-cloud-web </span><span class="w"> </span><span class="c"># 目标服务名（通过Nacos发现）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">Path=/web/**            </span><span class="w"> </span><span class="c"># 路径匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">StripPrefix=1           </span><span class="w"> </span><span class="c"># 去除前缀&#34;/web&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>匹配逻辑：
<ul>
<li>localhost:7071/web/test → 匹配Path=/web/** → 转发到easylive-cloud-web服务的/test接口</li>
</ul>
</li>
<li>Nacos服务发现：
<ul>
<li>easylive-cloud-web已在Nacos注册（如7072端口），网关通过lb://前缀从Nacos获取服务实例列表</li>
<li>若有多个实例，Ribbon会轮询选择目标节点</li>
</ul>
</li>
</ul>
<h3 id="二接口访问路径差异解析">二、接口访问路径差异解析
</h3><ul>
<li>访问方式与调用链路：
<ul>
<li>localhost:7072/test：直接访问easylive-cloud-web服务，绕过网关，直连服务端口</li>
<li>localhost:7071/web/test：网关路由 → easylive-cloud-web:/test，Gateway的StripPrefix=1生效</li>
</ul>
</li>
<li>关键区别：
<ul>
<li>网关路径需携带/web前缀（用于路由匹配），实际转发时会剥离</li>
<li>直连服务路径无前缀，但会暴露服务端口（不符合微服务最佳实践）</li>
</ul>
</li>
</ul>
<h3 id="三负载均衡实例演示">三、负载均衡实例演示
</h3><ul>
<li>场景准备：
<ul>
<li>启动两个easylive-cloud-web实例（端口7072和7073）</li>
<li>Nacos服务列表：</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">easylive-cloud-web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">InstanceA</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">7072</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">InstanceB</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">7073</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>请求分发过程：
<ul>
<li>连续调用localhost:7071/web/test时：
<ul>
<li>第一次请求 → 转发到InstanceA:7072/test</li>
<li>第二次请求 → 转发到InstanceB:7073/test</li>
<li>第三次请求 → 再次转到InstanceA（默认轮询策略）</li>
</ul>
</li>
</ul>
</li>
<li>底层机制：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Gateway通过Ribbon实现负载均衡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">LoadBalancerClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">LoadBalancerClient</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ServiceInstance</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="na">choose</span><span class="p">(</span><span class="s">&#34;easylive-cloud-web&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 返回的实例会轮询变化</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="四完整调用链路示例">四、完整调用链路示例
</h3><ul>
<li>请求示例：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">GET http://localhost:7071/web/api/videos/1
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>网关处理流程：
<ul>
<li>匹配路由id:video → 剥离/web前缀 → 目标路径变为/api/videos/1</li>
<li>从Nacos获取easylive-cloud-web实例地址（如127.0.0.1:7072）</li>
<li>最终转发请求：</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">GET http://127.0.0.1:7072/api/videos/1
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>- 服务响应数据通过网关原路返回
</code></pre>
<ul>
<li>总结：
<ul>
<li>网关路由：通过Path谓词匹配 + StripPrefix过滤实现路径转换</li>
<li>服务发现：依赖Nacos维护动态服务实例列表</li>
<li>负载均衡：由Ribbon自动处理多实例轮询</li>
<li>访问差异：网关路径需保留路由前缀，但实际转发时会被剥离</li>
<li>这种架构既保证了接口调用的灵活性，又隐藏了后端服务细节，符合微服务设计原则</li>
</ul>
</li>
</ul>
<h3 id="五网关工作原理">五、网关工作原理
</h3><ul>
<li>网关如同小区快递驿站，easylive-cloud-web是具体住户</li>
<li>所有请求（快递）先到驿站（网关），由驿站决定送到哪户</li>
<li>路由配置：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">7071</span><span class="w">  </span><span class="c"># 驿站门牌号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">okhttp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># 智能分拣机</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">video</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://easylive-cloud-web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">Path=/web/**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">StripPrefix=1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>工作流程：
<ul>
<li>快递员送来/web/test，驿站识别后剥离/web，送到/test</li>
<li>直接访问7072端口如同快递员绕开驿站，直送住户，不规范</li>
<li>通过网关7071端口，享受统一管理、鉴权、限流等服务</li>
</ul>
</li>
<li>负载均衡：
<ul>
<li>多个实例如同双胞胎，驿站轮流分配快递，确保均衡</li>
</ul>
</li>
<li>核心优势：
<ul>
<li>统一管理，安全可控</li>
<li>灵活扩展，实例自动识别</li>
<li>故障隔离，实例宕机自动切换</li>
</ul>
</li>
</ul>
<hr>
<h2 id="adminfilter-详细解析">AdminFilter 详细解析
</h2><h3 id="一类定义与基础结构">一、类定义与基础结构
</h3><ul>
<li>AdminFilter 是 Spring Cloud Gateway 的过滤器，用于请求到达微服务前进行权限校验（如管理员 Token 验证）</li>
<li>主要结构：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AdminFilter</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractGatewayFilterFactory</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><pre><code>- @Component：声明为 Spring Bean，由 Spring 管理
- @Slf4j：集成 Lombok，提供日志功能
- AbstractGatewayFilterFactory：自定义路由过滤逻辑的基类
</code></pre>
<h3 id="二常量定义">二、常量定义
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">URL_ACCOUNT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/account&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">URL_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/file&#34;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>URL_ACCOUNT：放行路径，访问 /account 的请求无需 Token（如登录、注册接口）</li>
<li>URL_FILE：文件相关接口从 Cookie 中提取 Token</li>
</ul>
<h3 id="三核心过滤逻辑apply方法">三、核心过滤逻辑（apply方法）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">GatewayFilter</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ServerHttpRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>apply：覆盖父类方法，返回 GatewayFilter 实例</li>
<li>exchange：封装 HTTP 请求和响应上下文</li>
<li>chain：过滤器链，chain.filter(exchange) 继续后续过滤或路由</li>
</ul>
<h4 id="1-路径判断与-token-提取">1. 路径判断与 Token 提取
</h4><ul>
<li>放行 /account 路径：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getURI</span><span class="p">().</span><span class="na">getRawPath</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">URL_ACCOUNT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">exchange</span><span class="p">);</span><span class="w"> </span><span class="c1">// 直接放行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>文件接口从 Cookie 取 Token：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getURI</span><span class="p">().</span><span class="na">getRawPath</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">URL_FILE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getTokenFromCookie</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>默认从 Header 取 Token：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getToken</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-token-校验">2. Token 校验
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringTools</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">token</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_901</span><span class="p">);</span><span class="w"> </span><span class="c1">// 无权限</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Token 为空抛出业务异常（如 CODE_901 表示未登录/Token 无效）</li>
<li>Token 有效则继续后续逻辑</li>
</ul>
<h3 id="四token-提取方法">四、Token 提取方法
</h3><ul>
<li>从 Header 获取：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getToken</span><span class="p">(</span><span class="n">ServerHttpRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">().</span><span class="na">getFirst</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_ADMIN</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>从 Cookie 获取：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getTokenFromCookie</span><span class="p">(</span><span class="n">ServerHttpRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getCookies</span><span class="p">().</span><span class="na">getFirst</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">TOKEN_ADMIN</span><span class="p">).</span><span class="na">getValue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="五设计思想与使用场景">五、设计思想与使用场景
</h3><ul>
<li>职责分离：权限校验逻辑集中在网关层，避免每个微服务重复实现</li>
<li>灵活提取 Token：支持 Header 和 Cookie 两种方式，适配 API 调用和浏览器文件下载</li>
<li>白名单路径：/account 路径免校验，确保登录/注册接口可访问</li>
<li>异常处理：直接抛出业务异常，由网关统一转换为 HTTP 响应（如 401 Unauthorized）</li>
</ul>
<h4 id="典型使用场景">典型使用场景
</h4><ul>
<li>管理员访问用户列表：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">GET</span> <span class="nn">/admin/users</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">X-Admin-Token</span><span class="o">:</span> <span class="l">valid_token_here</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>- 网关检查路径不匹配 /account 或 /file，从 Header 提取 Token，校验通过转发
</code></pre>
<ul>
<li>用户下载文件：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">GET</span> <span class="nn">/file/download/1</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">ADMIN_TOKEN=valid_token_here</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>- 网关识别路径包含 /file，从 Cookie 提取 Token，校验通过转发
</code></pre>
<ul>
<li>未携带 Token 的请求：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">GET</span> <span class="nn">/admin/users</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>- 抛出 CODE_901 异常，返回 401 Unauthorized
</code></pre>
<hr>
<h2 id="使用seata解决分布式事务问题">使用Seata解决分布式事务问题
</h2><h3 id="一为什么transactional在跨服务调用时不生效">一、为什么@Transactional在跨服务调用时不生效
</h3><ul>
<li>@Transactional 只能管理当前服务的数据库连接，无法控制远程服务的事务</li>
<li>典型场景：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 本地数据库操作（可被@Transactional管理）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoCommentMapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">comment</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 跨服务调用（不受@Transactional控制）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">videoClient</span><span class="p">.</span><span class="na">updateCountInfo</span><span class="p">(</span><span class="n">comment</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">(),</span><span class="w"> </span><span class="p">...);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>问题根源：
<ul>
<li>事务隔离性：@Transactional 仅作用于本地数据库连接</li>
<li>跨服务调用（如HTTP/Feign）属于独立事务，无法自动回滚</li>
<li>两阶段问题：本地insert成功后，远程调用失败时本地无法回滚</li>
<li>CAP理论：跨服务操作涉及网络分区，传统事务无法保证CP</li>
</ul>
</li>
<li>生活化比喻：
<ul>
<li>商家（服务A）确认发货（本地事务提交）</li>
<li>快递（服务B）丢件（远程调用失败）</li>
<li>没有平台（Seata）协调时，钱货两失</li>
</ul>
</li>
</ul>
<h3 id="二seata解决方案全流程">二、Seata解决方案全流程
</h3><ul>
<li>第一步：启动Seata服务
<ul>
<li>下载Seata Server（1.6.1+）</li>
<li>配置注册中心（如Nacos）：</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">registry {
</span></span><span class="line"><span class="cl">  type = &#34;nacos&#34;
</span></span><span class="line"><span class="cl">  nacos {
</span></span><span class="line"><span class="cl">    serverAddr = &#34;127.0.0.1:8848&#34;
</span></span><span class="line"><span class="cl">    namespace = &#34;你的命名空间&#34; # 可选
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>- 启动命令：bin/seata-server.sh -p 8091 -h 127.0.0.1
</code></pre>
<ul>
<li>第二步：数据库准备
<ul>
<li>每个业务库执行undo_log表建表SQL：</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">undo_log</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">branch_id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">context</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">rollback_info</span><span class="o">`</span><span class="w"> </span><span class="n">longblob</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">log_status</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">log_created</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">log_modified</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">ux_undo_log</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">branch_id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><pre><code>- Seata Server独立库需建global_table、branch_table、lock_table等
</code></pre>
<ul>
<li>第三步：项目配置
<ul>
<li>添加依赖：</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-seata<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;version&gt;</span>2.2.6.RELEASE<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><pre><code>- Nacos配置示例：
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alibaba</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">seata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tx-service-group</span><span class="p">:</span><span class="w"> </span><span class="l">video-service-group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">seata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">registry</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">nacos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">8848</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">nacos</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>第四步：代码改造
<ul>
<li>在业务方法上添加@GlobalTransactional</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GlobalTransactional</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rollbackFor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w">  </span><span class="c1">// 所有异常都回滚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">timeoutMills</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">60000</span><span class="p">,</span><span class="w">           </span><span class="c1">// 超时时间（毫秒）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;postCommentTx&#34;</span><span class="w">         </span><span class="c1">// 全局事务名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postComment</span><span class="p">(</span><span class="n">VideoComment</span><span class="w"> </span><span class="n">comment</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">replyCommentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 原业务逻辑不变</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Seata会自动拦截以下操作：</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. videoCommentMapper.insert()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. videoClient.updateCountInfo()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>关键机制：
<ul>
<li>事务ID传播：Seata通过XID（全局事务ID）串联各服务，自动通过Feign请求头传递seata_xid</li>
<li>二阶段提交：
<ul>
<li>第一阶段：Prepare</li>
<li>第二阶段：Commit/Rollback</li>
</ul>
</li>
<li>回滚原理：undo_log表记录回滚日志，失败时自动补偿</li>
</ul>
</li>
</ul>
<h3 id="三验证与排查技巧">三、验证与排查技巧
</h3><ul>
<li>查看Seata控制台（如http://127.0.0.1:7091），检查事务列表</li>
<li>强制触发异常，观察本地表是否回滚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 在updateCountInfo()中模拟失败</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">random</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">.</span><span class="na">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;模拟远程调用失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>常见问题：
<ul>
<li>No available service for cluster：事务组名不匹配，检查tx-service-group一致性</li>
<li>Could not register branch：数据库未建undo_log，需执行建表SQL</li>
<li>回滚失效：方法内捕获异常，需确保异常抛出到@GlobalTransactional层</li>
</ul>
</li>
</ul>
<h3 id="四生活化总结">四、生活化总结
</h3><ul>
<li>Seata就像跨国贸易的支付宝：
<ul>
<li>买家付款（本地事务）→ 资金暂存平台（Phase1）</li>
<li>卖家发货（远程调用）→ 平台监控物流（Phase1）</li>
<li>确认收货后双方结算（Phase2 Commit）</li>
<li>卖家不发货，平台退款（Phase2 Rollback）</li>
</ul>
</li>
<li>通过Seata，postComment方法实现全自动保险，评论数据和计数更新要么全部成功，要么全部回滚</li>
</ul>
<h3 id="五典型代码示例">五、典型代码示例
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@GlobalTransactional</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;postCommentTx&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">rollbackFor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postComment</span><span class="p">(</span><span class="n">VideoComment</span><span class="w"> </span><span class="n">comment</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">replyCommentId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. 获取视频信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">VideoInfo</span><span class="w"> </span><span class="n">videoInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoClient</span><span class="p">.</span><span class="na">getVideoInfoByVideoId</span><span class="p">(</span><span class="n">comment</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">videoInfo</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_600</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. 检查评论是否关闭</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getInteraction</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getInteraction</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">ZERO</span><span class="p">.</span><span class="na">toString</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="s">&#34;UP主已关闭评论区&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. 处理回复评论逻辑</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replyCommentId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">VideoComment</span><span class="w"> </span><span class="n">replyComment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getVideoCommentByCommentId</span><span class="p">(</span><span class="n">replyCommentId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replyComment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">replyComment</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">comment</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">ResponseCodeEnum</span><span class="p">.</span><span class="na">CODE_600</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replyComment</span><span class="p">.</span><span class="na">getpCommentId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">comment</span><span class="p">.</span><span class="na">setpCommentId</span><span class="p">(</span><span class="n">replyComment</span><span class="p">.</span><span class="na">getCommentId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">comment</span><span class="p">.</span><span class="na">setpCommentId</span><span class="p">(</span><span class="n">replyComment</span><span class="p">.</span><span class="na">getpCommentId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">comment</span><span class="p">.</span><span class="na">setReplyUserId</span><span class="p">(</span><span class="n">replyComment</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">UserInfo</span><span class="w"> </span><span class="n">userInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoClient</span><span class="p">.</span><span class="na">getUserInfoByUserId</span><span class="p">(</span><span class="n">replyComment</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">comment</span><span class="p">.</span><span class="na">setReplyNickName</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">comment</span><span class="p">.</span><span class="na">setReplyAvatar</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getAvatar</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">comment</span><span class="p">.</span><span class="na">setpCommentId</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 4. 设置评论信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">comment</span><span class="p">.</span><span class="na">setPostTime</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">comment</span><span class="p">.</span><span class="na">setVideoUserId</span><span class="p">(</span><span class="n">videoInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 5. 插入评论</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">videoCommentMapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">comment</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 6. 更新评论计数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comment</span><span class="p">.</span><span class="na">getpCommentId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">videoClient</span><span class="p">.</span><span class="na">updateCountInfo</span><span class="p">(</span><span class="n">comment</span><span class="p">.</span><span class="na">getVideoId</span><span class="p">(),</span><span class="w"> </span><span class="n">UserActionTypeEnum</span><span class="p">.</span><span class="na">VIDEO_COMMENT</span><span class="p">.</span><span class="na">getField</span><span class="p">(),</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>&lt;/rewritten_file&gt;</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 P
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1ad0100d5d3b17f1840a489e493b72e1cbd903545e8f7eee7baa7ba311518c49.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
